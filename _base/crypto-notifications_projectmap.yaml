# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# CRYPTO-NOTIFICATIONS - PROJECT MAP
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Sistema de notificaÃ§Ãµes multi-canal para plataforma de trading
# Linguagem: Rust
# VersÃ£o: 1.0.0
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ 1. OVERVIEW DO PROJETO                                      â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

project:
  name: crypto-notifications
  description: |
    ServiÃ§o responsÃ¡vel por receber eventos do sistema de trading e 
    distribuir notificaÃ§Ãµes formatadas atravÃ©s de mÃºltiplos canais 
    (Telegram, Discord, Email, Webhooks).
    
    CaracterÃ­sticas principais:
    - Multi-canal com suporte a fallback
    - FormataÃ§Ã£o rica e contextual
    - PriorizaÃ§Ã£o inteligente de mensagens
    - Rate limiting e throttling
    - Agrupamento de mensagens para evitar spam
    - Retry automÃ¡tico com exponential backoff
    - Suporte a templates customizÃ¡veis
    - MÃ©tricas e observabilidade

  language: Rust
  async_runtime: tokio
  message_broker: Kafka (rdkafka)
  
  responsibilities:
    - Consumir eventos dos tÃ³picos Kafka
    - Formatar mensagens de acordo com categoria e canal
    - Enviar notificaÃ§Ãµes via mÃºltiplos canais
    - Gerenciar rate limits por canal e usuÃ¡rio
    - Agrupar notificaÃ§Ãµes relacionadas
    - Realizar retry em caso de falha
    - Registrar histÃ³rico de notificaÃ§Ãµes
    - Prover mÃ©tricas de entrega


# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ 2. ARQUITETURA                                               â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

architecture:
  pattern: Event-Driven + Hexagonal Architecture + Plugin System
  
  components:
    consumer:
      description: Consome eventos do Kafka
      technology: rdkafka (librdkafka wrapper)
      concurrency: Multi-threaded tokio tasks
      
    router:
      description: Roteia mensagens para canais apropriados
      logic: |
        - LÃª preferÃªncias do usuÃ¡rio
        - Aplica regras de priorizaÃ§Ã£o
        - Seleciona canais baseado em categoria e urgÃªncia
        
    formatters:
      description: Formata mensagens por canal
      types:
        - TelegramFormatter (Markdown)
        - DiscordFormatter (Embeds)
        - EmailFormatter (HTML)
        - WebhookFormatter (JSON)
        
    channels:
      description: Plugins de envio (trait-based)
      interface: NotificationChannel trait
      implementations:
        - TelegramChannel
        - DiscordChannel
        - EmailChannel
        - WebhookChannel
        
    throttler:
      description: Rate limiting e agrupamento
      strategy: Token bucket + message batching
      storage: Redis (para estado distribuÃ­do)
      
    retry_manager:
      description: Gerencia retentativas
      strategy: Exponential backoff com jitter
      max_attempts: 3
      
    metrics:
      description: Coleta mÃ©tricas
      technology: Prometheus (rust-prometheus)
      
  data_flow: |
    Kafka Topic â†’ Consumer â†’ Router â†’ Formatter â†’ Channel â†’ External API
                                â†“
                            Throttler
                                â†“
                          Retry Manager
                                â†“
                            Metrics


# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ 3. TÃ“PICOS KAFKA                                             â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

kafka_topics:
  consumed:
    - name: notifications.send
      description: TÃ³pico principal de notificaÃ§Ãµes
      producers:
        - crypto-management
        - crypto-trader
        - crypto-signals
        - crypto-webhook
      consumer_group: crypto-notifications-group
      partitions: 3
      replication_factor: 2
      
      schema:
        channel:
          type: string
          enum: [telegram, discord, email, webhook, all]
          description: Canal de destino
          
        priority:
          type: string
          enum: [critical, high, normal, low]
          description: Prioridade da notificaÃ§Ã£o
          
        category:
          type: string
          enum: [order, position, signal, alert, report, system]
          description: Categoria do evento
          
        title:
          type: string
          description: TÃ­tulo da notificaÃ§Ã£o
          
        message:
          type: string
          description: Mensagem principal
          
        data:
          type: object
          description: Dados estruturados para formataÃ§Ã£o
          
        user_id:
          type: string
          optional: true
          description: ID do usuÃ¡rio (para preferÃªncias)
          
        timestamp:
          type: string
          format: ISO8601
          
      example_payload: |
        {
          "channel": "telegram",
          "priority": "high",
          "category": "position",
          "title": "Position Opened",
          "message": "LONG position opened on BTCUSDT",
          "data": {
            "symbol": "BTCUSDT",
            "side": "LONG",
            "quantity": 0.01,
            "entry_price": 45000.00,
            "strategy": "RSI_DIVERGENCE"
          },
          "user_id": "user_123",
          "timestamp": "2025-10-16T22:00:00Z"
        }

  produced:
    - name: notifications.delivered
      description: ConfirmaÃ§Ã£o de entrega
      schema:
        notification_id: string
        channel: string
        status: enum [delivered, failed, throttled]
        delivered_at: string
        error: optional string
        
    - name: notifications.failed
      description: Falhas apÃ³s todas as tentativas
      schema:
        notification_id: string
        channel: string
        attempts: integer
        last_error: string
        original_payload: object


# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ 4. MAPA DE PASTAS                                            â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

project_structure:
  description: Estrutura completa do projeto com descriÃ§Ã£o de cada mÃ³dulo
  architecture_layers: |
    Presentation â†’ Application â†’ Domain
                       â†“
                Infrastructure
    
    - Domain: nÃ£o depende de ninguÃ©m (nÃºcleo puro)
    - Application: depende apenas de Domain
    - Infrastructure: implementa contratos de Application
    - Presentation: usa Application e injeta Infrastructure via DI
    
  structure: |
    crypto-notifications/
    â”œâ”€â”€ src/
    â”‚   â”œâ”€â”€ main.rs                          # Entry point: bootstrap do app (config, DB, consumer, channels, HTTP server)
    â”‚   â”œâ”€â”€ lib.rs                           # Biblioteca pÃºblica expondo mÃ³dulos principais
    â”‚   â”‚
    â”‚   â”œâ”€â”€ domain/                          # â­ Camada de DomÃ­nio (regras de negÃ³cio puras, sem I/O)
    â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â”œâ”€â”€ errors.rs                    # Erros de domÃ­nio (validaÃ§Ã£o, regras de negÃ³cio)
    â”‚   â”‚   â”œâ”€â”€ aggregates/                  # Agregados DDD (NotificationAggregate, UserPreferencesAggregate)
    â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â”‚   â”œâ”€â”€ notification.rs          # Agregado de notificaÃ§Ã£o (valida, aplica regras)
    â”‚   â”‚   â”‚   â””â”€â”€ user_preferences.rs      # Agregado de preferÃªncias (canais, filtros)
    â”‚   â”‚   â”œâ”€â”€ entities/                    # Entidades de domÃ­nio
    â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â”‚   â”œâ”€â”€ notification.rs          # Entidade Notification
    â”‚   â”‚   â”‚   â””â”€â”€ delivery_attempt.rs      # Entidade DeliveryAttempt (retry history)
    â”‚   â”‚   â”œâ”€â”€ events/                      # Domain events (NotificationReceived, NotificationSent, etc.)
    â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â”‚   â”œâ”€â”€ notification_events.rs   # NotificationReceived, NotificationSent, NotificationFailed
    â”‚   â”‚   â”‚   â””â”€â”€ preferences_events.rs    # PreferencesUpdated, ChannelEnabled, etc.
    â”‚   â”‚   â”œâ”€â”€ repositories/                # Traits de repositÃ³rios (contratos)
    â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â”‚   â”œâ”€â”€ notification_repository.rs    # Contrato para persistir notificaÃ§Ãµes
    â”‚   â”‚   â”‚   â””â”€â”€ preferences_repository.rs     # Contrato para preferÃªncias de usuÃ¡rio
    â”‚   â”‚   â”œâ”€â”€ services/                    # ServiÃ§os de domÃ­nio (lÃ³gica que nÃ£o pertence a um agregado)
    â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â”‚   â”œâ”€â”€ priority_resolver.rs     # Resolve prioridade baseado em regras de negÃ³cio
    â”‚   â”‚   â”‚   â””â”€â”€ throttling_policy.rs     # PolÃ­ticas de throttling por categoria/canal
    â”‚   â”‚   â””â”€â”€ value_objects/               # Value objects (Channel, Priority, Category, etc.)
    â”‚   â”‚       â”œâ”€â”€ mod.rs
    â”‚   â”‚       â”œâ”€â”€ channel.rs               # VO Channel (telegram, discord, email, webhook)
    â”‚   â”‚       â”œâ”€â”€ priority.rs              # VO Priority (critical, high, normal, low)
    â”‚   â”‚       â”œâ”€â”€ category.rs              # VO Category (order, position, signal, alert, etc.)
    â”‚   â”‚       â””â”€â”€ notification_id.rs       # VO NotificationId (UUID wrapper)
    â”‚   â”‚
    â”‚   â”œâ”€â”€ application/                     # â­ Camada de AplicaÃ§Ã£o (casos de uso, orquestraÃ§Ã£o)
    â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â”œâ”€â”€ dtos/                        # Data Transfer Objects
    â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â”‚   â”œâ”€â”€ commands.rs              # Command DTOs (SendNotificationCommand, UpdatePreferencesCommand)
    â”‚   â”‚   â”‚   â”œâ”€â”€ notification_dto.rs      # DTO para transferir dados de notificaÃ§Ã£o
    â”‚   â”‚   â”‚   â”œâ”€â”€ requests.rs              # HTTP request DTOs
    â”‚   â”‚   â”‚   â””â”€â”€ responses.rs             # HTTP response DTOs (ApiResponse, ErrorResponse)
    â”‚   â”‚   â”œâ”€â”€ ports/                       # âš¡ Ports (interfaces/contratos para adapters)
    â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â”‚   â”œâ”€â”€ event_consumer_port.rs   # Contrato para consumir eventos Kafka
    â”‚   â”‚   â”‚   â”œâ”€â”€ notification_channel_port.rs  # Contrato para canais de notificaÃ§Ã£o
    â”‚   â”‚   â”‚   â”œâ”€â”€ formatter_port.rs        # Contrato para formatadores
    â”‚   â”‚   â”‚   â”œâ”€â”€ throttler_port.rs        # Contrato para rate limiting/throttling
    â”‚   â”‚   â”‚   â”œâ”€â”€ retry_manager_port.rs    # Contrato para gerenciamento de retry
    â”‚   â”‚   â”‚   â”œâ”€â”€ notification_store_port.rs    # Contrato para persistir histÃ³rico
    â”‚   â”‚   â”‚   â””â”€â”€ event_publisher_port.rs  # Contrato para publicar eventos (delivered, failed)
    â”‚   â”‚   â”œâ”€â”€ queries/                     # Queries (CQRS read-side)
    â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â”‚   â”œâ”€â”€ get_notification_history.rs   # Query: histÃ³rico de notificaÃ§Ãµes
    â”‚   â”‚   â”‚   â””â”€â”€ get_user_preferences.rs       # Query: preferÃªncias do usuÃ¡rio
    â”‚   â”‚   â””â”€â”€ services/                    # Application services (orquestraÃ§Ã£o de casos de uso)
    â”‚   â”‚       â”œâ”€â”€ mod.rs
    â”‚   â”‚       â”œâ”€â”€ notification_service.rs  # Caso de uso: processar e enviar notificaÃ§Ã£o
    â”‚   â”‚       â”œâ”€â”€ preferences_service.rs   # Caso de uso: gerenciar preferÃªncias
    â”‚   â”‚       â””â”€â”€ delivery_orchestrator.rs # Orquestra: routing â†’ formatting â†’ throttling â†’ sending â†’ retry
    â”‚   â”‚
    â”‚   â”œâ”€â”€ infrastructure/                  # â­ Camada de Infraestrutura (implementaÃ§Ãµes tÃ©cnicas)
    â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â”œâ”€â”€ bootstrap/                   # InicializaÃ§Ã£o de componentes
    â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â”‚   â”œâ”€â”€ database.rs              # Setup de conexÃ£o Postgres + migrations (se usar)
    â”‚   â”‚   â”‚   â”œâ”€â”€ redis.rs                 # Setup conexÃ£o Redis (throttling)
    â”‚   â”‚   â”‚   â”œâ”€â”€ kafka_consumer.rs        # Inicializa consumer Kafka
    â”‚   â”‚   â”‚   â”œâ”€â”€ channels.rs              # Inicializa canais (Telegram, Discord, etc.)
    â”‚   â”‚   â”‚   â””â”€â”€ formatters.rs            # Inicializa formatadores
    â”‚   â”‚   â”œâ”€â”€ config/                      # ConfiguraÃ§Ã£o e settings
    â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â”‚   â””â”€â”€ settings.rs              # Struct Settings + carregamento de env vars
    â”‚   â”‚   â”œâ”€â”€ messaging/                   # Messaging & Event Streaming
    â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â”‚   â”œâ”€â”€ kafka_consumer.rs        # Consumer Kafka (rdkafka)
    â”‚   â”‚   â”‚   â”œâ”€â”€ kafka_event_publisher.rs # Publisher de eventos (delivered, failed)
    â”‚   â”‚   â”‚   â””â”€â”€ message_handler.rs       # Handler que processa mensagens do Kafka
    â”‚   â”‚   â”œâ”€â”€ channels/                    # ImplementaÃ§Ãµes de canais (Adapters)
    â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â”‚   â”œâ”€â”€ telegram_channel.rs      # Implementa NotificationChannelPort via teloxide
    â”‚   â”‚   â”‚   â”œâ”€â”€ discord_channel.rs       # Implementa NotificationChannelPort via serenity/webhook
    â”‚   â”‚   â”‚   â”œâ”€â”€ email_channel.rs         # Implementa NotificationChannelPort via lettre (SMTP)
    â”‚   â”‚   â”‚   â””â”€â”€ webhook_channel.rs       # Implementa NotificationChannelPort via reqwest (HTTP)
    â”‚   â”‚   â”œâ”€â”€ formatters/                  # ImplementaÃ§Ãµes de formatadores (Adapters)
    â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â”‚   â”œâ”€â”€ telegram_formatter.rs    # Formata Markdown para Telegram
    â”‚   â”‚   â”‚   â”œâ”€â”€ discord_formatter.rs     # Formata Embeds para Discord
    â”‚   â”‚   â”‚   â”œâ”€â”€ email_formatter.rs       # Formata HTML para Email
    â”‚   â”‚   â”‚   â”œâ”€â”€ webhook_formatter.rs     # Formata JSON para Webhooks
    â”‚   â”‚   â”‚   â””â”€â”€ template_engine.rs       # Engine de templates (Handlebars)
    â”‚   â”‚   â”œâ”€â”€ throttling/                  # Rate limiting e batching
    â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â”‚   â”œâ”€â”€ token_bucket_limiter.rs  # Implementa ThrottlerPort via Token Bucket + Redis
    â”‚   â”‚   â”‚   â”œâ”€â”€ message_batcher.rs       # Agrupa mensagens em batches (time-window)
    â”‚   â”‚   â”‚   â””â”€â”€ redis_state_store.rs     # Armazena estado de throttling no Redis
    â”‚   â”‚   â”œâ”€â”€ retry/                       # Retry e error handling
    â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â”‚   â”œâ”€â”€ exponential_backoff.rs   # Implementa RetryManagerPort com exp. backoff
    â”‚   â”‚   â”‚   â””â”€â”€ retry_state_store.rs     # Armazena estado de retry (tentativas, delays)
    â”‚   â”‚   â”œâ”€â”€ persistence/                 # PersistÃªncia (Postgres, se necessÃ¡rio)
    â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â”‚   â”œâ”€â”€ postgres_notification_store.rs    # Store de histÃ³rico de notificaÃ§Ãµes
    â”‚   â”‚   â”‚   â””â”€â”€ postgres_preferences_store.rs     # Store de preferÃªncias de usuÃ¡rio
    â”‚   â”‚   â”œâ”€â”€ metrics/                     # MÃ©tricas e observabilidade
    â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â”‚   â””â”€â”€ prometheus_metrics.rs    # Registra mÃ©tricas Prometheus
    â”‚   â”‚   â”œâ”€â”€ shutdown/                    # Shutdown graceful
    â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â”‚   â”œâ”€â”€ graceful.rs              # Coordena shutdown (flush, fecha conexÃµes)
    â”‚   â”‚   â”‚   â””â”€â”€ signal_handler.rs        # Captura sinais SIGTERM/SIGINT
    â”‚   â”‚   â””â”€â”€ startup/                     # Startup do aplicativo
    â”‚   â”‚       â”œâ”€â”€ mod.rs
    â”‚   â”‚       â”œâ”€â”€ banner.rs                # Banner ASCII no console
    â”‚   â”‚       â”œâ”€â”€ health.rs                # Health checks
    â”‚   â”‚       â””â”€â”€ logging.rs               # Setup de logs (tracing-subscriber)
    â”‚   â”‚
    â”‚   â”œâ”€â”€ presentation/                    # â­ Camada de ApresentaÃ§Ã£o (HTTP, CLI futuro)
    â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â””â”€â”€ http/                        # HTTP REST API (Axum)
    â”‚   â”‚       â”œâ”€â”€ mod.rs
    â”‚   â”‚       â”œâ”€â”€ router.rs                # DefiniÃ§Ã£o de rotas (endpoints)
    â”‚   â”‚       â”œâ”€â”€ responses.rs             # Helpers de resposta (ApiResponse, ErrorResponse)
    â”‚   â”‚       â”œâ”€â”€ controllers/             # Controllers HTTP
    â”‚   â”‚       â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚       â”‚   â”œâ”€â”€ notification_controller.rs    # Endpoints de notificaÃ§Ã£o
    â”‚   â”‚       â”‚   â”œâ”€â”€ preferences_controller.rs     # Endpoints de preferÃªncias
    â”‚   â”‚       â”‚   â””â”€â”€ health_controller.rs          # Health checks, metrics
    â”‚   â”‚       â””â”€â”€ middleware/              # Middlewares HTTP (logging, auth futuro)
    â”‚   â”‚           â”œâ”€â”€ mod.rs
    â”‚   â”‚           â””â”€â”€ request_logger.rs    # Log de requests HTTP
    â”‚   â”‚
    â”‚   â””â”€â”€ shared/                          # â­ Shared Kernel (cÃ³digo transversal)
    â”‚       â”œâ”€â”€ mod.rs
    â”‚       â”œâ”€â”€ errors.rs                    # Erros compartilhados (ApplicationError, InfrastructureError)
    â”‚       â”œâ”€â”€ types.rs                     # Tipos compartilhados (EventEnvelope, Timestamp, etc.)
    â”‚       â”œâ”€â”€ traits/                      # Traits comuns
    â”‚       â”‚   â”œâ”€â”€ mod.rs
    â”‚       â”‚   â””â”€â”€ aggregate_root.rs        # Trait AggregateRoot (apply_event, uncommitted_events)
    â”‚       â””â”€â”€ utils/                       # UtilitÃ¡rios
    â”‚           â”œâ”€â”€ mod.rs
    â”‚           â”œâ”€â”€ datetime.rs              # Helpers de data/hora
    â”‚           â”œâ”€â”€ validation.rs            # ValidaÃ§Ãµes genÃ©ricas
    â”‚           â””â”€â”€ emoji_helper.rs          # Helper de emojis para formataÃ§Ã£o
    â”‚
    â”œâ”€â”€ config/                              # ğŸ“ ConfiguraÃ§Ãµes externas
    â”‚   â”œâ”€â”€ development.yaml                 # Config para ambiente dev
    â”‚   â”œâ”€â”€ production.yaml                  # Config para ambiente prod
    â”‚   â””â”€â”€ templates/                       # Templates de mensagens
    â”‚       â”œâ”€â”€ telegram/
    â”‚       â”‚   â”œâ”€â”€ order_filled.hbs         # Template Telegram: ordem executada
    â”‚       â”‚   â”œâ”€â”€ position_opened.hbs      # Template Telegram: posiÃ§Ã£o aberta
    â”‚       â”‚   â”œâ”€â”€ position_closed.hbs      # Template Telegram: posiÃ§Ã£o fechada
    â”‚       â”‚   â””â”€â”€ signal_generated.hbs     # Template Telegram: sinal gerado
    â”‚       â”œâ”€â”€ discord/
    â”‚       â”‚   â”œâ”€â”€ order_filled.json        # Template Discord embed: ordem
    â”‚       â”‚   â””â”€â”€ position_opened.json     # Template Discord embed: posiÃ§Ã£o
    â”‚       â””â”€â”€ email/
    â”‚           â”œâ”€â”€ order_filled.html        # Template Email HTML: ordem
    â”‚           â””â”€â”€ position_opened.html     # Template Email HTML: posiÃ§Ã£o
    â”‚
    â”œâ”€â”€ migrations/                          # ğŸ“Š MigraÃ§Ãµes de banco (se usar Postgres)
    â”‚   â”œâ”€â”€ V001__initial_schema.sql         # Schema inicial (notifications, users)
    â”‚   â”œâ”€â”€ V002__user_preferences.sql       # Tabela de preferÃªncias
    â”‚   â””â”€â”€ V003__delivery_history.sql       # HistÃ³rico de entregas
    â”‚
    â”œâ”€â”€ docs/                                # ğŸ“š DocumentaÃ§Ã£o tÃ©cnica
    â”‚   â”œâ”€â”€ README.md                        # Ãndice de documentaÃ§Ã£o
    â”‚   â”œâ”€â”€ ARCHITECTURE.md                  # Detalhes da arquitetura hexagonal
    â”‚   â””â”€â”€ CHANNELS.md                      # DocumentaÃ§Ã£o de cada canal
    â”‚
    â”œâ”€â”€ Cargo.toml                           # ConfiguraÃ§Ã£o Rust (deps, features)
    â”œâ”€â”€ Cargo.lock                           # Lock file de dependÃªncias
    â”œâ”€â”€ Dockerfile                           # Build multi-stage production
    â”œâ”€â”€ docker-compose.yml                   # Stack completa (app, Kafka, Redis, Postgres)
    â”œâ”€â”€ Makefile                             # Comandos make (build, test, docker)
    â”œâ”€â”€ crypto-notifications_projectmap.yaml # Este arquivo (documentaÃ§Ã£o estruturada)
    â””â”€â”€ README.md                            # DocumentaÃ§Ã£o principal do projeto
    
  conventions:
    domain_layer:
      description: Camada de DomÃ­nio (domain/)
      rules:
        - âœ… Sem dependÃªncias de infraestrutura
        - âœ… LÃ³gica de negÃ³cio pura
        - âœ… Aggregates aplicam eventos e validam invariantes
        - âœ… Value objects imutÃ¡veis
        - âœ… Repositories como traits (contratos apenas)
        
    application_layer:
      description: Camada de AplicaÃ§Ã£o (application/)
      rules:
        - âœ… Define Ports (interfaces) que infraestrutura implementa
        - âœ… Orquestra casos de uso
        - âœ… DTOs para comunicaÃ§Ã£o entre camadas
        - âœ… Queries para read-side (CQRS)
        - âœ… Services orquestram mÃºltiplos agregados/ports
        
    infrastructure_layer:
      description: Camada de Infraestrutura (infrastructure/)
      rules:
        - âœ… Implementa Adapters (Telegram, Discord, Kafka, Redis, Postgres)
        - âœ… Bootstrap e configuraÃ§Ã£o
        - âœ… Messaging e streaming
        - âœ… Persistence (Postgres)
        - âœ… Shutdown graceful
        - âœ… Startup e health checks
        
    presentation_layer:
      description: Camada de ApresentaÃ§Ã£o (presentation/)
      rules:
        - âœ… HTTP REST API (Axum)
        - âœ… Controllers e routers
        - âœ… ConversÃ£o DTOs <-> JSON
        - âœ… Middlewares (logging, auth futuro)
        - âœ… NÃ£o contÃ©m lÃ³gica de negÃ³cio
        
    shared_kernel:
      description: Shared Kernel (shared/)
      rules:
        - âœ… CÃ³digo compartilhado entre camadas
        - âœ… Traits comuns (AggregateRoot)
        - âœ… Tipos transversais (EventEnvelope)
        - âœ… UtilitÃ¡rios (datetime, validaÃ§Ã£o)
        - âœ… Erros compartilhados


# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ 5. CANAIS DE NOTIFICAÃ‡ÃƒO                                     â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

notification_channels:
  telegram:
    priority: 1
    technology: teloxide / telegram-bot-api
    features:
      - Markdown/HTML formatting
      - Inline buttons
      - Message editing
      - File attachments
    rate_limits:
      - 30 messages/second per bot
      - 20 messages/minute per chat
    config_required:
      - TELEGRAM_BOT_TOKEN
      - TELEGRAM_CHAT_ID (default, pode ser por usuÃ¡rio)
    retry_strategy: exponential_backoff
    
  discord:
    priority: 2
    technology: serenity / discord webhooks
    features:
      - Rich embeds
      - Color coding
      - Thumbnail/images
      - Fields
    rate_limits:
      - 5 requests/second per webhook
      - 30 requests/minute per webhook
    config_required:
      - DISCORD_WEBHOOK_URL
    retry_strategy: exponential_backoff
    
  email:
    priority: 3
    technology: lettre (SMTP)
    features:
      - HTML templates
      - Attachments
      - CC/BCC
    rate_limits:
      - Provider dependent (configurÃ¡vel)
    config_required:
      - SMTP_HOST
      - SMTP_PORT
      - SMTP_USERNAME
      - SMTP_PASSWORD
      - SMTP_FROM_EMAIL
    retry_strategy: exponential_backoff
    
  webhook:
    priority: 4
    technology: reqwest (HTTP client)
    features:
      - Custom JSON payloads
      - Custom headers
      - Signature verification (HMAC)
    rate_limits:
      - ConfigurÃ¡vel por endpoint
    config_required:
      - WEBHOOK_URL
      - WEBHOOK_SECRET (optional, para HMAC)
    retry_strategy: exponential_backoff


# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ 6. FORMATAÃ‡ÃƒO DE MENSAGENS                                   â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

message_formatting:
  templates_engine: handlebars-rust
  
  categories:
    order:
      emoji: "ğŸ’°"
      telegram_format: |
        {{emoji}} *{{event_type}}*
        â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        Asset: `{{symbol}}`
        Side: {{side}} {{side_emoji}}
        Type: {{order_type}}
        Quantity: {{quantity}}
        Price: ${{price}}
        {{#if filled_quantity}}
        Filled: {{filled_quantity}}/{{quantity}}
        {{/if}}
        â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        â° {{timestamp}}
        
      discord_format:
        embed:
          title: "{{event_type}}"
          color: "{{color}}"  # green for buy, red for sell
          fields:
            - name: Asset
              value: "{{symbol}}"
              inline: true
            - name: Side
              value: "{{side}}"
              inline: true
            - name: Price
              value: "${{price}}"
              inline: true
          footer:
            text: "{{timestamp}}"
            
    position:
      emoji_opened: "ğŸŸ¢"
      emoji_closed: "ğŸ”´"
      telegram_format_opened: |
        ğŸŸ¢ *POSITION OPENED*
        â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        Asset: `{{symbol}}`
        Side: {{side}} {{side_emoji}}
        Quantity: {{quantity}}
        Entry: ${{entry_price}}
        {{#if strategy}}
        Strategy: {{strategy}}
        {{/if}}
        â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        â° {{timestamp}}
        
      telegram_format_closed: |
        ğŸ”´ *POSITION CLOSED*
        â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        Asset: `{{symbol}}`
        P&L: {{pnl_emoji}} ${{pnl}} ({{pnl_percent}}%)
        Duration: {{duration}}
        Exit: ${{exit_price}}
        {{#if reason}}
        Reason: {{reason}}
        {{/if}}
        â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        â° {{timestamp}}
        
    signal:
      emoji: "ğŸ“Š"
      telegram_format: |
        ğŸ“Š *TRADING SIGNAL*
        â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        Asset: `{{symbol}}`
        Action: {{action}} {{action_emoji}}
        Strategy: {{strategy}}
        Confidence: {{confidence}}%
        {{#if source}}
        Source: {{source}}
        {{/if}}
        â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        Price: ${{price}}
        {{#if stop_loss}}
        Stop Loss: ${{stop_loss}}
        {{/if}}
        {{#if take_profit}}
        Take Profit: ${{take_profit}}
        {{/if}}
        â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        â° {{timestamp}}
        
    alert:
      emoji: "âš ï¸"
      telegram_format: |
        âš ï¸ *ALERT*
        â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        {{message}}
        â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        â° {{timestamp}}
        
    report:
      emoji: "ğŸ“ˆ"
      telegram_format: |
        ğŸ“ˆ *{{report_type}}*
        â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        {{message}}
        
        {{#if metrics}}
        *Metrics:*
        {{#each metrics}}
        â€¢ {{@key}}: {{this}}
        {{/each}}
        {{/if}}
        â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        â° {{timestamp}}

  helpers:
    side_emoji:
      LONG: "ğŸ“ˆ"
      SHORT: "ğŸ“‰"
      BUY: "ğŸŸ¢"
      SELL: "ğŸ”´"
      
    pnl_emoji:
      condition: "pnl > 0"
      positive: "ğŸ‰"
      negative: "ğŸ˜"
      
    action_emoji:
      BUY: "ğŸŸ¢"
      SELL: "ğŸ”´"


# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ 7. PRIORIZAÃ‡ÃƒO E THROTTLING                                  â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

prioritization:
  levels:
    critical:
      description: Envio imediato, sem throttling
      channels: [telegram, discord, email]
      examples:
        - Sistema em falha crÃ­tica
        - Ordem rejeitada por risco
        - Drawdown mÃ¡ximo atingido
      rate_limit: none
      
    high:
      description: Envio prioritÃ¡rio com throttling mÃ­nimo
      channels: [telegram, discord]
      examples:
        - PosiÃ§Ã£o aberta/fechada
        - Ordem executada
        - Stop loss acionado
      rate_limit: 1 msg/segundo
      batching: disabled
      
    normal:
      description: Envio normal com throttling
      channels: [telegram]
      examples:
        - Sinais gerados
        - AtualizaÃ§Ãµes de posiÃ§Ã£o
      rate_limit: 1 msg/5 segundos
      batching:
        enabled: true
        window: 30 segundos
        max_batch_size: 5
        
    low:
      description: Envio com maior throttling e batching
      channels: [email]
      examples:
        - RelatÃ³rios periÃ³dicos
        - Logs informativos
      rate_limit: 1 msg/minuto
      batching:
        enabled: true
        window: 5 minutos
        max_batch_size: 10

throttling:
  strategy: Token Bucket
  implementation:
    storage: Redis
    key_pattern: "throttle:{channel}:{user_id}"
    
  per_channel:
    telegram:
      tokens: 30
      refill_rate: 1 per second
      
    discord:
      tokens: 5
      refill_rate: 1 per second
      
    email:
      tokens: 10
      refill_rate: 1 per minute

  batching:
    enabled_for: [normal, low]
    strategy: Time-based windowing
    aggregation:
      group_by: [category, symbol]
      format: |
        ğŸ“¦ *{{count}} Notifications*
        â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        {{#each grouped}}
        {{this.emoji}} {{this.title}}
        {{/each}}


# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ 8. RETRY E ERROR HANDLING                                    â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

retry_policy:
  strategy: Exponential Backoff with Jitter
  max_attempts: 3
  initial_delay: 1s
  max_delay: 30s
  multiplier: 2
  jitter: 0.1
  
  retryable_errors:
    - Network timeout
    - 5xx server errors
    - Rate limit exceeded (429)
    - Connection refused
    
  non_retryable_errors:
    - Invalid token/credentials (401)
    - Malformed payload (400)
    - Not found (404)
    
  backoff_formula: |
    delay = min(initial_delay * (multiplier ^ attempt), max_delay)
    jittered_delay = delay * (1 + random(-jitter, jitter))
    
  example:
    attempt_1: ~1s
    attempt_2: ~2s
    attempt_3: ~4s

error_handling:
  logging:
    level: error
    include:
      - Original payload
      - Channel attempted
      - Error message
      - Stacktrace (if panic)
      
  notification_on_failure:
    enabled: true
    channel: telegram
    recipient: admin_chat_id
    format: |
      ğŸš¨ *NOTIFICATION FAILURE*
      â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      Channel: {{channel}}
      Category: {{category}}
      Attempts: {{attempts}}
      Error: {{error}}
      â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      Original: {{original_message}}

  dead_letter_queue:
    enabled: true
    topic: notifications.failed
    retention: 7 days


# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ 9. CONFIGURAÃ‡ÃƒO                                              â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

configuration:
  format: YAML + Environment Variables
  precedence: ENV > config file > defaults
  
  files:
    development: config/development.yaml
    production: config/production.yaml
    
  structure:
    kafka:
      brokers: 
        env: KAFKA_BROKERS
        default: "localhost:9092"
      consumer_group:
        env: KAFKA_CONSUMER_GROUP
        default: "crypto-notifications-group"
      topics:
        notifications: "notifications.send"
        
    redis:
      url:
        env: REDIS_URL
        default: "redis://localhost:6379"
      pool_size: 10
      
    telegram:
      enabled:
        env: TELEGRAM_ENABLED
        default: true
      bot_token:
        env: TELEGRAM_BOT_TOKEN
        required: true
      default_chat_id:
        env: TELEGRAM_CHAT_ID
        required: true
        
    discord:
      enabled:
        env: DISCORD_ENABLED
        default: false
      webhook_url:
        env: DISCORD_WEBHOOK_URL
        required_if_enabled: true
        
    email:
      enabled:
        env: EMAIL_ENABLED
        default: false
      smtp_host:
        env: SMTP_HOST
      smtp_port:
        env: SMTP_PORT
        default: 587
      username:
        env: SMTP_USERNAME
      password:
        env: SMTP_PASSWORD
      from:
        env: SMTP_FROM_EMAIL
        
    webhook:
      enabled:
        env: WEBHOOK_ENABLED
        default: false
      url:
        env: WEBHOOK_URL
      secret:
        env: WEBHOOK_SECRET
        optional: true
        
    throttling:
      enabled:
        env: THROTTLING_ENABLED
        default: true
      batching_enabled:
        env: BATCHING_ENABLED
        default: true
        
    retry:
      max_attempts:
        env: RETRY_MAX_ATTEMPTS
        default: 3
      initial_delay_ms:
        env: RETRY_INITIAL_DELAY_MS
        default: 1000
        
    metrics:
      enabled:
        env: METRICS_ENABLED
        default: true
      port:
        env: METRICS_PORT
        default: 9090


# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ 10. FLUXOS PRINCIPAIS                                        â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

flows:
  basic_notification:
    description: Fluxo bÃ¡sico de notificaÃ§Ã£o simples
    steps:
      - step: 1
        component: Kafka Consumer
        action: Consome mensagem do tÃ³pico notifications.send
        
      - step: 2
        component: Message Handler
        action: Deserializa payload e valida schema
        
      - step: 3
        component: Router
        action: |
          - LÃª preferÃªncias do usuÃ¡rio (se user_id presente)
          - Determina canais baseado em 'channel' field
          - Aplica regras de priorizaÃ§Ã£o
          
      - step: 4
        component: Throttler
        action: |
          - Verifica rate limit (Redis)
          - Se throttled: adiciona Ã  fila de batch
          - Se ok: prossegue
          
      - step: 5
        component: Formatter
        action: |
          - Seleciona template baseado em categoria
          - Renderiza template com dados
          - Aplica formataÃ§Ã£o especÃ­fica do canal
          
      - step: 6
        component: Channel
        action: |
          - Envia para API externa
          - Trata resposta
          
      - step: 7
        component: Retry Manager (se falha)
        action: |
          - Calcula delay de retry
          - Agenda nova tentativa
          - Se max_attempts: publica em notifications.failed
          
      - step: 8
        component: Metrics
        action: |
          - Incrementa contador de entregas
          - Registra latÃªncia
          - Atualiza taxa de sucesso
          
    example_trace: |
      [Consumer] Received from Kafka: notifications.send
      [Handler] Validated payload: category=position, priority=high
      [Router] Selected channels: [telegram, discord]
      [Throttler] telegram: OK (tokens: 29/30)
      [Throttler] discord: OK (tokens: 4/5)
      [Formatter:Telegram] Rendered template: position_opened
      [Formatter:Discord] Rendered embed: position_opened
      [Channel:Telegram] Sent to chat_id=123456, msg_id=789
      [Channel:Discord] Sent to webhook, status=204
      [Metrics] notifications_sent{channel="telegram",category="position"} +1
      [Metrics] notifications_sent{channel="discord",category="position"} +1

  batching_flow:
    description: Fluxo com agrupamento de mensagens
    steps:
      - step: 1
        component: Kafka Consumer
        action: Consome vÃ¡rias mensagens priority=normal
        
      - step: 2
        component: Throttler
        action: |
          - Detecta throttling ativo
          - Adiciona mensagens ao batch buffer
          
      - step: 3
        component: Batch Window
        action: |
          - Aguarda janela de tempo (30s)
          - Ou atinge max_batch_size (5 msgs)
          
      - step: 4
        component: Batch Aggregator
        action: |
          - Agrupa por categoria e sÃ­mbolo
          - Gera mensagem consolidada
          
      - step: 5
        component: Formatter
        action: Renderiza template de batch
        
      - step: 6
        component: Channel
        action: Envia mensagem Ãºnica com mÃºltiplos eventos
        
    example_output: |
      ğŸ“¦ *5 Notifications*
      â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      ğŸ“Š Signal: BTC/USDT BUY
      ğŸ“Š Signal: ETH/USDT SELL
      ğŸ“Š Signal: BTC/USDT SELL
      ğŸ’° Order: BTC/USDT FILLED
      ğŸ’° Order: ETH/USDT CREATED

  retry_flow:
    description: Fluxo com falha e retry
    steps:
      - step: 1
        component: Channel
        action: Tentativa 1 - Timeout apÃ³s 5s
        result: Error (Network Timeout)
        
      - step: 2
        component: Retry Manager
        action: |
          - Identifica erro como retryable
          - Calcula delay: ~1s (attempt 1)
          - Agenda retry
          
      - step: 3
        component: Channel
        action: Tentativa 2 - Rate limit 429
        result: Error (Too Many Requests)
        
      - step: 4
        component: Retry Manager
        action: |
          - Calcula delay: ~2s (attempt 2)
          - Agenda retry
          
      - step: 5
        component: Channel
        action: Tentativa 3 - Sucesso
        result: OK
        
      - step: 6
        component: Metrics
        action: |
          - notifications_retries{channel="telegram"} +2
          - notifications_sent{channel="telegram"} +1

  failure_flow:
    description: Fluxo com falha definitiva
    steps:
      - step: 1-6
        action: Retry flow (3 tentativas falharam)
        
      - step: 7
        component: Retry Manager
        action: Max attempts reached
        
      - step: 8
        component: Dead Letter Publisher
        action: Publica em notifications.failed
        
      - step: 9
        component: Admin Notifier
        action: |
          - Envia alerta para admin (Telegram)
          - Inclui payload original e erro
          
      - step: 10
        component: Metrics
        action: notifications_failed{channel="telegram"} +1


# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ 11. MÃ‰TRICAS E OBSERVABILIDADE                               â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

metrics:
  prometheus_endpoint: /metrics
  port: 9090
  
  counters:
    - name: notifications_received_total
      help: Total de notificaÃ§Ãµes recebidas do Kafka
      labels: [category, priority]
      
    - name: notifications_sent_total
      help: Total de notificaÃ§Ãµes enviadas com sucesso
      labels: [channel, category, priority]
      
    - name: notifications_failed_total
      help: Total de notificaÃ§Ãµes que falharam definitivamente
      labels: [channel, category, error_type]
      
    - name: notifications_retries_total
      help: Total de retentativas realizadas
      labels: [channel, attempt]
      
    - name: notifications_throttled_total
      help: Total de notificaÃ§Ãµes throttled
      labels: [channel]
      
    - name: notifications_batched_total
      help: Total de notificaÃ§Ãµes agrupadas em batch
      labels: [category]
      
  histograms:
    - name: notification_send_duration_seconds
      help: DuraÃ§Ã£o do envio de notificaÃ§Ã£o
      labels: [channel, category]
      buckets: [0.01, 0.05, 0.1, 0.5, 1.0, 2.0, 5.0]
      
    - name: notification_processing_duration_seconds
      help: DuraÃ§Ã£o total do processamento (Kafka â†’ Envio)
      labels: [channel]
      buckets: [0.1, 0.5, 1.0, 2.0, 5.0, 10.0]
      
  gauges:
    - name: notification_queue_size
      help: Tamanho atual da fila de batching
      labels: [category]
      
    - name: channels_healthy
      help: NÃºmero de canais saudÃ¡veis (1=healthy, 0=unhealthy)
      labels: [channel]

  logging:
    format: JSON (structured logging)
    level: INFO (configurÃ¡vel via env)
    fields:
      - timestamp
      - level
      - message
      - channel
      - category
      - notification_id
      - user_id
      - duration_ms
      - error (if any)

  tracing:
    enabled: true
    library: tracing / tracing-subscriber
    spans:
      - name: handle_notification
        fields: [notification_id, category, channel]
      - name: format_message
        fields: [template, category]
      - name: send_to_channel
        fields: [channel, attempt]


# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ 12. INSTRUÃ‡Ã•ES DE DESENVOLVIMENTO                            â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

development_instructions:
  setup:
    prerequisites:
      - Rust 1.75+ (rustup)
      - Docker & Docker Compose
      - Redis client (redis-cli para debug)
      - Kafka client (kafkacat/kcat para debug)
      
    steps:
      - step: 1
        action: Clone o repositÃ³rio
        command: git clone <repo-url> && cd crypto-notifications
        
      - step: 2
        action: Copie o arquivo de configuraÃ§Ã£o
        command: cp .env.example .env
        
      - step: 3
        action: Configure as variÃ¡veis de ambiente
        details: |
          Edite .env e configure:
          - TELEGRAM_BOT_TOKEN (obtenha com @BotFather)
          - TELEGRAM_CHAT_ID (seu chat ID)
          - Outras credenciais conforme necessÃ¡rio
          
      - step: 4
        action: Inicie dependÃªncias
        command: docker-compose up -d kafka redis
        
      - step: 5
        action: Instale dependÃªncias Rust
        command: cargo build
        
      - step: 6
        action: Execute o serviÃ§o
        command: cargo run
        
  testing_notifications:
    manual_test:
      description: Enviar mensagem de teste para o Kafka
      command: |
        echo '{
          "channel": "telegram",
          "priority": "high",
          "category": "position",
          "title": "Test Position",
          "message": "Test message",
          "data": {
            "symbol": "BTCUSDT",
            "side": "LONG",
            "quantity": 0.01,
            "entry_price": 45000
          },
          "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"
        }' | kcat -P -b localhost:9092 -t notifications.send
        
    curl_test:
      description: Testar via API (se implementado endpoint de teste)
      command: |
        curl -X POST http://localhost:8080/test/notification \
          -H "Content-Type: application/json" \
          -d '{
            "channel": "telegram",
            "category": "alert",
            "message": "Test alert"
          }'
          
  debugging:
    logs:
      command: RUST_LOG=debug cargo run
      
    kafka_monitoring:
      consumer_lag: |
        kafka-consumer-groups.sh --bootstrap-server localhost:9092 \
          --group crypto-notifications-group --describe
          
      topic_messages: |
        kcat -C -b localhost:9092 -t notifications.send -o beginning
        
    redis_monitoring:
      check_throttle_keys: |
        redis-cli KEYS "throttle:*"
        
      inspect_key: |
        redis-cli HGETALL "throttle:telegram:user_123"
        
  hot_reload:
    tool: cargo-watch
    install: cargo install cargo-watch
    command: cargo watch -x run
    
  linting:
    clippy: cargo clippy -- -D warnings
    format: cargo fmt --check


# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ 13. TROUBLESHOOTING                                          â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

troubleshooting:
  common_issues:
    - issue: "NotificaÃ§Ãµes nÃ£o sendo enviadas"
      causes:
        - Kafka consumer nÃ£o conectado
        - Token do Telegram invÃ¡lido
        - Rate limit atingido
        - Redis nÃ£o disponÃ­vel
      solutions:
        - Verificar logs: RUST_LOG=debug cargo run
        - Testar conectividade: cargo run --bin health-check
        - Validar configuraÃ§Ã£o: cargo run --bin validate-config
        - Verificar mÃ©tricas: curl localhost:9090/metrics
        
    - issue: "Rate limit errors constantes"
      causes:
        - Muitas notificaÃ§Ãµes em curto perÃ­odo
        - Throttling configurado muito restritivo
      solutions:
        - Aumentar capacidade do token bucket
        - Habilitar/ajustar batching
        - Revisar prioridades das mensagens
        
    - issue: "Mensagens duplicadas"
      causes:
        - Consumer offset nÃ£o commitado
        - Retry sem idempotÃªncia
      solutions:
        - Verificar consumer group lag
        - Implementar deduplicaÃ§Ã£o via Redis
        - Configurar enable.auto.commit=true
        
    - issue: "FormataÃ§Ã£o incorreta"
      causes:
        - Template nÃ£o encontrado
        - Dados faltando no payload
        - Sintaxe handlebars invÃ¡lida
      solutions:
        - Verificar logs de template rendering
        - Validar payload contra schema
        - Testar template isoladamente
        
  health_checks:
    service_health:
      endpoint: GET /health
      expected_response: |
        {
          "status": "healthy",
          "version": "1.0.0",
          "uptime_seconds": 3600,
          "channels": {
            "telegram": "healthy",
            "discord": "healthy",
            "email": "degraded"
          },
          "dependencies": {
            "kafka": "connected",
            "redis": "connected"
          }
        }
        
    channel_health:
      telegram: |
        curl -X GET "https://api.telegram.org/bot<TOKEN>/getMe"
        
      discord: |
        curl -X GET "<WEBHOOK_URL>"
        
  log_analysis:
    error_patterns:
      - pattern: "SendFailed.*telegram.*401"
        meaning: Token invÃ¡lido
        action: Revisar TELEGRAM_BOT_TOKEN
        
      - pattern: "SendFailed.*429"
        meaning: Rate limit
        action: Aumentar throttling ou aguardar
        
      - pattern: "DeserializationError"
        meaning: Payload invÃ¡lido do Kafka
        action: Verificar schema do producer


# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ 14. ROADMAP & MELHORIAS FUTURAS                              â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

roadmap:
  v1_0:
    status: Current
    features:
      - âœ… Telegram integration
      - âœ… Discord integration
      - âœ… Email support
      - âœ… Basic throttling
      - âœ… Retry mechanism
      - âœ… Template system
      
  v1_1:
    planned_features:
      - User preferences management (DB)
      - Advanced batching strategies
      - SMS support (Twilio)
      - Push notifications (FCM)
      - A/B testing de templates
      
  v2_0:
    planned_features:
      - Multi-language support (i18n)
      - Rich analytics dashboard
      - Notification scheduling
      - Interactive notifications (buttons, actions)
      - AI-powered message optimization
      - Custom notification rules engine
      
  future_considerations:
    - WebSocket support para notificaÃ§Ãµes real-time
    - Mobile app integration
    - Voice notifications (phone calls)
    - Integration com ferramentas de BI
    - Machine learning para detectar spam patterns
    - GraphQL API para consulta de histÃ³rico


# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ 15. REFERÃŠNCIAS E DOCUMENTAÃ‡ÃƒO                               â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

references:
  external_apis:
    telegram:
      - name: Telegram Bot API
        url: https://core.telegram.org/bots/api
        docs: https://core.telegram.org/bots
        
    discord:
      - name: Discord Webhooks
        url: https://discord.com/developers/docs/resources/webhook
        
    email:
      - name: SMTP RFC
        url: https://datatracker.ietf.org/doc/html/rfc5321
        
  rust_libraries:
    - name: Tokio
      url: https://tokio.rs
      
    - name: rdkafka
      url: https://docs.rs/rdkafka
      
    - name: Teloxide
      url: https://docs.rs/teloxide
      
    - name: Handlebars
      url: https://docs.rs/handlebars
      
  architecture_patterns:
    - Event-Driven Architecture
    - Hexagonal Architecture (Ports & Adapters)
    - Domain-Driven Design (DDD)
    - CQRS (Command Query Responsibility Segregation)
    - Plugin Architecture
    - Circuit Breaker Pattern
    - Token Bucket Algorithm
    - Exponential Backoff


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# FIM DO PROJECT MAP
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
