# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# CRYPTO-WEBHOOK - PROJECT MAP
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Sistema de recepÃ§Ã£o e normalizaÃ§Ã£o de webhooks externos para trading
# Linguagem: Rust
# VersÃ£o: 1.0.0
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ 1. OVERVIEW DO PROJETO                                      â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

project:
  name: crypto-webhook
  description: |
    ServiÃ§o responsÃ¡vel por receber webhooks de fontes externas (TradingView,
    Discord bots, alerts customizados), validar autenticidade, normalizar
    payloads para formato padrÃ£o e publicar como sinais de trading.
    
    CaracterÃ­sticas principais:
    - API HTTP para receber webhooks de mÃºltiplas fontes
    - AutenticaÃ§Ã£o multi-mÃ©todo (token, HMAC, IP whitelist)
    - ValidaÃ§Ã£o de schemas por fonte
    - NormalizaÃ§Ã£o de payloads heterogÃªneos
    - Rate limiting por fonte
    - Replay prevention (idempotÃªncia)
    - PublicaÃ§Ã£o em Kafka (signals.buy/sell)
    - MÃ©tricas e auditoria completa
    - Suporte a custom sources (extensÃ­vel)

  language: Rust
  async_runtime: tokio
  web_framework: axum
  message_broker: Kafka (rdkafka)
  
  responsibilities:
    - Expor endpoints HTTP para receber webhooks
    - Autenticar e autorizar requisiÃ§Ãµes
    - Validar schemas de payload
    - Normalizar dados para formato padrÃ£o de sinal
    - Aplicar rate limiting por fonte
    - Prevenir replay attacks
    - Enriquecer sinais com metadados
    - Publicar sinais em tÃ³picos Kafka
    - Manter histÃ³rico de webhooks recebidos
    - Prover mÃ©tricas de recepÃ§Ã£o e validaÃ§Ã£o


# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ 2. ARQUITETURA                                               â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

architecture:
  pattern: Event-Driven + Hexagonal Architecture + Plugin System
  
  components:
    http_server:
      description: Servidor HTTP para receber webhooks
      technology: Axum (async web framework)
      features:
        - Routing por fonte (/webhook/tradingview, /webhook/custom)
        - Middlewares (auth, rate limit, logging)
        - Timeout configurÃ¡vel
        
    authenticator:
      description: Valida autenticidade das requisiÃ§Ãµes
      methods:
        - Token-based (Bearer token)
        - HMAC signature (SHA256)
        - IP whitelist
        - API key
      extensible: true
      
    schema_validator:
      description: Valida schemas de payload
      technology: JSON Schema ou serde
      per_source: true
      
    normalizer:
      description: Normaliza payloads heterogÃªneos
      strategy: Plugin-based (trait NormalizeWebhook)
      implementations:
        - TradingViewNormalizer
        - DiscordBotNormalizer
        - CustomAlertNormalizer
        - GenericNormalizer
        
    rate_limiter:
      description: Aplica rate limiting por fonte
      strategy: Token bucket + sliding window
      storage: Redis
      granularity: Por fonte + por IP
      
    replay_detector:
      description: Detecta e previne replay attacks
      strategy: Request signature cache (Redis)
      window: 5 minutos
      
    signal_enricher:
      description: Enriquece sinais com metadados
      additions:
        - Source information
        - Timestamp de recepÃ§Ã£o
        - Webhook ID Ãºnico
        - IP de origem (opcional)
        
    signal_publisher:
      description: Publica sinais no Kafka
      technology: rdkafka
      topics: [signals.buy, signals.sell]
      
    webhook_store:
      description: Armazena histÃ³rico de webhooks
      technology: Postgres
      retention: 30 dias (configurÃ¡vel)
      
    metrics:
      description: Coleta mÃ©tricas
      technology: Prometheus (rust-prometheus)
      
  data_flow: |
    HTTP Request â†’ Authenticator â†’ Rate Limiter â†’ Replay Detector â†’ 
    Schema Validator â†’ Normalizer â†’ Signal Enricher â†’ Signal Publisher â†’ Kafka
                                       â†“
                                 Webhook Store (audit)
                                       â†“
                                    Metrics


# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ 3. TÃ“PICOS KAFKA                                             â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

kafka_topics:
  produced:
    - name: signals.buy
      description: Sinais de compra normalizados de fontes externas
      consumers:
        - crypto-trader
        - crypto-management
        
      schema:
        symbol:
          type: string
          description: Par de negociaÃ§Ã£o (ex: BTCUSDT)
          
        strategy:
          type: string
          description: Nome da estratÃ©gia (mapeado da fonte)
          pattern: "^EXTERNAL_[A-Z_]+$"
          examples: ["EXTERNAL_MA_CROSS", "EXTERNAL_RSI_DIVERGENCE"]
          
        source:
          type: string
          description: Fonte do webhook
          enum: [tradingview, discord_bot, custom, generic]
          
        confidence:
          type: number
          description: NÃ­vel de confianÃ§a (configurÃ¡vel por fonte)
          range: [0.0, 1.0]
          default: 0.8
          
        target_price:
          type: number
          description: PreÃ§o atual/sugerido de entrada
          
        stop_loss:
          type: number
          optional: true
          description: Stop loss sugerido
          
        take_profit:
          type: number
          optional: true
          description: Take profit sugerido
          
        quantity:
          type: number
          optional: true
          description: Quantidade sugerida
          
        metadata:
          type: object
          description: Metadados adicionais
          fields:
            webhook_id: UUID Ãºnico do webhook
            source_strategy: Nome original da estratÃ©gia na fonte
            received_at: Timestamp de recepÃ§Ã£o
            original_payload: Payload original (opcional, debug)
            ip_address: IP de origem (opcional)
            alert_id: ID do alert na fonte (se disponÃ­vel)
          
        timestamp:
          type: string
          format: ISO8601
          description: Timestamp do sinal (da fonte ou de recepÃ§Ã£o)
          
      example_payload: |
        {
          "symbol": "BTCUSDT",
          "strategy": "EXTERNAL_MA_CROSSOVER",
          "source": "tradingview",
          "confidence": 0.85,
          "target_price": 45123.50,
          "stop_loss": 44000.00,
          "take_profit": 47000.00,
          "metadata": {
            "webhook_id": "550e8400-e29b-41d4-a716-446655440000",
            "source_strategy": "MA Crossover Alert",
            "received_at": "2025-10-16T22:00:00Z",
            "alert_id": "tv_123456"
          },
          "timestamp": "2025-10-16T22:00:00Z"
        }

    - name: signals.sell
      description: Sinais de venda
      schema: Similar ao signals.buy


# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ 4. MAPA DE PASTAS                                            â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

project_structure:
  description: Estrutura completa do projeto com descriÃ§Ã£o de cada mÃ³dulo
  architecture_layers: |
    Presentation â†’ Application â†’ Domain
                       â†“
                Infrastructure
    
    - Domain: nÃ£o depende de ninguÃ©m (nÃºcleo puro)
    - Application: depende apenas de Domain
    - Infrastructure: implementa contratos de Application
    - Presentation: usa Application e injeta Infrastructure via DI
    
  structure: |
    crypto-webhook/
    â”œâ”€â”€ src/
    â”‚   â”œâ”€â”€ main.rs                          # Entry point: bootstrap do app (config, HTTP server, publisher)
    â”‚   â”œâ”€â”€ lib.rs                           # Biblioteca pÃºblica expondo mÃ³dulos principais
    â”‚   â”‚
    â”‚   â”œâ”€â”€ domain/                          # â­ Camada de DomÃ­nio (regras de negÃ³cio puras, sem I/O)
    â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â”œâ”€â”€ errors.rs                    # Erros de domÃ­nio (ValidationError, UnauthorizedError)
    â”‚   â”‚   â”œâ”€â”€ aggregates/                  # Agregados DDD
    â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â”‚   â”œâ”€â”€ webhook.rs               # WebhookAggregate (valida, normaliza, aplica eventos)
    â”‚   â”‚   â”‚   â”œâ”€â”€ source.rs                # SourceAggregate (gerencia fonte autorizada)
    â”‚   â”‚   â”‚   â””â”€â”€ signal.rs                # SignalAggregate (valida sinal normalizado)
    â”‚   â”‚   â”œâ”€â”€ entities/                    # Entidades de domÃ­nio
    â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â”‚   â”œâ”€â”€ webhook.rs               # Entidade Webhook
    â”‚   â”‚   â”‚   â”œâ”€â”€ signal.rs                # Entidade Signal
    â”‚   â”‚   â”‚   â””â”€â”€ source_config.rs         # Entidade SourceConfig (configuraÃ§Ã£o de fonte)
    â”‚   â”‚   â”œâ”€â”€ events/                      # Domain events
    â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â”‚   â”œâ”€â”€ webhook_events.rs        # WebhookReceived, WebhookValidated, WebhookRejected
    â”‚   â”‚   â”‚   â”œâ”€â”€ signal_events.rs         # SignalNormalized, SignalPublished
    â”‚   â”‚   â”‚   â””â”€â”€ source_events.rs         # SourceRegistered, SourceDisabled
    â”‚   â”‚   â”œâ”€â”€ repositories/                # Traits de repositÃ³rios (contratos)
    â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â”‚   â”œâ”€â”€ webhook_repository.rs    # Contrato para persistir webhooks
    â”‚   â”‚   â”‚   â””â”€â”€ source_repository.rs     # Contrato para gerenciar fontes
    â”‚   â”‚   â”œâ”€â”€ services/                    # ServiÃ§os de domÃ­nio
    â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â”‚   â”œâ”€â”€ webhook_validator.rs     # Valida webhook (schema, regras de negÃ³cio)
    â”‚   â”‚   â”‚   â”œâ”€â”€ signal_normalizer.rs     # Normaliza payloads para formato padrÃ£o
    â”‚   â”‚   â”‚   â”œâ”€â”€ signature_validator.rs   # Valida assinaturas HMAC
    â”‚   â”‚   â”‚   â””â”€â”€ confidence_calculator.rs # Calcula confidence baseado na fonte
    â”‚   â”‚   â””â”€â”€ value_objects/               # Value objects
    â”‚   â”‚       â”œâ”€â”€ mod.rs
    â”‚   â”‚       â”œâ”€â”€ webhook_id.rs            # VO WebhookId (UUID)
    â”‚   â”‚       â”œâ”€â”€ source_name.rs           # VO SourceName (tradingview, custom, etc.)
    â”‚   â”‚       â”œâ”€â”€ signature.rs             # VO Signature (HMAC SHA256)
    â”‚   â”‚       â”œâ”€â”€ confidence.rs            # VO Confidence (0.0 a 1.0)
    â”‚   â”‚       â”œâ”€â”€ symbol.rs                # VO Symbol (validaÃ§Ã£o)
    â”‚   â”‚       â””â”€â”€ alert_id.rs              # VO AlertId (ID da fonte)
    â”‚   â”‚
    â”‚   â”œâ”€â”€ application/                     # â­ Camada de AplicaÃ§Ã£o (casos de uso, orquestraÃ§Ã£o)
    â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â”œâ”€â”€ dtos/                        # Data Transfer Objects
    â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â”‚   â”œâ”€â”€ commands.rs              # Command DTOs (ProcessWebhookCommand)
    â”‚   â”‚   â”‚   â”œâ”€â”€ webhook_dto.rs           # DTO para webhooks
    â”‚   â”‚   â”‚   â”œâ”€â”€ signal_dto.rs            # DTO para sinais normalizados
    â”‚   â”‚   â”‚   â”œâ”€â”€ requests.rs              # HTTP request DTOs (por fonte)
    â”‚   â”‚   â”‚   â””â”€â”€ responses.rs             # HTTP response DTOs
    â”‚   â”‚   â”œâ”€â”€ ports/                       # âš¡ Ports (interfaces/contratos para adapters)
    â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â”‚   â”œâ”€â”€ webhook_receiver_port.rs # Contrato para receber webhooks (HTTP)
    â”‚   â”‚   â”‚   â”œâ”€â”€ signal_publisher_port.rs # Contrato para publicar sinais (Kafka)
    â”‚   â”‚   â”‚   â”œâ”€â”€ webhook_store_port.rs    # Contrato para persistir webhooks
    â”‚   â”‚   â”‚   â”œâ”€â”€ source_store_port.rs     # Contrato para gerenciar fontes
    â”‚   â”‚   â”‚   â”œâ”€â”€ rate_limiter_port.rs     # Contrato para rate limiting
    â”‚   â”‚   â”‚   â””â”€â”€ replay_detector_port.rs  # Contrato para detectar replay
    â”‚   â”‚   â”œâ”€â”€ normalizers/                 # Normalizers (plugins por fonte)
    â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â”‚   â”œâ”€â”€ normalizer_trait.rs      # Trait WebhookNormalizer
    â”‚   â”‚   â”‚   â”œâ”€â”€ tradingview.rs           # TradingView normalizer
    â”‚   â”‚   â”‚   â”œâ”€â”€ discord_bot.rs           # Discord bot normalizer
    â”‚   â”‚   â”‚   â”œâ”€â”€ custom_alert.rs          # Custom alerts normalizer
    â”‚   â”‚   â”‚   â””â”€â”€ generic.rs               # Generic fallback normalizer
    â”‚   â”‚   â”œâ”€â”€ queries/                     # Queries (CQRS read-side)
    â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â”‚   â”œâ”€â”€ get_webhook_history.rs   # Query: histÃ³rico de webhooks
    â”‚   â”‚   â”‚   â””â”€â”€ get_source_stats.rs      # Query: estatÃ­sticas por fonte
    â”‚   â”‚   â””â”€â”€ services/                    # Application services (orquestraÃ§Ã£o de casos de uso)
    â”‚   â”‚       â”œâ”€â”€ mod.rs
    â”‚   â”‚       â”œâ”€â”€ webhook_service.rs       # Caso de uso: processar webhook
    â”‚   â”‚       â”œâ”€â”€ source_service.rs        # Caso de uso: gerenciar fontes
    â”‚   â”‚       â””â”€â”€ processing_orchestrator.rs # Orquestra: receive â†’ auth â†’ validate â†’ normalize â†’ publish
    â”‚   â”‚
    â”‚   â”œâ”€â”€ infrastructure/                  # â­ Camada de Infraestrutura (implementaÃ§Ãµes tÃ©cnicas)
    â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â”œâ”€â”€ bootstrap/                   # InicializaÃ§Ã£o de componentes
    â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â”‚   â”œâ”€â”€ database.rs              # Setup de conexÃ£o Postgres + migrations
    â”‚   â”‚   â”‚   â”œâ”€â”€ redis.rs                 # Setup de conexÃ£o Redis
    â”‚   â”‚   â”‚   â”œâ”€â”€ kafka_publisher.rs       # Inicializa publisher Kafka
    â”‚   â”‚   â”‚   â””â”€â”€ http_server.rs           # Inicializa servidor HTTP (Axum)
    â”‚   â”‚   â”œâ”€â”€ config/                      # ConfiguraÃ§Ã£o e settings
    â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â”‚   â”œâ”€â”€ settings.rs              # Struct Settings + carregamento de env vars
    â”‚   â”‚   â”‚   â””â”€â”€ sources_config.rs        # ConfiguraÃ§Ãµes por fonte (tokens, limits, etc.)
    â”‚   â”‚   â”œâ”€â”€ messaging/                   # Messaging
    â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â”‚   â””â”€â”€ kafka_signal_publisher.rs # Publisher de sinais para Kafka
    â”‚   â”‚   â”œâ”€â”€ authentication/              # AutenticaÃ§Ã£o
    â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â”‚   â”œâ”€â”€ token_authenticator.rs   # Bearer token authentication
    â”‚   â”‚   â”‚   â”œâ”€â”€ hmac_authenticator.rs    # HMAC signature validation
    â”‚   â”‚   â”‚   â”œâ”€â”€ ip_whitelist.rs          # IP whitelist validation
    â”‚   â”‚   â”‚   â””â”€â”€ api_key_authenticator.rs # API key authentication
    â”‚   â”‚   â”œâ”€â”€ rate_limiting/               # Rate limiting
    â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â”‚   â”œâ”€â”€ token_bucket_limiter.rs  # Token bucket via Redis
    â”‚   â”‚   â”‚   â””â”€â”€ sliding_window_limiter.rs # Sliding window via Redis
    â”‚   â”‚   â”œâ”€â”€ replay_prevention/           # Replay attack prevention
    â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â”‚   â””â”€â”€ redis_replay_detector.rs # Detector via Redis (request signature cache)
    â”‚   â”‚   â”œâ”€â”€ persistence/                 # PersistÃªncia (Postgres)
    â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â”‚   â”œâ”€â”€ postgres_webhook_repository.rs   # Store de webhooks (audit)
    â”‚   â”‚   â”‚   â””â”€â”€ postgres_source_repository.rs    # Store de fontes
    â”‚   â”‚   â”œâ”€â”€ schema_validation/           # ValidaÃ§Ã£o de schemas
    â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â”‚   â””â”€â”€ json_schema_validator.rs # Validador JSON Schema
    â”‚   â”‚   â”œâ”€â”€ metrics/                     # MÃ©tricas e observabilidade
    â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â”‚   â””â”€â”€ prometheus_metrics.rs    # Registra mÃ©tricas Prometheus
    â”‚   â”‚   â”œâ”€â”€ shutdown/                    # Shutdown graceful
    â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â”‚   â”œâ”€â”€ graceful.rs              # Coordena shutdown (drain requests, close connections)
    â”‚   â”‚   â”‚   â””â”€â”€ signal_handler.rs        # Captura sinais SIGTERM/SIGINT
    â”‚   â”‚   â””â”€â”€ startup/                     # Startup do aplicativo
    â”‚   â”‚       â”œâ”€â”€ mod.rs
    â”‚   â”‚       â”œâ”€â”€ banner.rs                # Banner ASCII no console
    â”‚   â”‚       â”œâ”€â”€ health.rs                # Health checks
    â”‚   â”‚       â””â”€â”€ logging.rs               # Setup de logs (tracing-subscriber)
    â”‚   â”‚
    â”‚   â”œâ”€â”€ presentation/                    # â­ Camada de ApresentaÃ§Ã£o (HTTP REST API)
    â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â””â”€â”€ http/                        # HTTP REST API (Axum)
    â”‚   â”‚       â”œâ”€â”€ mod.rs
    â”‚   â”‚       â”œâ”€â”€ router.rs                # DefiniÃ§Ã£o de rotas (endpoints por fonte)
    â”‚   â”‚       â”œâ”€â”€ responses.rs             # Helpers de resposta (WebhookResponse, ErrorResponse)
    â”‚   â”‚       â”œâ”€â”€ extractors/              # Axum extractors customizados
    â”‚   â”‚       â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚       â”‚   â”œâ”€â”€ signature_extractor.rs   # Extrai e valida HMAC signature
    â”‚   â”‚       â”‚   â””â”€â”€ source_extractor.rs      # Extrai informaÃ§Ãµes da fonte
    â”‚   â”‚       â”œâ”€â”€ handlers/                # HTTP handlers (por fonte)
    â”‚   â”‚       â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚       â”‚   â”œâ”€â”€ tradingview_handler.rs   # POST /webhook/tradingview
    â”‚   â”‚       â”‚   â”œâ”€â”€ discord_bot_handler.rs   # POST /webhook/discord
    â”‚   â”‚       â”‚   â”œâ”€â”€ custom_alert_handler.rs  # POST /webhook/custom
    â”‚   â”‚       â”‚   â”œâ”€â”€ generic_handler.rs       # POST /webhook/generic
    â”‚   â”‚       â”‚   â”œâ”€â”€ health_handler.rs        # GET /health
    â”‚   â”‚       â”‚   â””â”€â”€ webhook_history_handler.rs # GET /webhooks/history
    â”‚   â”‚       â””â”€â”€ middleware/              # Middlewares HTTP
    â”‚   â”‚           â”œâ”€â”€ mod.rs
    â”‚   â”‚           â”œâ”€â”€ auth_middleware.rs   # Middleware de autenticaÃ§Ã£o
    â”‚   â”‚           â”œâ”€â”€ rate_limit_middleware.rs # Middleware de rate limiting
    â”‚   â”‚           â”œâ”€â”€ replay_detection_middleware.rs # Middleware anti-replay
    â”‚   â”‚           â””â”€â”€ request_logger.rs    # Log de requests HTTP
    â”‚   â”‚
    â”‚   â””â”€â”€ shared/                          # â­ Shared Kernel (cÃ³digo transversal)
    â”‚       â”œâ”€â”€ mod.rs
    â”‚       â”œâ”€â”€ errors.rs                    # Erros compartilhados (ApplicationError, InfrastructureError)
    â”‚       â”œâ”€â”€ types.rs                     # Tipos compartilhados (EventEnvelope, Timestamp, etc.)
    â”‚       â”œâ”€â”€ traits/                      # Traits comuns
    â”‚       â”‚   â”œâ”€â”€ mod.rs
    â”‚       â”‚   â””â”€â”€ aggregate_root.rs        # Trait AggregateRoot
    â”‚       â””â”€â”€ utils/                       # UtilitÃ¡rios
    â”‚           â”œâ”€â”€ mod.rs
    â”‚           â”œâ”€â”€ datetime.rs              # Helpers de data/hora
    â”‚           â”œâ”€â”€ hmac.rs                  # Helpers de HMAC
    â”‚           â”œâ”€â”€ validation.rs            # ValidaÃ§Ãµes genÃ©ricas
    â”‚           â””â”€â”€ json.rs                  # Helpers JSON
    â”‚
    â”œâ”€â”€ config/                              # ğŸ“ ConfiguraÃ§Ãµes externas
    â”‚   â”œâ”€â”€ development.yaml                 # Config para ambiente dev
    â”‚   â”œâ”€â”€ production.yaml                  # Config para ambiente prod
    â”‚   â”œâ”€â”€ sources/                         # ConfiguraÃ§Ãµes por fonte
    â”‚   â”‚   â”œâ”€â”€ tradingview.yaml             # Config TradingView (auth, limits, schema)
    â”‚   â”‚   â”œâ”€â”€ discord_bot.yaml             # Config Discord bot
    â”‚   â”‚   â”œâ”€â”€ custom_alert.yaml            # Config custom alerts
    â”‚   â”‚   â””â”€â”€ generic.yaml                 # Config generic webhooks
    â”‚   â””â”€â”€ schemas/                         # JSON Schemas por fonte
    â”‚       â”œâ”€â”€ tradingview_schema.json      # Schema esperado do TradingView
    â”‚       â”œâ”€â”€ discord_bot_schema.json      # Schema Discord bot
    â”‚       â””â”€â”€ custom_alert_schema.json     # Schema custom alerts
    â”‚
    â”œâ”€â”€ migrations/                          # ğŸ“Š MigraÃ§Ãµes de banco (Flyway)
    â”‚   â”œâ”€â”€ V001__initial_schema.sql         # Schema inicial (webhooks, sources)
    â”‚   â”œâ”€â”€ V002__webhook_metadata.sql       # Metadados adicionais
    â”‚   â””â”€â”€ V003__indexes.sql                # Ãndices para performance
    â”‚
    â”œâ”€â”€ docs/                                # ğŸ“š DocumentaÃ§Ã£o tÃ©cnica
    â”‚   â”œâ”€â”€ README.md                        # Ãndice de documentaÃ§Ã£o
    â”‚   â”œâ”€â”€ ARCHITECTURE.md                  # Detalhes da arquitetura hexagonal
    â”‚   â”œâ”€â”€ SOURCES.md                       # Como adicionar nova fonte
    â”‚   â”œâ”€â”€ TRADINGVIEW_SETUP.md             # Setup de webhooks no TradingView
    â”‚   â””â”€â”€ SECURITY.md                      # ConsideraÃ§Ãµes de seguranÃ§a
    â”‚
    â”œâ”€â”€ Cargo.toml                           # ConfiguraÃ§Ã£o Rust (deps, features)
    â”œâ”€â”€ Cargo.lock                           # Lock file de dependÃªncias
    â”œâ”€â”€ Dockerfile                           # Build multi-stage production
    â”œâ”€â”€ docker-compose.yml                   # Stack completa (app, Kafka, Postgres, Redis)
    â”œâ”€â”€ Makefile                             # Comandos make (build, test, docker)
    â”œâ”€â”€ crypto-webhook_projectmap.yaml       # Este arquivo (documentaÃ§Ã£o estruturada)
    â””â”€â”€ README.md                            # DocumentaÃ§Ã£o principal do projeto
    
  conventions:
    domain_layer:
      description: Camada de DomÃ­nio (domain/)
      rules:
        - âœ… Sem dependÃªncias de infraestrutura
        - âœ… LÃ³gica de negÃ³cio pura (validaÃ§Ã£o de sinais, normalizaÃ§Ã£o)
        - âœ… Aggregates aplicam eventos e validam invariantes
        - âœ… Value objects imutÃ¡veis com validaÃ§Ã£o
        - âœ… Services de domÃ­nio para lÃ³gica cross-aggregate
        - âœ… Repositories como traits (contratos apenas)
        
    application_layer:
      description: Camada de AplicaÃ§Ã£o (application/)
      rules:
        - âœ… Define Ports (interfaces) que infraestrutura implementa
        - âœ… Orquestra casos de uso (receive â†’ validate â†’ normalize â†’ publish)
        - âœ… DTOs para comunicaÃ§Ã£o entre camadas
        - âœ… Normalizers como plugins (trait-based)
        - âœ… Queries para read-side (histÃ³rico, stats)
        - âœ… NÃ£o conhece detalhes de implementaÃ§Ã£o (Axum, Kafka, Redis)
        
    infrastructure_layer:
      description: Camada de Infraestrutura (infrastructure/)
      rules:
        - âœ… Implementa Adapters (HTTP, Kafka, Postgres, Redis)
        - âœ… Bootstrap e configuraÃ§Ã£o
        - âœ… Authentication (token, HMAC, IP whitelist)
        - âœ… Rate limiting (Redis-based)
        - âœ… Replay prevention (Redis cache)
        - âœ… Persistence (Postgres)
        - âœ… Shutdown graceful
        - âœ… Startup e health checks
        
    presentation_layer:
      description: Camada de ApresentaÃ§Ã£o (presentation/)
      rules:
        - âœ… HTTP REST API (Axum)
        - âœ… Handlers por fonte (/webhook/tradingview, etc)
        - âœ… Extractors customizados (signature, source)
        - âœ… Middlewares (auth, rate limit, replay detection)
        - âœ… ConversÃ£o DTOs <-> JSON
        - âœ… NÃ£o contÃ©m lÃ³gica de negÃ³cio
        
    shared_kernel:
      description: Shared Kernel (shared/)
      rules:
        - âœ… CÃ³digo compartilhado entre camadas
        - âœ… Traits comuns (AggregateRoot)
        - âœ… Tipos transversais (EventEnvelope)
        - âœ… UtilitÃ¡rios (datetime, HMAC, validaÃ§Ã£o, JSON)
        - âœ… Erros compartilhados


# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ 5. FONTES DE WEBHOOK                                         â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

webhook_sources:
  tradingview:
    description: Alertas do TradingView
    endpoint: POST /webhook/tradingview
    authentication:
      method: token
      header: Authorization
      format: "Bearer <token>"
    rate_limit:
      requests: 100
      window: 1 minute
    schema:
      ticker: string (ex: "BINANCE:BTCUSDT")
      action: enum [buy, sell]
      price: string (nÃºmero como string)
      strategy: string (nome do alert)
      time: optional string (timestamp)
      exchange: optional string
    normalization:
      ticker: "BINANCE:BTCUSDT" â†’ symbol: "BTCUSDT"
      action: "buy" â†’ side: BUY
      strategy: "MA Cross" â†’ strategy: "EXTERNAL_MA_CROSS"
    confidence: 0.80 (configurÃ¡vel)
    example_payload: |
      {
        "ticker": "BINANCE:BTCUSDT",
        "action": "buy",
        "price": "45123.50",
        "strategy": "MA Crossover Alert",
        "time": "2025-10-16T22:00:00Z"
      }
      
  discord_bot:
    description: Sinais de Discord bots (comunidades, bots de trading)
    endpoint: POST /webhook/discord
    authentication:
      method: api_key
      header: X-API-Key
    rate_limit:
      requests: 50
      window: 1 minute
    schema:
      symbol: string
      side: enum [BUY, SELL]
      price: number
      signal_name: string
      confidence: optional number (0.0-1.0)
      bot_id: string
    normalization:
      signal_name â†’ strategy: "EXTERNAL_<SIGNAL_NAME>"
      confidence: use provided or default 0.75
    confidence: 0.75 (default se nÃ£o fornecido)
    example_payload: |
      {
        "symbol": "BTCUSDT",
        "side": "BUY",
        "price": 45000.00,
        "signal_name": "SCALPING_RSI",
        "confidence": 0.80,
        "bot_id": "discord_bot_123"
      }
      
  custom_alert:
    description: Alertas customizados (sistemas prÃ³prios, outros bots)
    endpoint: POST /webhook/custom
    authentication:
      method: hmac
      header: X-Signature
      algorithm: SHA256
      secret: configurÃ¡vel por cliente
    rate_limit:
      requests: 200
      window: 1 minute
    schema: FlexÃ­vel (validaÃ§Ã£o bÃ¡sica)
      symbol: required string
      action: required enum [buy, sell]
      price: required number
      Additional fields: optional
    normalization:
      action â†’ side (uppercase)
      strategy: use "EXTERNAL_CUSTOM" ou campo fornecido
    confidence: 0.70 (configurÃ¡vel)
    example_payload: |
      {
        "symbol": "ETHUSDT",
        "action": "sell",
        "price": 2500.00,
        "stop_loss": 2550.00,
        "metadata": {
          "system": "my_custom_bot",
          "strategy": "MEAN_REVERSION"
        }
      }
      
  generic:
    description: Webhook genÃ©rico (catch-all para testes)
    endpoint: POST /webhook/generic
    authentication:
      method: token
      header: Authorization
    rate_limit:
      requests: 10
      window: 1 minute
    schema: Minimal validation
      symbol: required
      side: required
    normalization:
      Best-effort mapping
      Defaults para campos faltantes
    confidence: 0.60
    use_case: Testes, prototipagem, fontes nÃ£o padronizadas


# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ 6. AUTENTICAÃ‡ÃƒO E SEGURANÃ‡A                                  â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

authentication:
  methods:
    bearer_token:
      description: Token fixo no header Authorization
      header: "Authorization: Bearer <token>"
      validation: Compara token com valor configurado por fonte
      use_case: TradingView, fontes simples
      security_level: MÃ©dio
      
    hmac_signature:
      description: Assinatura HMAC SHA256 do payload
      header: "X-Signature: <hmac_sha256>"
      algorithm: HMAC-SHA256
      process: |
        1. Fonte calcula: HMAC-SHA256(payload_json, secret)
        2. Envia signature no header
        3. Servidor recalcula e compara
      validation: |
        calculated_signature = HMAC-SHA256(request_body, configured_secret)
        if calculated_signature != provided_signature â†’ REJECT
      use_case: Custom alerts, integraÃ§Ãµes seguras
      security_level: Alto
      
    api_key:
      description: API key no header customizado
      header: "X-API-Key: <api_key>"
      validation: Compara com valor configurado
      use_case: Discord bots, APIs simples
      security_level: MÃ©dio
      
    ip_whitelist:
      description: Whitelist de IPs permitidos
      validation: Verifica IP de origem contra lista
      combinable: true (pode combinar com outros mÃ©todos)
      use_case: Restringir acesso a IPs conhecidos
      security_level: MÃ©dio (nÃ£o protege contra IP spoofing)

security_measures:
  rate_limiting:
    description: Limita requisiÃ§Ãµes por fonte/IP
    implementation: Token bucket via Redis
    granularity:
      - Por fonte (global)
      - Por IP (individual)
    configurÃ¡vel: true
    default_limits:
      tradingview: 100 req/min
      discord_bot: 50 req/min
      custom_alert: 200 req/min
      generic: 10 req/min
      
  replay_prevention:
    description: Previne replay attacks
    implementation: Request signature cache (Redis)
    process: |
      1. Calcula hash do request (method + path + body + timestamp)
      2. Verifica se hash existe no cache
      3. Se existe â†’ REJECT (replay)
      4. Se nÃ£o existe â†’ aceita e armazena no cache
    window: 5 minutos
    cache_key: "replay:<signature_hash>"
    
  request_timeout:
    description: Timeout para processar request
    default: 10 segundos
    prevents: Slowloris attacks, request flooding
    
  payload_size_limit:
    description: Limita tamanho do payload
    default: 1 MB
    configurable: true per source
    prevents: Memory exhaustion attacks
    
  https_only:
    description: Aceita apenas HTTPS em produÃ§Ã£o
    enforcement: Redirect HTTP â†’ HTTPS ou reject
    
  cors:
    description: CORS configurÃ¡vel
    default: Disabled (webhooks geralmente nÃ£o precisam)
    configurable: true


# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ 7. NORMALIZAÃ‡ÃƒO DE PAYLOADS                                  â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

normalization:
  concept: |
    Cada fonte de webhook tem formato prÃ³prio de payload. A normalizaÃ§Ã£o
    converte esses formatos heterogÃªneos para um formato padrÃ£o (SignalDTO)
    que Ã© publicado no Kafka.
    
  strategy: Plugin-based via trait WebhookNormalizer
  
  normalizer_trait: |
    pub trait WebhookNormalizer {
        fn normalize(&self, payload: Value) -> Result<SignalDTO>;
        fn source_name(&self) -> &str;
        fn default_confidence(&self) -> f64;
    }
  
  implementations:
    tradingview_normalizer:
      input_fields:
        - ticker: "BINANCE:BTCUSDT"
        - action: "buy"
        - price: "45000.00"
        - strategy: "MA Crossover"
      mapping:
        ticker: |
          Split by ":" â†’ take last part
          "BINANCE:BTCUSDT" â†’ "BTCUSDT"
        action: |
          Lowercase â†’ uppercase
          "buy" â†’ "BUY"
        price: |
          String â†’ parse as f64
          "45000.00" â†’ 45000.00
        strategy: |
          Sanitize + prefix
          "MA Crossover" â†’ "EXTERNAL_MA_CROSSOVER"
      output: SignalDTO
      
    discord_bot_normalizer:
      input_fields:
        - symbol: "BTCUSDT"
        - side: "BUY"
        - price: 45000.00
        - signal_name: "SCALPING_RSI"
        - confidence: 0.80
      mapping:
        symbol: Direct mapping
        side: Direct mapping (jÃ¡ uppercase)
        signal_name: Prefix â†’ "EXTERNAL_SCALPING_RSI"
        confidence: Use provided or default
      output: SignalDTO
      
    custom_alert_normalizer:
      input_fields: FlexÃ­vel
      mapping:
        symbol: Extract from payload.symbol
        action/side: Normalize to uppercase
        strategy: Use provided or "EXTERNAL_CUSTOM"
        price: Extract price field
        Additional: Map to metadata
      output: SignalDTO
      
  signal_dto_structure: |
    pub struct SignalDTO {
        pub symbol: String,
        pub strategy: String,
        pub source: String,
        pub confidence: f64,
        pub target_price: f64,
        pub stop_loss: Option<f64>,
        pub take_profit: Option<f64>,
        pub quantity: Option<f64>,
        pub metadata: HashMap<String, Value>,
        pub timestamp: DateTime<Utc>,
    }


# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ 8. FLUXOS PRINCIPAIS                                         â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

flows:
  webhook_processing:
    description: Fluxo completo de processamento de webhook
    steps:
      - step: 1
        component: HTTP Server (Axum)
        action: Recebe POST /webhook/tradingview
        
      - step: 2
        component: Auth Middleware
        action: |
          - Extrai token do header Authorization
          - Compara com token configurado para TradingView
          - Se invÃ¡lido â†’ 401 Unauthorized
        result: Authenticated ou Rejected
        
      - step: 3
        component: Rate Limit Middleware
        action: |
          - Verifica rate limit no Redis (token bucket)
          - Key: "ratelimit:tradingview"
          - Se excedido â†’ 429 Too Many Requests
        result: Allowed ou Rate Limited
        
      - step: 4
        component: Replay Detection Middleware
        action: |
          - Calcula hash do request
          - Verifica no Redis se hash existe
          - Se existe â†’ 409 Conflict (replay)
          - Se nÃ£o â†’ armazena hash (TTL 5min)
        result: New Request ou Replay
        
      - step: 5
        component: Handler (TradingViewHandler)
        action: |
          - Deserializa payload JSON
          - Valida schema bÃ¡sico
        
      - step: 6
        component: Schema Validator
        action: |
          - Valida contra JSON Schema de TradingView
          - Verifica campos obrigatÃ³rios
          - Se invÃ¡lido â†’ 400 Bad Request
        result: Valid ou Invalid Schema
        
      - step: 7
        component: Webhook Service
        action: |
          - Cria WebhookAggregate
          - Aplica validaÃ§Ãµes de domÃ­nio
          
      - step: 8
        component: TradingView Normalizer
        action: |
          - Normaliza payload para SignalDTO
          - ticker: "BINANCE:BTCUSDT" â†’ symbol: "BTCUSDT"
          - action: "buy" â†’ side: BUY
          - strategy: "MA Cross" â†’ "EXTERNAL_MA_CROSS"
          
      - step: 9
        component: Signal Enricher
        action: |
          - Adiciona webhook_id (UUID)
          - Adiciona source: "tradingview"
          - Adiciona received_at timestamp
          - Adiciona confidence: 0.80
          - Adiciona metadata (original payload, etc)
          
      - step: 10
        component: Signal Publisher
        action: |
          - Publica SignalDTO em signals.buy (Kafka)
          - Serializa para JSON
          
      - step: 11
        component: Webhook Repository
        action: |
          - Persiste webhook no Postgres (audit)
          - Inclui: payload, headers, resultado, timestamp
          
      - step: 12
        component: Metrics
        action: |
          - webhooks_received_total{source="tradingview"} +1
          - webhooks_processed_duration_seconds
          
      - step: 13
        component: HTTP Response
        action: Return 200 OK com webhook_id
        
    example_trace: |
      [HTTP] POST /webhook/tradingview
      [Auth] Token validated: OK
      [RateLimit] tradingview: 45/100 requests â†’ OK
      [Replay] Hash not found â†’ NEW REQUEST
      [Handler] Payload deserialized
      [SchemaValidator] Schema valid
      [Normalizer] Normalized: BTCUSDT BUY @ 45123.50
      [Enricher] Added webhook_id=550e8400-..., source=tradingview
      [Publisher] Published to signals.buy
      [Repository] Webhook persisted (id=550e8400-...)
      [Metrics] webhooks_received_total{source="tradingview",status="success"} +1
      [Response] 200 OK {"webhook_id": "550e8400-...", "status": "accepted"}

  webhook_rejection:
    description: Fluxo de rejeiÃ§Ã£o de webhook
    reasons:
      - Authentication failure
      - Rate limit exceeded
      - Replay detected
      - Schema validation failure
      - Normalization error
    steps:
      - step: 1-4
        action: Fluxo normal atÃ© validaÃ§Ã£o falhar
        
      - step: 5
        component: Middleware/Validator
        action: Detecta violaÃ§Ã£o
        examples:
          - Invalid token â†’ 401
          - Rate limit â†’ 429
          - Replay â†’ 409
          - Invalid schema â†’ 400
          
      - step: 6
        component: Metrics
        action: |
          - webhooks_rejected_total{source="tradingview",reason="auth_failed"} +1
          
      - step: 7
        component: Webhook Repository (optional)
        action: Persiste tentativa falhada (audit)
        
      - step: 8
        component: HTTP Response
        action: Return error code com detalhes
        
    example_responses:
      auth_failed: |
        401 Unauthorized
        {"error": "Invalid authentication token"}
        
      rate_limited: |
        429 Too Many Requests
        {"error": "Rate limit exceeded", "retry_after": 60}
        
      replay_detected: |
        409 Conflict
        {"error": "Duplicate request detected"}
        
      invalid_schema: |
        400 Bad Request
        {"error": "Invalid payload schema", "details": ["ticker is required"]}


# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ 9. CONFIGURAÃ‡ÃƒO                                              â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

configuration:
  format: YAML + Environment Variables
  precedence: ENV > config file > defaults
  
  files:
    development: config/development.yaml
    production: config/production.yaml
    sources: config/sources/*.yaml
    schemas: config/schemas/*.json
    
  structure:
    server:
      host:
        env: SERVER_HOST
        default: "0.0.0.0"
      port:
        env: SERVER_PORT
        default: 8080
      timeout_seconds:
        env: SERVER_TIMEOUT
        default: 10
      max_payload_size_bytes:
        env: SERVER_MAX_PAYLOAD_SIZE
        default: 1048576  # 1 MB
        
    kafka:
      brokers:
        env: KAFKA_BROKERS
        default: "localhost:9092"
      topics:
        signals_buy: "signals.buy"
        signals_sell: "signals.sell"
      producer_timeout_ms:
        env: KAFKA_PRODUCER_TIMEOUT
        default: 5000
        
    redis:
      url:
        env: REDIS_URL
        default: "redis://localhost:6379"
      pool_size:
        env: REDIS_POOL_SIZE
        default: 10
        
    database:
      url:
        env: DATABASE_URL
        required: true
      pool_size:
        env: DATABASE_POOL_SIZE
        default: 5
        
    sources:
      tradingview:
        enabled:
          env: SOURCE_TRADINGVIEW_ENABLED
          default: true
        auth_method: token
        token:
          env: TRADINGVIEW_TOKEN
          required_if_enabled: true
        rate_limit_requests:
          env: TRADINGVIEW_RATE_LIMIT_REQUESTS
          default: 100
        rate_limit_window_seconds:
          env: TRADINGVIEW_RATE_LIMIT_WINDOW
          default: 60
        confidence:
          env: TRADINGVIEW_CONFIDENCE
          default: 0.80
          
      discord_bot:
        enabled:
          env: SOURCE_DISCORD_ENABLED
          default: false
        auth_method: api_key
        api_key:
          env: DISCORD_API_KEY
          required_if_enabled: true
        rate_limit_requests: 50
        rate_limit_window_seconds: 60
        confidence: 0.75
        
      custom_alert:
        enabled:
          env: SOURCE_CUSTOM_ENABLED
          default: false
        auth_method: hmac
        secret:
          env: CUSTOM_HMAC_SECRET
          required_if_enabled: true
        rate_limit_requests: 200
        rate_limit_window_seconds: 60
        confidence: 0.70
        
      generic:
        enabled:
          env: SOURCE_GENERIC_ENABLED
          default: true
        auth_method: token
        token:
          env: GENERIC_TOKEN
          required_if_enabled: true
        rate_limit_requests: 10
        rate_limit_window_seconds: 60
        confidence: 0.60
        
    security:
      replay_prevention_enabled:
        env: SECURITY_REPLAY_PREVENTION
        default: true
      replay_window_seconds:
        env: SECURITY_REPLAY_WINDOW
        default: 300  # 5 minutos
      https_only:
        env: SECURITY_HTTPS_ONLY
        default: false  # true em produÃ§Ã£o
        
    metrics:
      enabled:
        env: METRICS_ENABLED
        default: true
      port:
        env: METRICS_PORT
        default: 9090


# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ 10. MÃ‰TRICAS E OBSERVABILIDADE                               â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

metrics:
  prometheus_endpoint: /metrics
  port: 9090
  
  counters:
    - name: webhooks_received_total
      help: Total de webhooks recebidos
      labels: [source, status]
      
    - name: webhooks_rejected_total
      help: Total de webhooks rejeitados
      labels: [source, reason]
      
    - name: signals_published_total
      help: Total de sinais publicados no Kafka
      labels: [source, side]
      
    - name: authentication_failures_total
      help: Total de falhas de autenticaÃ§Ã£o
      labels: [source, method]
      
    - name: rate_limit_exceeded_total
      help: Total de requests bloqueados por rate limit
      labels: [source]
      
    - name: replay_attacks_detected_total
      help: Total de replay attacks detectados
      labels: [source]
      
    - name: schema_validation_failures_total
      help: Total de falhas de validaÃ§Ã£o de schema
      labels: [source]
      
  histograms:
    - name: webhook_processing_duration_seconds
      help: DuraÃ§Ã£o do processamento de webhook
      labels: [source]
      buckets: [0.01, 0.05, 0.1, 0.5, 1.0, 2.0, 5.0]
      
    - name: normalization_duration_seconds
      help: DuraÃ§Ã£o da normalizaÃ§Ã£o de payload
      labels: [source]
      buckets: [0.001, 0.005, 0.01, 0.05, 0.1]
      
  gauges:
    - name: active_http_connections
      help: NÃºmero de conexÃµes HTTP ativas
      labels: []
      
    - name: rate_limit_tokens_remaining
      help: Tokens restantes no rate limiter
      labels: [source]

  logging:
    format: JSON (structured logging)
    level: INFO (configurÃ¡vel via env)
    fields:
      - timestamp
      - level
      - message
      - source
      - webhook_id
      - duration_ms
      - error (if any)
      - ip_address (optional)

  tracing:
    enabled: true
    library: tracing / tracing-subscriber
    spans:
      - name: process_webhook
        fields: [webhook_id, source]
      - name: authenticate
        fields: [source, method]
      - name: normalize_payload
        fields: [source]
      - name: publish_signal
        fields: [webhook_id, topic]


# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ 11. INSTRUÃ‡Ã•ES DE DESENVOLVIMENTO                            â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

development_instructions:
  setup:
    prerequisites:
      - Rust 1.75+ (rustup)
      - Docker & Docker Compose
      - Postgres client (psql)
      - Redis client (redis-cli)
      - Kafka client (kafkacat/kcat)
      - curl ou Postman (para testar webhooks)
      
    steps:
      - step: 1
        action: Clone o repositÃ³rio
        command: git clone <repo-url> && cd crypto-webhook
        
      - step: 2
        action: Copie o arquivo de configuraÃ§Ã£o
        command: cp .env.example .env
        
      - step: 3
        action: Configure as variÃ¡veis de ambiente
        details: |
          Edite .env e configure:
          - TRADINGVIEW_TOKEN (token para TradingView)
          - CUSTOM_HMAC_SECRET (secret para HMAC)
          - DATABASE_URL
          - KAFKA_BROKERS
          - REDIS_URL
          
      - step: 4
        action: Inicie dependÃªncias
        command: docker-compose up -d kafka postgres redis
        
      - step: 5
        action: Execute migrations
        command: cargo run --bin migrate
        
      - step: 6
        action: Instale dependÃªncias Rust
        command: cargo build
        
      - step: 7
        action: Execute o serviÃ§o
        command: cargo run
        
  testing_webhooks:
    tradingview_webhook:
      description: Testar endpoint do TradingView
      command: |
        curl -X POST http://localhost:8080/webhook/tradingview \
          -H "Authorization: Bearer seu-token-aqui" \
          -H "Content-Type: application/json" \
          -d '{
            "ticker": "BINANCE:BTCUSDT",
            "action": "buy",
            "price": "45000.00",
            "strategy": "MA Crossover Alert"
          }'
          
    custom_webhook_with_hmac:
      description: Testar endpoint custom com HMAC
      steps:
        - step: 1
          action: Calcular HMAC do payload
          command: |
            payload='{"symbol":"BTCUSDT","action":"buy","price":45000}'
            signature=$(echo -n "$payload" | openssl dgst -sha256 -hmac "seu-secret" | awk '{print $2}')
            echo "Signature: $signature"
            
        - step: 2
          action: Enviar request com signature
          command: |
            curl -X POST http://localhost:8080/webhook/custom \
              -H "X-Signature: $signature" \
              -H "Content-Type: application/json" \
              -d "$payload"
              
    verify_signal_published:
      description: Verificar se sinal foi publicado no Kafka
      command: |
        kcat -C -b localhost:9092 -t signals.buy -o end
        
  debugging:
    logs:
      command: RUST_LOG=debug cargo run
      
    check_webhooks_stored:
      command: |
        psql $DATABASE_URL -c "SELECT * FROM webhooks ORDER BY created_at DESC LIMIT 5;"
        
    check_rate_limits:
      command: |
        redis-cli KEYS "ratelimit:*"
        redis-cli GET "ratelimit:tradingview"
        
    check_replay_cache:
      command: |
        redis-cli KEYS "replay:*"


# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ 12. TROUBLESHOOTING                                          â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

troubleshooting:
  common_issues:
    - issue: "Webhooks sendo rejeitados com 401"
      causes:
        - Token invÃ¡lido ou nÃ£o configurado
        - Header Authorization mal formatado
      solutions:
        - Verificar TRADINGVIEW_TOKEN: echo $TRADINGVIEW_TOKEN
        - Verificar header: "Authorization: Bearer <token>"
        - Verificar logs: RUST_LOG=debug
        
    - issue: "Webhooks rejeitados com 429 (rate limit)"
      causes:
        - Muitas requisiÃ§Ãµes em curto perÃ­odo
        - Rate limit configurado muito restritivo
      solutions:
        - Verificar contador no Redis: redis-cli GET "ratelimit:tradingview"
        - Ajustar limites em config/sources/tradingview.yaml
        - Aguardar janela de rate limit (default: 1 minuto)
        
    - issue: "Replay detected (409)"
      causes:
        - RequisiÃ§Ã£o duplicada dentro da janela (5min)
        - Request idÃªntico sendo enviado novamente
      solutions:
        - Verificar se Ã© realmente replay ou bug no sender
        - Limpar cache de replay: redis-cli DEL "replay:<hash>"
        - Ajustar replay window se necessÃ¡rio
        
    - issue: "Schema validation failure (400)"
      causes:
        - Payload nÃ£o conforme schema esperado
        - Campos obrigatÃ³rios faltando
      solutions:
        - Verificar schema: cat config/schemas/tradingview_schema.json
        - Comparar payload enviado vs schema
        - Verificar logs de validaÃ§Ã£o
        
    - issue: "Sinais nÃ£o aparecendo no Kafka"
      causes:
        - Kafka nÃ£o conectado
        - Erro na publicaÃ§Ã£o
        - TÃ³pico nÃ£o existe
      solutions:
        - Verificar health: curl localhost:8080/health
        - Verificar mÃ©tricas: curl localhost:9090/metrics | grep signals_published
        - Verificar logs de publicaÃ§Ã£o
        
  health_checks:
    service_health:
      endpoint: GET /health
      expected_response: |
        {
          "status": "healthy",
          "version": "1.0.0",
          "components": {
            "http_server": "running",
            "kafka": "connected",
            "redis": "connected",
            "database": "connected"
          },
          "sources": {
            "tradingview": "enabled",
            "discord_bot": "disabled",
            "custom_alert": "enabled",
            "generic": "enabled"
          }
        }


# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ 13. ADICIONANDO NOVA FONTE                                   â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

adding_new_source:
  description: Guia para adicionar suporte a nova fonte de webhook
  
  steps:
    - step: 1
      title: Criar configuraÃ§Ã£o da fonte
      action: Criar config/sources/nova_fonte.yaml
      content: |
        enabled: true
        auth_method: token  # ou hmac, api_key, ip_whitelist
        token: ${NOVA_FONTE_TOKEN}
        rate_limit_requests: 50
        rate_limit_window_seconds: 60
        confidence: 0.75
        
    - step: 2
      title: Criar JSON Schema (opcional)
      action: Criar config/schemas/nova_fonte_schema.json
      content: |
        {
          "type": "object",
          "required": ["symbol", "side", "price"],
          "properties": {
            "symbol": {"type": "string"},
            "side": {"type": "string", "enum": ["BUY", "SELL"]},
            "price": {"type": "number"}
          }
        }
        
    - step: 3
      title: Implementar Normalizer
      action: Criar src/application/normalizers/nova_fonte.rs
      code_structure: |
        pub struct NovaFonteNormalizer;
        
        impl WebhookNormalizer for NovaFonteNormalizer {
            fn normalize(&self, payload: Value) -> Result<SignalDTO> {
                // Mapear campos especÃ­ficos da fonte
                // para SignalDTO padrÃ£o
            }
            
            fn source_name(&self) -> &str {
                "nova_fonte"
            }
            
            fn default_confidence(&self) -> f64 {
                0.75
            }
        }
        
    - step: 4
      title: Criar Handler HTTP
      action: Criar src/presentation/http/handlers/nova_fonte_handler.rs
      code_structure: |
        pub async fn handle_nova_fonte_webhook(
            State(state): State<AppState>,
            Json(payload): Json<Value>,
        ) -> Result<Json<WebhookResponse>> {
            // Validar, normalizar, publicar
        }
        
    - step: 5
      title: Adicionar rota
      action: Editar src/presentation/http/router.rs
      code: |
        .route("/webhook/nova_fonte", 
               post(nova_fonte_handler::handle_nova_fonte_webhook))
        
    - step: 6
      title: Registrar normalizer
      action: Editar src/main.rs (bootstrap)
      code: |
        let normalizers = HashMap::from([
            ("tradingview", Box::new(TradingViewNormalizer)),
            ("nova_fonte", Box::new(NovaFonteNormalizer)),
        ]);
        
    - step: 7
      title: Testar
      action: Enviar webhook de teste
      command: |
        curl -X POST http://localhost:8080/webhook/nova_fonte \
          -H "Authorization: Bearer token" \
          -H "Content-Type: application/json" \
          -d '{"symbol":"BTCUSDT","side":"BUY","price":45000}'


# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ 14. ROADMAP & MELHORIAS FUTURAS                              â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

roadmap:
  v1_0:
    status: Current
    features:
      - âœ… TradingView webhooks
      - âœ… Custom webhooks com HMAC
      - âœ… Rate limiting
      - âœ… Replay prevention
      - âœ… Schema validation
      - âœ… NormalizaÃ§Ã£o de payloads
      
  v1_1:
    planned_features:
      - Discord bot webhooks
      - Telegram bot webhooks
      - Webhook retry (se falhar publicaÃ§Ã£o)
      - Webhook scheduling (delay de publicaÃ§Ã£o)
      - Filtering rules (filtrar sinais antes de publicar)
      
  v2_0:
    planned_features:
      - GraphQL API (alÃ©m de REST)
      - Webhook transformations (scripting)
      - A/B testing de fontes
      - Machine learning para detectar fontes suspeitas
      - Webhook chaining (webhook â†’ transform â†’ webhook)
      - Multi-tenancy (mÃºltiplos usuÃ¡rios/projetos)
      
  future_considerations:
    - WebSocket support (push de sinais)
    - Bidirectional webhooks (resposta assÃ­ncrona)
    - Webhook marketplace (compartilhar normalizers)
    - Cloud functions integration
    - Edge deployment (Cloudflare Workers)


# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ 15. REFERÃŠNCIAS E DOCUMENTAÃ‡ÃƒO                               â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

references:
  webhook_guides:
    tradingview:
      - name: TradingView Alerts & Webhooks
        url: https://www.tradingview.com/support/solutions/43000529348-i-want-to-know-more-about-webhooks/
        
    discord:
      - name: Discord Webhooks
        url: https://discord.com/developers/docs/resources/webhook
        
  rust_libraries:
    - name: Axum
      url: https://docs.rs/axum
      description: Web framework
      
    - name: tower-http
      url: https://docs.rs/tower-http
      description: HTTP middlewares
      
    - name: jsonschema
      url: https://docs.rs/jsonschema
      description: JSON Schema validation
      
    - name: hmac + sha2
      url: https://docs.rs/hmac
      description: HMAC signature validation
      
  security:
    - HMAC Authentication
    - Replay Attack Prevention
    - Rate Limiting Algorithms (Token Bucket, Sliding Window)
    - OWASP API Security
    
  architecture_patterns:
    - Event-Driven Architecture
    - Hexagonal Architecture (Ports & Adapters)
    - Plugin Architecture
    - Domain-Driven Design (DDD)


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# FIM DO PROJECT MAP
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
