# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# CRYPTO-MANAGEMENT - PROJECT MAP
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Sistema central de orquestraÃ§Ã£o e gerenciamento de trading
# Linguagem: Rust
# VersÃ£o: 1.0.0
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ 1. OVERVIEW DO PROJETO                                      â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

project:
  name: crypto-management
  description: |
    ServiÃ§o central responsÃ¡vel por orquestrar todo o sistema de trading.
    Atua como o "cÃ©rebro" do sistema, coordenando componentes, gerenciando
    estado central, aplicando risk management, e controlando estratÃ©gias.
    
    CaracterÃ­sticas principais:
    - OrquestraÃ§Ã£o central de componentes
    - Gerenciamento de posiÃ§Ãµes (abertas/fechadas)
    - Auto-discovery de assets (detecta trades manuais)
    - Risk management central (limites, drawdown, exposiÃ§Ã£o)
    - Controle de estratÃ©gias (enable/disable, configuraÃ§Ã£o)
    - Controle de modo de operaÃ§Ã£o (PAPER/LIVE/DRY_RUN)
    - CÃ¡lculo de P&L em tempo real
    - Monitoramento de saÃºde do sistema
    - Estado centralizado e source of truth
    - Dashboard e APIs de controle

  language: Rust
  async_runtime: tokio
  message_broker: Kafka (rdkafka)
  database: Postgres (repositÃ³rio central)
  cache: Redis (estado em tempo real)
  
  responsibilities:
    - Orquestrar componentes do sistema
    - Gerenciar posiÃ§Ãµes (tracking, P&L)
    - Detectar trades manuais (auto-discovery)
    - Aplicar risk management central
    - Controlar subscriÃ§Ãµes de assets (crypto-listener)
    - Gerenciar estratÃ©gias (enable/disable, params)
    - Controlar modo de operaÃ§Ã£o (PAPER/LIVE)
    - Calcular mÃ©tricas globais (drawdown, exposiÃ§Ã£o)
    - Prover APIs de consulta e controle
    - Manter estado centralizado do sistema
    - Coordenar shutdown graceful


# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ 2. ARQUITETURA                                               â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

architecture:
  pattern: Event-Driven + Hexagonal Architecture + DDD + CQRS
  role: Central Orchestrator (Brain of the System)
  
  components:
    event_consumer:
      description: Consome eventos de mÃºltiplos tÃ³picos
      technology: rdkafka
      topics:
        - orders.events (crypto-trader)
        - signals.buy/sell (crypto-signals, crypto-webhook)
        - crypto-listener.prices (para auto-discovery)
      concurrency: Multi-threaded tokio tasks
      
    position_manager:
      description: Gerencia posiÃ§Ãµes abertas e fechadas
      features:
        - Tracking de posiÃ§Ãµes em tempo real
        - CÃ¡lculo de P&L (realizado e nÃ£o realizado)
        - DetecÃ§Ã£o de novas posiÃ§Ãµes (auto-discovery)
        - Fechamento de posiÃ§Ãµes
        - HistÃ³rico completo
      state: Redis (real-time) + Postgres (persistent)
      
    risk_manager:
      description: Aplica regras de risk management
      validations:
        - ExposiÃ§Ã£o por asset (max_exposure_per_asset)
        - ExposiÃ§Ã£o total (max_total_exposure)
        - Drawdown mÃ¡ximo (max_drawdown)
        - Loss diÃ¡rio (max_daily_loss)
        - NÃºmero de posiÃ§Ãµes (max_open_positions)
      enforcement: Rejeita sinais que violam regras
      
    auto_discovery:
      description: Detecta trades manuais na exchange
      methods:
        - User Data Stream (Binance WebSocket)
        - Polling de posiÃ§Ãµes (fallback)
        - ReconciliaÃ§Ã£o com ordens conhecidas
      actions:
        - Emite management.positions.opened
        - Emite crypto-listener.subscribe
        - Atribui estratÃ©gia (se configurado)
        
    strategy_controller:
      description: Controla estratÃ©gias ativas
      features:
        - Enable/disable estratÃ©gias
        - Atualizar parÃ¢metros
        - Atribuir estratÃ©gias a symbols
        - Configurar confidence mÃ­nima
      commands: Publica em management.control.strategy
      
    mode_controller:
      description: Controla modo de operaÃ§Ã£o
      modes:
        - PAPER: simulaÃ§Ã£o completa
        - LIVE: execuÃ§Ã£o real
        - DRY_RUN: valida mas nÃ£o executa
      commands: Publica em management.control.mode
      
    pnl_calculator:
      description: Calcula P&L em tempo real
      metrics:
        - P&L realizado (posiÃ§Ãµes fechadas)
        - P&L nÃ£o realizado (posiÃ§Ãµes abertas)
        - P&L diÃ¡rio, semanal, mensal
        - Drawdown atual
        - Profit factor
        
    subscription_coordinator:
      description: Coordena subscriÃ§Ãµes de assets
      logic: |
        Quando posiÃ§Ã£o Ã© aberta â†’ subscribe no crypto-listener
        Quando posiÃ§Ã£o Ã© fechada â†’ unsubscribe
      topics:
        - crypto-listener.subscribe
        - crypto-listener.unsubscribe
        
    health_monitor:
      description: Monitora saÃºde de componentes
      checks:
        - Kafka connectivity
        - Database connectivity
        - Redis connectivity
        - Services responsiveness
      interval: 30 seconds
      
    command_handler:
      description: Processa comandos via API ou Kafka
      commands:
        - EnableStrategy, DisableStrategy
        - UpdateRiskLimits
        - ChangeMode
        - ClosePosition
        - EmergencyStop
        
    event_publisher:
      description: Publica eventos de gerenciamento
      topics:
        - management.positions.opened
        - management.positions.closed
        - management.positions.updated
        - management.control.strategy
        - management.control.risk
        - management.control.mode
        
    metrics:
      description: Coleta mÃ©tricas
      technology: Prometheus (rust-prometheus)
      
  data_flow: |
    [External Events] â†’ Event Consumer â†’ Position Manager â†’ Risk Manager â†’ 
                                           â†“
                                    Auto Discovery â† [Exchange User Data]
                                           â†“
                                    Strategy Controller
                                           â†“
                                    Event Publisher â†’ Kafka
                                           â†“
                                    State Store (Redis + Postgres)
                                           â†“
                                    Metrics


# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ 3. TÃ“PICOS KAFKA                                             â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

kafka_topics:
  consumed:
    - name: orders.events
      description: Eventos de ordens do crypto-trader
      producer: crypto-trader
      
      event_types:
        - CREATED: ordem criada
        - FILLED: ordem executada completamente
        - PARTIAL_FILL: ordem parcialmente executada
        - CANCELLED: ordem cancelada
        - REJECTED: ordem rejeitada
        
      use_case: |
        - FILLED â†’ Atualizar posiÃ§Ã£o ou criar nova
        - REJECTED â†’ Registrar falha, atualizar mÃ©tricas
        
    - name: signals.buy
      description: Sinais de compra
      producers: [crypto-signals, crypto-webhook]
      
      use_case: |
        - Validar contra risk limits
        - Aprovar ou rejeitar
        - Se aprovado: encaminhar para crypto-trader
        
    - name: signals.sell
      description: Sinais de venda
      producers: [crypto-signals, crypto-webhook]
      
      use_case: Similar a signals.buy
      
    - name: crypto-listener.prices
      description: PreÃ§os em tempo real (para P&L nÃ£o realizado)
      producer: crypto-listener
      
      use_case: |
        - Atualizar P&L de posiÃ§Ãµes abertas
        - Detectar quando asset nÃ£o subscrito ainda tem posiÃ§Ã£o

  produced:
    - name: management.positions.opened
      description: Nova posiÃ§Ã£o foi aberta
      consumers: [crypto-signals, crypto-notifications]
      
      schema:
        position_id: UUID
        symbol: string
        side: enum [LONG, SHORT]
        quantity: number
        entry_price: number
        source: enum [manual, automated]
        strategy_assigned: optional string
        timestamp: ISO8601
        
      example_payload: |
        {
          "position_id": "550e8400-e29b-41d4-a716-446655440000",
          "symbol": "BTCUSDT",
          "side": "LONG",
          "quantity": 0.01,
          "entry_price": 45000.00,
          "source": "manual",
          "strategy_assigned": "RSI_DIVERGENCE",
          "timestamp": "2025-10-16T22:00:00Z"
        }
        
    - name: management.positions.closed
      description: PosiÃ§Ã£o foi fechada
      consumers: [crypto-notifications]
      
      schema:
        position_id: UUID
        symbol: string
        exit_price: number
        pnl: number (valor absoluto)
        pnl_percent: number
        duration: string (formato: "2h 30m")
        reason: enum [strategy, manual, stop_loss, take_profit, emergency]
        timestamp: ISO8601
        
      example_payload: |
        {
          "position_id": "550e8400-...",
          "symbol": "BTCUSDT",
          "exit_price": 47000.00,
          "pnl": 20.00,
          "pnl_percent": 4.44,
          "duration": "2h 30m",
          "reason": "strategy",
          "timestamp": "2025-10-17T00:30:00Z"
        }
        
    - name: management.positions.updated
      description: P&L de posiÃ§Ã£o atualizado
      consumers: [crypto-notifications]
      frequency: ConfigurÃ¡vel (ex: a cada 1% de variaÃ§Ã£o)
      
      schema:
        position_id: UUID
        symbol: string
        unrealized_pnl: number
        current_price: number
        pnl_percent: number
        
    - name: management.control.strategy
      description: Comandos de controle de estratÃ©gias
      consumers: [crypto-signals, crypto-trader]
      
      schema:
        action: enum [ENABLE, DISABLE, UPDATE_PARAMS]
        strategy: string
        symbols: array ou "ALL"
        params: optional object
        
      example_payload: |
        {
          "action": "ENABLE",
          "strategy": "RSI_DIVERGENCE",
          "symbols": ["BTCUSDT", "ETHUSDT"],
          "params": {
            "rsi_period": 14,
            "oversold": 30
          }
        }
        
    - name: management.control.risk
      description: AtualizaÃ§Ã£o de parÃ¢metros de risco
      consumers: [crypto-trader]
      
      schema:
        action: enum [UPDATE_LIMITS, HALT_TRADING, RESUME_TRADING]
        max_exposure_per_asset: optional number
        max_total_exposure: optional number
        max_daily_loss: optional number
        max_drawdown: optional number
        
    - name: management.control.mode
      description: MudanÃ§a de modo de operaÃ§Ã£o
      consumers: [crypto-trader]
      
      schema:
        mode: enum [PAPER, LIVE, DRY_RUN]
        timestamp: ISO8601
        
    - name: crypto-listener.subscribe
      description: Solicita subscriÃ§Ã£o de asset
      consumers: [crypto-listener]
      
      schema:
        symbol: string
        source: enum [position_opened, manual, strategy]
        priority: enum [high, normal]
        
    - name: crypto-listener.unsubscribe
      description: Solicita cancelamento de subscriÃ§Ã£o
      consumers: [crypto-listener]
      
      schema:
        symbol: string
        reason: enum [position_closed, manual]


# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ 4. MAPA DE PASTAS                                            â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

project_structure:
  description: Estrutura completa do projeto com descriÃ§Ã£o de cada mÃ³dulo
  architecture_layers: |
    Presentation â†’ Application â†’ Domain
                       â†“
                Infrastructure
    
    - Domain: nÃ£o depende de ninguÃ©m (nÃºcleo puro)
    - Application: depende apenas de Domain
    - Infrastructure: implementa contratos de Application
    - Presentation: usa Application e injeta Infrastructure via DI
    
  structure: |
    crypto-management/
    â”œâ”€â”€ src/
    â”‚   â”œâ”€â”€ main.rs                          # Entry point: bootstrap do app (config, consumers, orchestration, HTTP server)
    â”‚   â”œâ”€â”€ lib.rs                           # Biblioteca pÃºblica expondo mÃ³dulos principais
    â”‚   â”‚
    â”‚   â”œâ”€â”€ domain/                          # â­ Camada de DomÃ­nio (regras de negÃ³cio puras, sem I/O)
    â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â”œâ”€â”€ errors.rs                    # Erros de domÃ­nio (RiskViolationError, PositionError)
    â”‚   â”‚   â”œâ”€â”€ aggregates/                  # Agregados DDD
    â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â”‚   â”œâ”€â”€ position.rs              # PositionAggregate (calcula P&L, valida)
    â”‚   â”‚   â”‚   â”œâ”€â”€ portfolio.rs             # PortfolioAggregate (gerencia todas posiÃ§Ãµes)
    â”‚   â”‚   â”‚   â”œâ”€â”€ risk_profile.rs          # RiskProfileAggregate (limites, drawdown)
    â”‚   â”‚   â”‚   â””â”€â”€ system_state.rs          # SystemStateAggregate (modo, health)
    â”‚   â”‚   â”œâ”€â”€ entities/                    # Entidades de domÃ­nio
    â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â”‚   â”œâ”€â”€ position.rs              # Entidade Position
    â”‚   â”‚   â”‚   â”œâ”€â”€ trade.rs                 # Entidade Trade (entrada ou saÃ­da)
    â”‚   â”‚   â”‚   â”œâ”€â”€ asset_subscription.rs    # Entidade AssetSubscription
    â”‚   â”‚   â”‚   â””â”€â”€ strategy_config.rs       # Entidade StrategyConfig
    â”‚   â”‚   â”œâ”€â”€ events/                      # Domain events
    â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â”‚   â”œâ”€â”€ position_events.rs       # PositionOpened, PositionClosed, PositionUpdated
    â”‚   â”‚   â”‚   â”œâ”€â”€ portfolio_events.rs      # PortfolioRebalanced, DrawdownReached
    â”‚   â”‚   â”‚   â”œâ”€â”€ risk_events.rs           # RiskLimitUpdated, RiskViolated
    â”‚   â”‚   â”‚   â””â”€â”€ system_events.rs         # ModeChanged, StrategyEnabled
    â”‚   â”‚   â”œâ”€â”€ repositories/                # Traits de repositÃ³rios (contratos)
    â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â”‚   â”œâ”€â”€ position_repository.rs   # Contrato para persistir posiÃ§Ãµes
    â”‚   â”‚   â”‚   â”œâ”€â”€ portfolio_repository.rs  # Contrato para portfolio
    â”‚   â”‚   â”‚   â””â”€â”€ system_state_repository.rs # Contrato para estado do sistema
    â”‚   â”‚   â”œâ”€â”€ services/                    # ServiÃ§os de domÃ­nio
    â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â”‚   â”œâ”€â”€ pnl_calculator.rs        # Calcula P&L (realizado, nÃ£o realizado)
    â”‚   â”‚   â”‚   â”œâ”€â”€ risk_validator.rs        # Valida contra regras de risco
    â”‚   â”‚   â”‚   â”œâ”€â”€ drawdown_calculator.rs   # Calcula drawdown
    â”‚   â”‚   â”‚   â”œâ”€â”€ exposure_calculator.rs   # Calcula exposiÃ§Ã£o
    â”‚   â”‚   â”‚   â””â”€â”€ position_matcher.rs      # Matcha ordens com posiÃ§Ãµes
    â”‚   â”‚   â””â”€â”€ value_objects/               # Value objects
    â”‚   â”‚       â”œâ”€â”€ mod.rs
    â”‚   â”‚       â”œâ”€â”€ position_id.rs           # VO PositionId (UUID)
    â”‚   â”‚       â”œâ”€â”€ symbol.rs                # VO Symbol
    â”‚   â”‚       â”œâ”€â”€ position_side.rs         # VO PositionSide (LONG, SHORT)
    â”‚   â”‚       â”œâ”€â”€ position_status.rs       # VO PositionStatus (OPEN, CLOSED)
    â”‚   â”‚       â”œâ”€â”€ pnl.rs                   # VO PnL (valor + percentual)
    â”‚   â”‚       â”œâ”€â”€ exposure.rs              # VO Exposure (por asset, total)
    â”‚   â”‚       â”œâ”€â”€ drawdown.rs              # VO Drawdown
    â”‚   â”‚       â””â”€â”€ operation_mode.rs        # VO OperationMode (PAPER, LIVE, DRY_RUN)
    â”‚   â”‚
    â”‚   â”œâ”€â”€ application/                     # â­ Camada de AplicaÃ§Ã£o (casos de uso, orquestraÃ§Ã£o)
    â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â”œâ”€â”€ dtos/                        # Data Transfer Objects
    â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â”‚   â”œâ”€â”€ commands.rs              # Command DTOs (OpenPositionCommand, ClosePositionCommand)
    â”‚   â”‚   â”‚   â”œâ”€â”€ position_dto.rs          # DTO para posiÃ§Ãµes
    â”‚   â”‚   â”‚   â”œâ”€â”€ portfolio_dto.rs         # DTO para portfolio
    â”‚   â”‚   â”‚   â”œâ”€â”€ risk_status_dto.rs       # DTO para status de risco
    â”‚   â”‚   â”‚   â”œâ”€â”€ requests.rs              # HTTP request DTOs
    â”‚   â”‚   â”‚   â””â”€â”€ responses.rs             # HTTP response DTOs
    â”‚   â”‚   â”œâ”€â”€ ports/                       # âš¡ Ports (interfaces/contratos para adapters)
    â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â”‚   â”œâ”€â”€ event_consumer_port.rs   # Contrato para consumir eventos (Kafka)
    â”‚   â”‚   â”‚   â”œâ”€â”€ event_publisher_port.rs  # Contrato para publicar eventos
    â”‚   â”‚   â”‚   â”œâ”€â”€ position_store_port.rs   # Contrato para armazenar posiÃ§Ãµes
    â”‚   â”‚   â”‚   â”œâ”€â”€ portfolio_store_port.rs  # Contrato para portfolio
    â”‚   â”‚   â”‚   â”œâ”€â”€ exchange_client_port.rs  # Contrato para consultar exchange
    â”‚   â”‚   â”‚   â”œâ”€â”€ price_stream_port.rs     # Contrato para stream de preÃ§os
    â”‚   â”‚   â”‚   â””â”€â”€ state_cache_port.rs      # Contrato para cache de estado (Redis)
    â”‚   â”‚   â”œâ”€â”€ orchestrators/               # Orquestradores de casos de uso complexos
    â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â”‚   â”œâ”€â”€ position_orchestrator.rs # Orquestra: open â†’ subscribe â†’ notify
    â”‚   â”‚   â”‚   â”œâ”€â”€ auto_discovery_orchestrator.rs # Orquestra detecÃ§Ã£o de trades manuais
    â”‚   â”‚   â”‚   â”œâ”€â”€ risk_orchestrator.rs     # Orquestra validaÃ§Ã£o de risco
    â”‚   â”‚   â”‚   â””â”€â”€ shutdown_orchestrator.rs # Orquestra shutdown graceful
    â”‚   â”‚   â”œâ”€â”€ queries/                     # Queries (CQRS read-side)
    â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â”‚   â”œâ”€â”€ get_portfolio_summary.rs # Query: resumo de portfolio
    â”‚   â”‚   â”‚   â”œâ”€â”€ get_active_positions.rs  # Query: posiÃ§Ãµes abertas
    â”‚   â”‚   â”‚   â”œâ”€â”€ get_pnl_history.rs       # Query: histÃ³rico de P&L
    â”‚   â”‚   â”‚   â”œâ”€â”€ get_risk_status.rs       # Query: status de risco
    â”‚   â”‚   â”‚   â””â”€â”€ get_system_health.rs     # Query: saÃºde do sistema
    â”‚   â”‚   â””â”€â”€ services/                    # Application services (casos de uso)
    â”‚   â”‚       â”œâ”€â”€ mod.rs
    â”‚   â”‚       â”œâ”€â”€ position_service.rs      # Caso de uso: gerenciar posiÃ§Ãµes
    â”‚   â”‚       â”œâ”€â”€ portfolio_service.rs     # Caso de uso: gerenciar portfolio
    â”‚   â”‚       â”œâ”€â”€ risk_service.rs          # Caso de uso: gerenciar risco
    â”‚   â”‚       â”œâ”€â”€ strategy_service.rs      # Caso de uso: controlar estratÃ©gias
    â”‚   â”‚       â””â”€â”€ system_service.rs        # Caso de uso: controlar sistema
    â”‚   â”‚
    â”‚   â”œâ”€â”€ infrastructure/                  # â­ Camada de Infraestrutura (implementaÃ§Ãµes tÃ©cnicas)
    â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â”œâ”€â”€ bootstrap/                   # InicializaÃ§Ã£o de componentes
    â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â”‚   â”œâ”€â”€ database.rs              # Setup de conexÃ£o Postgres + migrations
    â”‚   â”‚   â”‚   â”œâ”€â”€ redis.rs                 # Setup de conexÃ£o Redis
    â”‚   â”‚   â”‚   â”œâ”€â”€ kafka_consumer.rs        # Inicializa consumers Kafka (mÃºltiplos tÃ³picos)
    â”‚   â”‚   â”‚   â”œâ”€â”€ kafka_publisher.rs       # Inicializa publisher Kafka
    â”‚   â”‚   â”‚   â””â”€â”€ exchange_client.rs       # Inicializa cliente da exchange
    â”‚   â”‚   â”œâ”€â”€ config/                      # ConfiguraÃ§Ã£o e settings
    â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â”‚   â”œâ”€â”€ settings.rs              # Struct Settings + carregamento de env vars
    â”‚   â”‚   â”‚   â”œâ”€â”€ risk_config.rs           # ConfiguraÃ§Ãµes de risco
    â”‚   â”‚   â”‚   â””â”€â”€ strategy_config.rs       # ConfiguraÃ§Ãµes de estratÃ©gias
    â”‚   â”‚   â”œâ”€â”€ messaging/                   # Messaging
    â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â”‚   â”œâ”€â”€ kafka_multi_consumer.rs  # Consumer de mÃºltiplos tÃ³picos
    â”‚   â”‚   â”‚   â”œâ”€â”€ kafka_event_publisher.rs # Publisher de eventos
    â”‚   â”‚   â”‚   â”œâ”€â”€ order_event_handler.rs   # Handler de eventos de ordem
    â”‚   â”‚   â”‚   â”œâ”€â”€ signal_event_handler.rs  # Handler de eventos de sinal
    â”‚   â”‚   â”‚   â””â”€â”€ price_event_handler.rs   # Handler de eventos de preÃ§o
    â”‚   â”‚   â”œâ”€â”€ auto_discovery/              # Auto-discovery de posiÃ§Ãµes
    â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â”‚   â”œâ”€â”€ user_data_stream.rs      # WebSocket user data da exchange
    â”‚   â”‚   â”‚   â”œâ”€â”€ position_detector.rs     # Detecta novas posiÃ§Ãµes
    â”‚   â”‚   â”‚   â””â”€â”€ reconciliation.rs        # Reconcilia posiÃ§Ãµes conhecidas vs exchange
    â”‚   â”‚   â”œâ”€â”€ persistence/                 # PersistÃªncia
    â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â”‚   â”œâ”€â”€ postgres_position_repository.rs  # Store de posiÃ§Ãµes
    â”‚   â”‚   â”‚   â”œâ”€â”€ postgres_portfolio_repository.rs # Store de portfolio
    â”‚   â”‚   â”‚   â”œâ”€â”€ postgres_system_state_repository.rs # Store de estado do sistema
    â”‚   â”‚   â”‚   â”œâ”€â”€ redis_state_cache.rs     # Cache de estado (posiÃ§Ãµes, portfolio)
    â”‚   â”‚   â”‚   â””â”€â”€ redis_subscription_store.rs # Store de subscriÃ§Ãµes ativas
    â”‚   â”‚   â”œâ”€â”€ exchange/                    # IntegraÃ§Ã£o com exchange
    â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â”‚   â”œâ”€â”€ binance_client.rs        # Cliente Binance (query positions, balances)
    â”‚   â”‚   â”‚   â””â”€â”€ exchange_adapter.rs      # Adapter genÃ©rico
    â”‚   â”‚   â”œâ”€â”€ risk/                        # Risk management
    â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â”‚   â”œâ”€â”€ risk_validator.rs        # Validador de risco
    â”‚   â”‚   â”‚   â””â”€â”€ risk_monitor.rs          # Monitor contÃ­nuo de risco
    â”‚   â”‚   â”œâ”€â”€ metrics/                     # MÃ©tricas e observabilidade
    â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â”‚   â””â”€â”€ prometheus_metrics.rs    # Registra mÃ©tricas Prometheus
    â”‚   â”‚   â”œâ”€â”€ shutdown/                    # Shutdown graceful
    â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â”‚   â”œâ”€â”€ graceful.rs              # Coordena shutdown de todos componentes
    â”‚   â”‚   â”‚   â””â”€â”€ signal_handler.rs        # Captura sinais SIGTERM/SIGINT
    â”‚   â”‚   â””â”€â”€ startup/                     # Startup do aplicativo
    â”‚   â”‚       â”œâ”€â”€ mod.rs
    â”‚   â”‚       â”œâ”€â”€ banner.rs                # Banner ASCII no console
    â”‚   â”‚       â”œâ”€â”€ health.rs                # Health checks
    â”‚   â”‚       â””â”€â”€ logging.rs               # Setup de logs (tracing-subscriber)
    â”‚   â”‚
    â”‚   â”œâ”€â”€ presentation/                    # â­ Camada de ApresentaÃ§Ã£o (HTTP REST API, WebSocket futuro)
    â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â””â”€â”€ http/                        # HTTP REST API (Axum)
    â”‚   â”‚       â”œâ”€â”€ mod.rs
    â”‚   â”‚       â”œâ”€â”€ router.rs                # DefiniÃ§Ã£o de rotas (endpoints)
    â”‚   â”‚       â”œâ”€â”€ responses.rs             # Helpers de resposta (ApiResponse, ErrorResponse)
    â”‚   â”‚       â”œâ”€â”€ controllers/             # Controllers HTTP
    â”‚   â”‚       â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚       â”‚   â”œâ”€â”€ position_controller.rs   # GET/POST positions, close, etc.
    â”‚   â”‚       â”‚   â”œâ”€â”€ portfolio_controller.rs  # GET portfolio summary, stats
    â”‚   â”‚       â”‚   â”œâ”€â”€ risk_controller.rs       # GET risk status, PUT update limits
    â”‚   â”‚       â”‚   â”œâ”€â”€ strategy_controller.rs   # POST enable/disable, PUT params
    â”‚   â”‚       â”‚   â”œâ”€â”€ system_controller.rs     # POST mode, emergency stop
    â”‚   â”‚       â”‚   â””â”€â”€ health_controller.rs     # GET health, metrics
    â”‚   â”‚       â””â”€â”€ middleware/              # Middlewares HTTP
    â”‚   â”‚           â”œâ”€â”€ mod.rs
    â”‚   â”‚           â”œâ”€â”€ auth_middleware.rs   # AutenticaÃ§Ã£o (futuro)
    â”‚   â”‚           â””â”€â”€ request_logger.rs    # Log de requests HTTP
    â”‚   â”‚
    â”‚   â””â”€â”€ shared/                          # â­ Shared Kernel (cÃ³digo transversal)
    â”‚       â”œâ”€â”€ mod.rs
    â”‚       â”œâ”€â”€ errors.rs                    # Erros compartilhados (ApplicationError, InfrastructureError)
    â”‚       â”œâ”€â”€ types.rs                     # Tipos compartilhados (EventEnvelope, Timestamp, etc.)
    â”‚       â”œâ”€â”€ traits/                      # Traits comuns
    â”‚       â”‚   â”œâ”€â”€ mod.rs
    â”‚       â”‚   â””â”€â”€ aggregate_root.rs        # Trait AggregateRoot
    â”‚       â””â”€â”€ utils/                       # UtilitÃ¡rios
    â”‚           â”œâ”€â”€ mod.rs
    â”‚           â”œâ”€â”€ datetime.rs              # Helpers de data/hora
    â”‚           â”œâ”€â”€ decimal.rs               # Helpers para aritmÃ©tica decimal (P&L, preÃ§os)
    â”‚           â””â”€â”€ validation.rs            # ValidaÃ§Ãµes genÃ©ricas
    â”‚
    â”œâ”€â”€ config/                              # ğŸ“ ConfiguraÃ§Ãµes externas
    â”‚   â”œâ”€â”€ development.yaml                 # Config para ambiente dev
    â”‚   â”œâ”€â”€ production.yaml                  # Config para ambiente prod
    â”‚   â””â”€â”€ risk_profiles/                   # Perfis de risco prÃ©-definidos
    â”‚       â”œâ”€â”€ conservative.yaml            # Perfil conservador
    â”‚       â”œâ”€â”€ moderate.yaml                # Perfil moderado
    â”‚       â””â”€â”€ aggressive.yaml              # Perfil agressivo
    â”‚
    â”œâ”€â”€ migrations/                          # ğŸ“Š MigraÃ§Ãµes de banco (Flyway)
    â”‚   â”œâ”€â”€ V001__initial_schema.sql         # Schema inicial (positions, portfolio, system_state)
    â”‚   â”œâ”€â”€ V002__strategy_configs.sql       # Tabela de configuraÃ§Ãµes de estratÃ©gias
    â”‚   â”œâ”€â”€ V003__risk_limits.sql            # Tabela de limites de risco
    â”‚   â”œâ”€â”€ V004__pnl_snapshots.sql          # Tabela de snapshots de P&L
    â”‚   â””â”€â”€ V005__indexes.sql                # Ãndices para performance
    â”‚
    â”œâ”€â”€ docs/                                # ğŸ“š DocumentaÃ§Ã£o tÃ©cnica
    â”‚   â”œâ”€â”€ README.md                        # Ãndice de documentaÃ§Ã£o
    â”‚   â”œâ”€â”€ ARCHITECTURE.md                  # Detalhes da arquitetura
    â”‚   â”œâ”€â”€ RISK_MANAGEMENT.md               # DocumentaÃ§Ã£o de risk management
    â”‚   â”œâ”€â”€ AUTO_DISCOVERY.md                # Guia de auto-discovery
    â”‚   â””â”€â”€ API.md                           # DocumentaÃ§Ã£o da API REST
    â”‚
    â”œâ”€â”€ Cargo.toml                           # ConfiguraÃ§Ã£o Rust (deps, features)
    â”œâ”€â”€ Cargo.lock                           # Lock file de dependÃªncias
    â”œâ”€â”€ Dockerfile                           # Build multi-stage production
    â”œâ”€â”€ docker-compose.yml                   # Stack completa (app, Kafka, Postgres, Redis)
    â”œâ”€â”€ Makefile                             # Comandos make (build, test, docker)
    â”œâ”€â”€ crypto-management_projectmap.yaml    # Este arquivo (documentaÃ§Ã£o estruturada)
    â””â”€â”€ README.md                            # DocumentaÃ§Ã£o principal do projeto
    
  conventions:
    domain_layer:
      description: Camada de DomÃ­nio (domain/)
      rules:
        - âœ… Sem dependÃªncias de infraestrutura
        - âœ… LÃ³gica de negÃ³cio pura (P&L, risk validation, etc.)
        - âœ… Aggregates aplicam eventos e validam invariantes
        - âœ… Value objects imutÃ¡veis com validaÃ§Ã£o
        - âœ… Services de domÃ­nio para lÃ³gica cross-aggregate
        - âœ… Repositories como traits (contratos apenas)
        
    application_layer:
      description: Camada de AplicaÃ§Ã£o (application/)
      rules:
        - âœ… Define Ports (interfaces) que infraestrutura implementa
        - âœ… Orquestra casos de uso complexos (via orchestrators)
        - âœ… DTOs para comunicaÃ§Ã£o entre camadas
        - âœ… Queries para read-side (CQRS)
        - âœ… Services orquestram mÃºltiplos agregados/ports
        - âœ… NÃ£o conhece detalhes de implementaÃ§Ã£o
        
    infrastructure_layer:
      description: Camada de Infraestrutura (infrastructure/)
      rules:
        - âœ… Implementa Adapters (Kafka, Postgres, Redis, Binance)
        - âœ… Bootstrap e configuraÃ§Ã£o
        - âœ… Messaging (multi-consumer/publisher)
        - âœ… Auto-discovery (user data stream)
        - âœ… Persistence (Postgres + Redis cache)
        - âœ… Shutdown graceful coordenado
        - âœ… Startup e health checks
        
    presentation_layer:
      description: Camada de ApresentaÃ§Ã£o (presentation/)
      rules:
        - âœ… HTTP REST API (Axum)
        - âœ… Controllers e routers
        - âœ… ConversÃ£o DTOs <-> JSON
        - âœ… Middlewares (logging, auth futuro)
        - âœ… NÃ£o contÃ©m lÃ³gica de negÃ³cio
        - âœ… Apenas coordena chamadas Ã  Application
        
    shared_kernel:
      description: Shared Kernel (shared/)
      rules:
        - âœ… CÃ³digo compartilhado entre camadas
        - âœ… Traits comuns (AggregateRoot)
        - âœ… Tipos transversais (EventEnvelope)
        - âœ… UtilitÃ¡rios (datetime, decimal, validaÃ§Ã£o)
        - âœ… Erros compartilhados


# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ 5. GERENCIAMENTO DE POSIÃ‡Ã•ES                                 â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

position_management:
  concept: |
    O crypto-management Ã© o source of truth para posiÃ§Ãµes. MantÃ©m
    registro de todas as posiÃ§Ãµes abertas e fechadas, calcula P&L
    em tempo real, e coordena subscriÃ§Ãµes de assets.
    
  position_lifecycle:
    states:
      - OPENING: Ordem de entrada sendo processada
      - OPEN: PosiÃ§Ã£o aberta e ativa
      - CLOSING: Ordem de saÃ­da sendo processada
      - CLOSED: PosiÃ§Ã£o fechada
      
    transitions:
      - step: 1
        state: N/A â†’ OPENING
        trigger: Order event (CREATED) de ordem de entrada
        
      - step: 2
        state: OPENING â†’ OPEN
        trigger: Order event (FILLED) de ordem de entrada
        actions:
          - Cria Position entity
          - Calcula entry_price mÃ©dio
          - Emite management.positions.opened
          - Emite crypto-listener.subscribe
          - Atribui estratÃ©gia (se configurado)
          
      - step: 3
        state: OPEN â†’ CLOSING
        trigger: Order event (CREATED) de ordem de saÃ­da
        
      - step: 4
        state: CLOSING â†’ CLOSED
        trigger: Order event (FILLED) de ordem de saÃ­da
        actions:
          - Calcula P&L final
          - Calcula duraÃ§Ã£o
          - Emite management.positions.closed
          - Emite crypto-listener.unsubscribe
          - Atualiza mÃ©tricas
          
  position_structure:
    fields:
      - position_id: UUID
      - symbol: string (ex: "BTCUSDT")
      - side: enum [LONG, SHORT]
      - quantity: decimal
      - entry_price: decimal (preÃ§o mÃ©dio de entrada)
      - current_price: decimal (atualizado em tempo real)
      - exit_price: optional decimal (quando fechada)
      - realized_pnl: decimal (quando fechada)
      - unrealized_pnl: decimal (enquanto aberta)
      - pnl_percent: decimal
      - status: enum [OPENING, OPEN, CLOSING, CLOSED]
      - source: enum [manual, automated]
      - strategy: optional string (estratÃ©gia atribuÃ­da)
      - opened_at: timestamp
      - closed_at: optional timestamp
      - duration: optional duration
      - stop_loss_price: optional decimal
      - take_profit_price: optional decimal
      - entry_order_ids: array of order IDs
      - exit_order_ids: array of order IDs
      
  pnl_calculation:
    unrealized_pnl:
      description: P&L de posiÃ§Ãµes abertas
      formula_long: (current_price - entry_price) * quantity
      formula_short: (entry_price - current_price) * quantity
      update_frequency: A cada price update
      
    realized_pnl:
      description: P&L de posiÃ§Ãµes fechadas
      formula_long: (exit_price - entry_price) * quantity - commissions
      formula_short: (entry_price - exit_price) * quantity - commissions
      
    portfolio_pnl:
      total_unrealized: Soma de unrealized_pnl de todas posiÃ§Ãµes abertas
      total_realized: Soma de realized_pnl de todas posiÃ§Ãµes fechadas (perÃ­odo)
      daily_pnl: total_realized do dia atual + total_unrealized
      
  position_tracking:
    in_memory:
      description: Estado de posiÃ§Ãµes abertas (Redis)
      key_pattern: "position:{symbol}"
      ttl: Infinito (removido ao fechar)
      
    persistent:
      description: HistÃ³rico completo (Postgres)
      table: positions
      indexed_by: [symbol, status, opened_at, closed_at]
      
  auto_update:
    description: AtualizaÃ§Ã£o automÃ¡tica de P&L
    trigger: Price update do crypto-listener.prices
    logic: |
      Se posiÃ§Ã£o aberta para symbol:
        - Atualiza current_price
        - Recalcula unrealized_pnl
        - Se variaÃ§Ã£o > threshold (ex: 1%):
          - Emite management.positions.updated
          - Atualiza cache (Redis)


# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ 6. RISK MANAGEMENT                                           â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

risk_management:
  concept: |
    O crypto-management Ã© o guardiÃ£o de risco central. Valida todos
    os sinais contra regras de risco antes de permitir execuÃ§Ã£o.
    
  risk_limits:
    max_exposure_per_asset:
      description: ExposiÃ§Ã£o mÃ¡xima por asset
      unit: USDT ou % do capital
      default: 1000 USDT
      calculation: Soma do valor de todas posiÃ§Ãµes abertas do asset
      validation: |
        current_exposure = SUM(position.quantity * position.entry_price WHERE symbol = X)
        new_exposure = current_exposure + (signal.quantity * signal.price)
        if new_exposure > max_exposure_per_asset â†’ REJECT
        
    max_total_exposure:
      description: ExposiÃ§Ã£o total mÃ¡xima
      unit: USDT ou % do capital
      default: 5000 USDT
      calculation: Soma do valor de todas posiÃ§Ãµes abertas
      validation: |
        total_exposure = SUM(position.quantity * position.entry_price FOR ALL positions)
        new_total = total_exposure + (signal.quantity * signal.price)
        if new_total > max_total_exposure â†’ REJECT
        
    max_drawdown:
      description: Drawdown mÃ¡ximo permitido
      unit: Percentual
      default: -20%
      calculation: |
        peak_balance = MÃ¡ximo balance histÃ³rico
        current_balance = Balance atual
        drawdown = (current_balance - peak_balance) / peak_balance
      validation: |
        if drawdown < max_drawdown â†’ HALT_TRADING
        
    max_daily_loss:
      description: Perda mÃ¡xima diÃ¡ria
      unit: USDT ou % do capital inicial do dia
      default: -500 USDT
      calculation: realized_pnl desde 00:00 UTC
      validation: |
        if daily_pnl < max_daily_loss â†’ HALT_TRADING (atÃ© prÃ³ximo dia)
      reset: DiÃ¡rio Ã s 00:00 UTC
      
    max_open_positions:
      description: NÃºmero mÃ¡ximo de posiÃ§Ãµes abertas
      unit: Contador
      default: 10
      validation: |
        if COUNT(positions WHERE status = OPEN) >= max_open_positions â†’ REJECT
        
  risk_profiles:
    conservative:
      max_exposure_per_asset: 500 USDT
      max_total_exposure: 2000 USDT
      max_drawdown: -10%
      max_daily_loss: -200 USDT
      max_open_positions: 5
      
    moderate:
      max_exposure_per_asset: 1000 USDT
      max_total_exposure: 5000 USDT
      max_drawdown: -20%
      max_daily_loss: -500 USDT
      max_open_positions: 10
      
    aggressive:
      max_exposure_per_asset: 2000 USDT
      max_total_exposure: 10000 USDT
      max_drawdown: -30%
      max_daily_loss: -1000 USDT
      max_open_positions: 15
      
  risk_validation_flow:
    description: ValidaÃ§Ã£o de sinal contra risk limits
    steps:
      - step: 1
        action: Receber sinal (signals.buy ou signals.sell)
        
      - step: 2
        action: Verificar modo de operaÃ§Ã£o
        logic: |
          if mode == HALT_TRADING â†’ REJECT (sistema pausado)
          
      - step: 3
        action: Verificar exposiÃ§Ã£o por asset
        logic: Calcular exposure atual + novo sinal
        
      - step: 4
        action: Verificar exposiÃ§Ã£o total
        logic: Calcular total exposure atual + novo sinal
        
      - step: 5
        action: Verificar drawdown
        logic: |
          if current_drawdown < max_drawdown â†’ REJECT
          
      - step: 6
        action: Verificar loss diÃ¡rio
        logic: |
          if daily_pnl < max_daily_loss â†’ REJECT
          
      - step: 7
        action: Verificar nÃºmero de posiÃ§Ãµes
        logic: |
          if open_positions >= max_open_positions â†’ REJECT
          
      - step: 8
        action: Se todos passam â†’ APPROVE
        result: Encaminha sinal para crypto-trader
        
      - step: 9
        action: Se algum falha â†’ REJECT
        result: |
          - Emite evento de rejeiÃ§Ã£o
          - Registra razÃ£o
          - Atualiza mÃ©tricas


# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ 7. AUTO-DISCOVERY                                            â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

auto_discovery:
  concept: |
    Auto-discovery detecta quando vocÃª executa trades manualmente na
    exchange (via app, web, ou outros bots) e automaticamente:
    - Registra a posiÃ§Ã£o no crypto-management
    - Inicia subscriÃ§Ã£o de preÃ§os no crypto-listener
    - Atribui estratÃ©gia (se configurado)
    - ComeÃ§a a monitorar para sinais de saÃ­da
    
  detection_methods:
    user_data_stream:
      description: WebSocket de user data da exchange (mÃ©todo principal)
      technology: Binance User Data Stream
      events:
        - executionReport: Ordem executada
        - balanceUpdate: Balance atualizado
        - outboundAccountPosition: PosiÃ§Ã£o atualizada
      advantages:
        - Tempo real
        - Baixa latÃªncia
        - NÃ£o consome rate limit
      implementation: |
        1. Conecta ao WebSocket user data
        2. Escuta eventos executionReport
        3. Se ordem nÃ£o Ã© conhecida (nÃ£o em order_tracking):
          â†’ Ã‰ trade manual
        4. Cria Position entity
        5. Emite management.positions.opened
        
    position_polling:
      description: Polling periÃ³dico de posiÃ§Ãµes (fallback)
      technology: Binance REST API (GET /api/v3/account)
      frequency: A cada 30 segundos
      logic: |
        1. Busca todas posiÃ§Ãµes da exchange
        2. Compara com posiÃ§Ãµes conhecidas
        3. Se nova posiÃ§Ã£o:
          â†’ Trade manual detectado
      disadvantages:
        - LatÃªncia maior
        - Consome rate limit
      use_case: Backup se WebSocket falhar
      
  reconciliation:
    description: ReconciliaÃ§Ã£o periÃ³dica (garantir consistÃªncia)
    frequency: A cada 5 minutos
    logic: |
      1. Busca posiÃ§Ãµes da exchange
      2. Busca posiÃ§Ãµes do crypto-management
      3. Identifica divergÃªncias:
         - PosiÃ§Ãµes na exchange mas nÃ£o no management
         - PosiÃ§Ãµes no management mas nÃ£o na exchange
      4. Corrige divergÃªncias:
         - Adiciona faltantes
         - Remove inexistentes
      5. Registra em logs para auditoria
      
  auto_discovery_flow:
    steps:
      - step: 1
        component: User Data Stream (WebSocket)
        action: Recebe executionReport event
        
      - step: 2
        component: Position Detector
        action: |
          - Verifica se order_id Ã© conhecido
          - Se nÃ£o: Ã© trade manual
          
      - step: 3
        component: Position Orchestrator
        action: |
          - Cria Position entity
          - Define source = "manual"
          - Calcula entry_price, quantity
          
      - step: 4
        component: Strategy Assignment
        action: |
          - Verifica configuraÃ§Ã£o de auto-assignment
          - Se configurado: atribui estratÃ©gia ao symbol
          - SenÃ£o: strategy = null
          
      - step: 5
        component: Event Publisher
        action: |
          - Emite management.positions.opened
          - Emite crypto-listener.subscribe
          
      - step: 6
        component: Subscription Coordinator
        action: |
          - crypto-listener recebe subscribe
          - Inicia stream de preÃ§os para symbol
          
      - step: 7
        component: Notification
        action: |
          - Notifica via crypto-notifications
          - "Manual position detected: LONG BTCUSDT @ 45000"
          
  configuration:
    auto_discovery_enabled:
      env: AUTO_DISCOVERY_ENABLED
      default: true
      
    auto_assign_strategy:
      env: AUTO_ASSIGN_STRATEGY
      default: false
      description: |
        Se true: atribui estratÃ©gia configurada para symbol
        Se false: posiÃ§Ã£o manual sem estratÃ©gia
        
    strategy_assignment_map:
      description: Mapeia symbols para estratÃ©gias
      config: |
        BTCUSDT: RSI_DIVERGENCE
        ETHUSDT: MACD_CROSSOVER


# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ 8. FLUXOS PRINCIPAIS                                         â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

flows:
  signal_validation:
    description: ValidaÃ§Ã£o de sinal contra risk management
    steps:
      - step: 1
        component: Kafka Consumer
        action: Consome sinal de signals.buy
        
      - step: 2
        component: Signal Event Handler
        action: Deserializa e cria SignalDTO
        
      - step: 3
        component: Risk Validator
        action: |
          - Busca risk limits atuais
          - Busca posiÃ§Ãµes abertas
          - Calcula exposiÃ§Ã£o atual
          - Valida contra todos os limites
        result: APPROVED ou REJECTED (com razÃ£o)
        
      - step: 4a (se APPROVED)
        component: Signal Forwarder
        action: |
          - Encaminha sinal para crypto-trader
          - Registra aprovaÃ§Ã£o
          - Atualiza mÃ©tricas: signals_approved_total
          
      - step: 4b (se REJECTED)
        component: Rejection Handler
        action: |
          - Registra rejeiÃ§Ã£o com razÃ£o
          - Emite notificaÃ§Ã£o (crypto-notifications)
          - Atualiza mÃ©tricas: signals_rejected_total
          
    example_trace: |
      [Consumer] Signal: BUY BTCUSDT @ 45000
      [RiskValidator] Current exposure BTCUSDT: 450/1000 âœ“
      [RiskValidator] Total exposure: 2500/5000 âœ“
      [RiskValidator] Drawdown: -5%/-20% âœ“
      [RiskValidator] Daily loss: -50/-500 âœ“
      [RiskValidator] Open positions: 3/10 âœ“
      [Result] APPROVED
      [Forwarder] Signal forwarded to crypto-trader
      [Metrics] signals_approved_total +1

  position_opened:
    description: Fluxo quando ordem de entrada Ã© executada
    steps:
      - step: 1
        component: Kafka Consumer
        action: Consome orders.events (FILLED) de ordem de compra
        
      - step: 2
        component: Order Event Handler
        action: |
          - Identifica que Ã© ordem de entrada (nÃ£o hÃ¡ posiÃ§Ã£o aberta)
          - Cria ou atualiza Position entity
          
      - step: 3
        component: Position Service
        action: |
          - Calcula entry_price mÃ©dio (se mÃºltiplas ordens)
          - Define status = OPEN
          - Persiste posiÃ§Ã£o (Postgres + Redis)
          
      - step: 4
        component: Event Publisher
        action: Emite management.positions.opened
        
      - step: 5
        component: Subscription Coordinator
        action: Emite crypto-listener.subscribe
        
      - step: 6
        component: Notification
        action: Envia notificaÃ§Ã£o via crypto-notifications
        
      - step: 7
        component: Metrics
        action: |
          - positions_opened_total{symbol="BTCUSDT"} +1
          - active_positions{symbol="BTCUSDT"} = 1

  position_closed:
    description: Fluxo quando ordem de saÃ­da Ã© executada
    steps:
      - step: 1
        component: Kafka Consumer
        action: Consome orders.events (FILLED) de ordem de venda
        
      - step: 2
        component: Order Event Handler
        action: Identifica que Ã© ordem de saÃ­da (posiÃ§Ã£o aberta existe)
        
      - step: 3
        component: PnL Calculator
        action: |
          - Calcula realized_pnl final
          - Calcula pnl_percent
          - Calcula duration
          
      - step: 4
        component: Position Service
        action: |
          - Atualiza Position: status = CLOSED
          - Define exit_price, realized_pnl, closed_at
          - Persiste (Postgres)
          - Remove do Redis (posiÃ§Ã£o nÃ£o ativa)
          
      - step: 5
        component: Event Publisher
        action: Emite management.positions.closed
        
      - step: 6
        component: Subscription Coordinator
        action: Emite crypto-listener.unsubscribe
        
      - step: 7
        component: Portfolio Service
        action: |
          - Atualiza total_realized_pnl
          - Atualiza win/loss counters
          - Atualiza drawdown (se loss)
          
      - step: 8
        component: Notification
        action: |
          Envia notificaÃ§Ã£o:
          "Position closed: BTCUSDT +4.5% profit in 2h 30m"
          
      - step: 9
        component: Metrics
        action: |
          - positions_closed_total{symbol="BTCUSDT",result="win"} +1
          - active_positions{symbol="BTCUSDT"} = 0

  auto_discovery:
    description: Fluxo de detecÃ§Ã£o de trade manual
    steps:
      - step: 1
        component: User Data Stream (WebSocket)
        action: Recebe executionReport de ordem desconhecida
        
      - step: 2
        component: Position Detector
        action: |
          - Verifica order tracking
          - Identifica como trade manual
          
      - step: 3
        component: Auto Discovery Orchestrator
        action: |
          - Cria Position entity (source = "manual")
          - Atribui estratÃ©gia (se configurado)
          
      - step: 4
        component: Event Publisher
        action: |
          - Emite management.positions.opened
          - Emite crypto-listener.subscribe
          
      - step: 5
        component: Notification
        action: |
          "ğŸ” Auto-discovery: Manual LONG detected on BTCUSDT @ 45000"

  strategy_enable:
    description: Habilitar estratÃ©gia via API
    steps:
      - step: 1
        component: HTTP API
        action: |
          POST /api/strategies/RSI_DIVERGENCE/enable
          Body: {"symbols": ["BTCUSDT", "ETHUSDT"]}
          
      - step: 2
        component: Strategy Controller
        action: |
          - Valida estratÃ©gia existe
          - Valida symbols
          - Atualiza configuraÃ§Ã£o
          
      - step: 3
        component: Strategy Repository
        action: Persiste configuraÃ§Ã£o
        
      - step: 4
        component: Event Publisher
        action: |
          Emite management.control.strategy
          {
            "action": "ENABLE",
            "strategy": "RSI_DIVERGENCE",
            "symbols": ["BTCUSDT", "ETHUSDT"]
          }
          
      - step: 5
        component: crypto-signals (consumer)
        action: |
          - Recebe evento
          - Ativa estratÃ©gia RSI_DIVERGENCE
          - ComeÃ§a anÃ¡lise para BTCUSDT e ETHUSDT

  emergency_stop:
    description: Parada de emergÃªncia do sistema
    steps:
      - step: 1
        component: HTTP API ou comando manual
        action: POST /api/system/emergency-stop
        
      - step: 2
        component: System Controller
        action: |
          - Define mode = HALT_TRADING
          - Cancela ordens pendentes (crypto-trader)
          - Para aceitaÃ§Ã£o de novos sinais
          
      - step: 3
        component: Event Publisher
        action: |
          - Emite management.control.risk (HALT_TRADING)
          - Emite management.control.mode (se necessÃ¡rio)
          
      - step: 4
        component: Notification
        action: |
          "ğŸš¨ EMERGENCY STOP: Trading halted"
          
      - step: 5
        component: crypto-trader
        action: |
          - Recebe evento
          - Cancela ordens pendentes
          - Para de aceitar novos sinais


# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ 9. CONFIGURAÃ‡ÃƒO                                              â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

configuration:
  format: YAML + Environment Variables
  precedence: ENV > config file > defaults
  
  files:
    development: config/development.yaml
    production: config/production.yaml
    risk_profiles: config/risk_profiles/*.yaml
    
  structure:
    mode:
      env: OPERATION_MODE
      values: [PAPER, LIVE, DRY_RUN]
      default: PAPER
      
    kafka:
      brokers:
        env: KAFKA_BROKERS
        default: "localhost:9092"
      consumer_group:
        env: KAFKA_CONSUMER_GROUP
        default: "crypto-management-group"
      topics:
        orders_events: "orders.events"
        signals_buy: "signals.buy"
        signals_sell: "signals.sell"
        prices: "crypto-listener.prices"
        
    redis:
      url:
        env: REDIS_URL
        default: "redis://localhost:6379"
      pool_size: 10
      
    database:
      url:
        env: DATABASE_URL
        required: true
      pool_size: 10
      
    exchange:
      name:
        env: EXCHANGE_NAME
        default: "binance"
      api_key:
        env: EXCHANGE_API_KEY
        required: true
      api_secret:
        env: EXCHANGE_API_SECRET
        required: true
      testnet:
        env: EXCHANGE_TESTNET
        default: false
        
    risk:
      profile:
        env: RISK_PROFILE
        default: "moderate"
        values: [conservative, moderate, aggressive, custom]
      max_exposure_per_asset:
        env: RISK_MAX_EXPOSURE_PER_ASSET
        default: 1000.00
      max_total_exposure:
        env: RISK_MAX_TOTAL_EXPOSURE
        default: 5000.00
      max_drawdown:
        env: RISK_MAX_DRAWDOWN
        default: -0.20
      max_daily_loss:
        env: RISK_MAX_DAILY_LOSS
        default: 500.00
      max_open_positions:
        env: RISK_MAX_OPEN_POSITIONS
        default: 10
        
    auto_discovery:
      enabled:
        env: AUTO_DISCOVERY_ENABLED
        default: true
      method:
        env: AUTO_DISCOVERY_METHOD
        values: [user_data_stream, polling, both]
        default: "user_data_stream"
      polling_interval_seconds:
        env: AUTO_DISCOVERY_POLLING_INTERVAL
        default: 30
      reconciliation_interval_seconds:
        env: RECONCILIATION_INTERVAL
        default: 300  # 5 minutos
      auto_assign_strategy:
        env: AUTO_ASSIGN_STRATEGY
        default: false
        
    pnl_update:
      enable_realtime_updates:
        env: PNL_REALTIME_UPDATES
        default: true
      update_threshold_percent:
        env: PNL_UPDATE_THRESHOLD
        default: 1.0  # Emite evento a cada 1% de variaÃ§Ã£o
        
    metrics:
      enabled:
        env: METRICS_ENABLED
        default: true
      port:
        env: METRICS_PORT
        default: 9090


# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ 10. MÃ‰TRICAS E OBSERVABILIDADE                               â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

metrics:
  prometheus_endpoint: /metrics
  port: 9090
  
  counters:
    - name: signals_received_total
      help: Total de sinais recebidos
      labels: [symbol, side, source]
      
    - name: signals_approved_total
      help: Total de sinais aprovados apÃ³s validaÃ§Ã£o de risco
      labels: [symbol, side]
      
    - name: signals_rejected_total
      help: Total de sinais rejeitados
      labels: [symbol, reason]
      
    - name: positions_opened_total
      help: Total de posiÃ§Ãµes abertas
      labels: [symbol, side, source]
      
    - name: positions_closed_total
      help: Total de posiÃ§Ãµes fechadas
      labels: [symbol, result]
      
    - name: trades_detected_manual_total
      help: Total de trades manuais detectados via auto-discovery
      labels: [symbol]
      
    - name: risk_violations_total
      help: Total de violaÃ§Ãµes de risco detectadas
      labels: [rule]
      
  histograms:
    - name: position_duration_seconds
      help: DuraÃ§Ã£o de posiÃ§Ãµes fechadas
      labels: [symbol]
      buckets: [60, 300, 900, 1800, 3600, 7200, 14400, 28800]
      
    - name: position_pnl
      help: P&L de posiÃ§Ãµes fechadas
      labels: [symbol]
      buckets: [-1000, -500, -100, 0, 100, 500, 1000, 5000]
      
  gauges:
    - name: active_positions
      help: NÃºmero de posiÃ§Ãµes abertas
      labels: [symbol]
      
    - name: total_exposure
      help: ExposiÃ§Ã£o total em USDT
      labels: []
      
    - name: exposure_per_asset
      help: ExposiÃ§Ã£o por asset
      labels: [symbol]
      
    - name: current_drawdown
      help: Drawdown atual
      labels: []
      
    - name: daily_pnl
      help: P&L do dia atual
      labels: []
      
    - name: total_unrealized_pnl
      help: P&L nÃ£o realizado total
      labels: []
      
    - name: portfolio_balance
      help: Balance total do portfolio
      labels: [asset]

  logging:
    format: JSON (structured logging)
    level: INFO (configurÃ¡vel via env)
    fields:
      - timestamp
      - level
      - message
      - position_id
      - symbol
      - event_type
      - pnl
      - duration_ms
      - error (if any)

  tracing:
    enabled: true
    library: tracing / tracing-subscriber
    spans:
      - name: validate_signal
        fields: [signal_id, symbol, validation_result]
      - name: open_position
        fields: [position_id, symbol, entry_price]
      - name: close_position
        fields: [position_id, symbol, pnl]
      - name: auto_discovery
        fields: [symbol, detection_method]


# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ 11. API REST                                                 â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

rest_api:
  base_url: http://localhost:8080/api
  
  endpoints:
    positions:
      - method: GET
        path: /positions
        description: Lista todas as posiÃ§Ãµes (abertas e fechadas)
        query_params:
          status: optional enum [OPEN, CLOSED]
          symbol: optional string
          limit: optional integer (default: 100)
        response: |
          {
            "positions": [
              {
                "position_id": "uuid",
                "symbol": "BTCUSDT",
                "side": "LONG",
                "quantity": 0.01,
                "entry_price": 45000.00,
                "current_price": 46500.00,
                "unrealized_pnl": 15.00,
                "pnl_percent": 3.33,
                "status": "OPEN",
                "opened_at": "2025-10-16T22:00:00Z"
              }
            ]
          }
          
      - method: GET
        path: /positions/{position_id}
        description: Detalhes de uma posiÃ§Ã£o especÃ­fica
        
      - method: POST
        path: /positions/{position_id}/close
        description: Fecha posiÃ§Ã£o manualmente
        
    portfolio:
      - method: GET
        path: /portfolio/summary
        description: Resumo do portfolio
        response: |
          {
            "total_balance": 12450.00,
            "total_exposure": 2500.00,
            "active_positions": 3,
            "total_realized_pnl": 450.00,
            "total_unrealized_pnl": 75.00,
            "daily_pnl": 125.00,
            "current_drawdown": -0.05,
            "win_rate": 0.65
          }
          
      - method: GET
        path: /portfolio/pnl/history
        description: HistÃ³rico de P&L
        query_params:
          period: enum [daily, weekly, monthly]
          
    risk:
      - method: GET
        path: /risk/status
        description: Status de risco atual
        response: |
          {
            "total_exposure": 2500.00,
            "max_total_exposure": 5000.00,
            "exposure_ratio": 0.50,
            "current_drawdown": -0.05,
            "max_drawdown": -0.20,
            "daily_pnl": 125.00,
            "max_daily_loss": -500.00,
            "open_positions": 3,
            "max_open_positions": 10,
            "mode": "LIVE"
          }
          
      - method: PUT
        path: /risk/limits
        description: Atualiza limites de risco
        body: |
          {
            "max_exposure_per_asset": 1500.00,
            "max_total_exposure": 7500.00,
            "max_drawdown": -0.25
          }
          
    strategies:
      - method: GET
        path: /strategies
        description: Lista estratÃ©gias e status
        
      - method: POST
        path: /strategies/{strategy_name}/enable
        description: Habilita estratÃ©gia
        body: |
          {
            "symbols": ["BTCUSDT", "ETHUSDT"]
          }
          
      - method: POST
        path: /strategies/{strategy_name}/disable
        description: Desabilita estratÃ©gia
        
      - method: PUT
        path: /strategies/{strategy_name}/params
        description: Atualiza parÃ¢metros de estratÃ©gia
        body: |
          {
            "rsi_period": 14,
            "oversold": 25
          }
          
    system:
      - method: GET
        path: /system/health
        description: Health check do sistema
        response: |
          {
            "status": "healthy",
            "mode": "LIVE",
            "components": {
              "kafka": "connected",
              "redis": "connected",
              "database": "connected",
              "exchange": "connected"
            }
          }
          
      - method: POST
        path: /system/mode
        description: Muda modo de operaÃ§Ã£o
        body: |
          {
            "mode": "LIVE"
          }
          
      - method: POST
        path: /system/emergency-stop
        description: Para todo o trading imediatamente


# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ 12. INSTRUÃ‡Ã•ES DE DESENVOLVIMENTO                            â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

development_instructions:
  setup:
    prerequisites:
      - Rust 1.75+ (rustup)
      - Docker & Docker Compose
      - Postgres client (psql)
      - Redis client (redis-cli)
      - Kafka client (kafkacat/kcat)
      - Binance account (API keys)
      
    steps:
      - step: 1
        action: Clone o repositÃ³rio
        command: git clone <repo-url> && cd crypto-management
        
      - step: 2
        action: Copie o arquivo de configuraÃ§Ã£o
        command: cp .env.example .env
        
      - step: 3
        action: Configure as variÃ¡veis de ambiente
        details: |
          Edite .env e configure:
          - OPERATION_MODE=PAPER (comeÃ§ar com paper)
          - EXCHANGE_API_KEY (Binance)
          - EXCHANGE_API_SECRET (Binance)
          - DATABASE_URL
          - KAFKA_BROKERS
          - REDIS_URL
          - RISK_PROFILE=moderate
          
      - step: 4
        action: Inicie dependÃªncias
        command: docker-compose up -d kafka postgres redis
        
      - step: 5
        action: Execute migrations
        command: cargo run --bin migrate
        
      - step: 6
        action: Instale dependÃªncias Rust
        command: cargo build
        
      - step: 7
        action: Execute o serviÃ§o
        command: cargo run
        
  testing:
    check_risk_validation:
      description: Testar validaÃ§Ã£o de risco
      command: |
        curl -X GET http://localhost:8080/api/risk/status
        
    simulate_manual_trade:
      description: Simular trade manual (se auto-discovery habilitado)
      action: |
        Executar ordem manual no app da Binance
        â†’ Verificar logs do crypto-management
        â†’ Deve detectar e criar posiÃ§Ã£o
        
    check_positions:
      command: |
        curl -X GET http://localhost:8080/api/positions
        
    enable_strategy:
      command: |
        curl -X POST http://localhost:8080/api/strategies/RSI_DIVERGENCE/enable \
          -H "Content-Type: application/json" \
          -d '{"symbols": ["BTCUSDT"]}'


# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ 13. TROUBLESHOOTING                                          â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

troubleshooting:
  common_issues:
    - issue: "Auto-discovery nÃ£o detectando trades manuais"
      causes:
        - User data stream nÃ£o conectado
        - API keys sem permissÃ£o de user data
        - WebSocket desconectado
      solutions:
        - Verificar logs: RUST_LOG=debug
        - Testar API keys: cargo run --bin test-exchange-connection
        - Verificar health: curl localhost:8080/api/system/health
        
    - issue: "Sinais sendo rejeitados constantemente"
      causes:
        - Limites de risco muito restritivos
        - Drawdown atingido
        - Loss diÃ¡rio atingido
      solutions:
        - Verificar risk status: curl localhost:8080/api/risk/status
        - Ajustar limites: PUT /api/risk/limits
        - Verificar mÃ©tricas: signals_rejected_total
        
    - issue: "PosiÃ§Ãµes nÃ£o aparecendo"
      causes:
        - Ordem nÃ£o executada
        - Evento orders.events nÃ£o recebido
        - Erro ao processar evento
      solutions:
        - Verificar tÃ³pico Kafka: kcat -C -b localhost:9092 -t orders.events
        - Verificar logs de processamento
        - Verificar database: SELECT * FROM positions


# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ 14. ROADMAP & MELHORIAS FUTURAS                              â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

roadmap:
  v1_0:
    status: Current
    features:
      - âœ… Gerenciamento de posiÃ§Ãµes
      - âœ… Risk management central
      - âœ… Auto-discovery
      - âœ… Controle de estratÃ©gias
      - âœ… Controle de modo
      - âœ… APIs REST
      
  v1_1:
    planned_features:
      - Portfolio rebalancing automÃ¡tico
      - Advanced risk metrics (VaR, CVaR)
      - Multi-account support
      - WebSocket API (real-time updates)
      - Advanced analytics dashboard
      
  v2_0:
    planned_features:
      - Machine learning risk models
      - Portfolio optimization
      - Tax reporting
      - Compliance tools
      - Multi-exchange orchestration
      - Social trading features


# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ 15. REFERÃŠNCIAS E DOCUMENTAÃ‡ÃƒO                               â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

references:
  exchange_apis:
    binance:
      - name: Binance User Data Stream
        url: https://binance-docs.github.io/apidocs/spot/en/#user-data-streams
        
  rust_libraries:
    - name: binance-rs
      url: https://docs.rs/binance
      
    - name: rust-decimal
      url: https://docs.rs/rust_decimal
      
  risk_management:
    - Position Sizing
    - Drawdown Management
    - Exposure Limits
    - Kelly Criterion
    - Value at Risk (VaR)
    
  architecture_patterns:
    - Event-Driven Architecture
    - Hexagonal Architecture (Ports & Adapters)
    - Domain-Driven Design (DDD)
    - CQRS (Command Query Responsibility Segregation)
    - Orchestration Pattern


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# FIM DO PROJECT MAP
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
