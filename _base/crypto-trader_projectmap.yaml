# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# CRYPTO-TRADER - PROJECT MAP
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Sistema de execuÃ§Ã£o de ordens e gerenciamento de stops para trading
# Linguagem: Rust
# VersÃ£o: 1.0.0
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ 1. OVERVIEW DO PROJETO                                      â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

project:
  name: crypto-trader
  description: |
    ServiÃ§o responsÃ¡vel por executar ordens de trading baseado em sinais 
    recebidos, gerenciar stops (stop loss, take profit) e trailing stops,
    alÃ©m de validar todas as operaÃ§Ãµes contra regras de risco.
    
    CaracterÃ­sticas principais:
    - ExecuÃ§Ã£o automÃ¡tica de ordens baseada em sinais
    - ValidaÃ§Ã£o de risco antes de cada execuÃ§Ã£o
    - Gerenciamento de stops (stop loss, take profit)
    - Trailing stops dinÃ¢micos
    - Suporte a mÃºltiplas exchanges (Binance inicialmente)
    - Retry automÃ¡tico em caso de falha temporÃ¡ria
    - IdempotÃªncia de ordens
    - Auditoria completa de todas as operaÃ§Ãµes
    - MÃ©tricas e observabilidade

  language: Rust
  async_runtime: tokio
  message_broker: Kafka (rdkafka)
  exchanges: Binance (binance-rs ou binance-connector)
  
  responsibilities:
    - Consumir sinais de trading dos tÃ³picos Kafka
    - Validar sinais contra regras de risco
    - Executar ordens na exchange
    - Gerenciar stops (stop loss, take profit)
    - Gerenciar trailing stops
    - Monitorar ordens atÃ© conclusÃ£o
    - Publicar eventos de ordens (created, filled, cancelled)
    - Manter histÃ³rico de ordens e execuÃ§Ãµes
    - Prover mÃ©tricas de execuÃ§Ã£o


# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ 2. ARQUITETURA                                               â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

architecture:
  pattern: Event-Driven + Hexagonal Architecture + DDD
  
  components:
    signal_consumer:
      description: Consome sinais de trading do Kafka
      technology: rdkafka (librdkafka wrapper)
      topics: [signals.buy, signals.sell]
      
    order_validator:
      description: Valida ordens contra regras de negÃ³cio
      validations:
        - DuplicaÃ§Ã£o (idempotÃªncia)
        - Saldo disponÃ­vel
        - Limites de posiÃ§Ã£o
        - Limites de exposiÃ§Ã£o
        - Quantidade mÃ­nima/mÃ¡xima
        
    risk_validator:
      description: Valida contra regras de risk management
      validations:
        - MÃ¡ximo drawdown
        - MÃ¡xima exposiÃ§Ã£o por asset
        - MÃ¡xima exposiÃ§Ã£o total
        - Loss diÃ¡rio
        
    order_executor:
      description: Executa ordens na exchange
      features:
        - Retry com exponential backoff
        - Timeout configurÃ¡vel
        - ValidaÃ§Ã£o de resposta
        - Tratamento de erros especÃ­ficos
        
    stop_manager:
      description: Gerencia stops (stop loss, take profit)
      features:
        - Monitoramento de preÃ§os em tempo real
        - Trigger automÃ¡tico
        - Cancelamento de ordens relacionadas
        - NotificaÃ§Ã£o de acionamento
        
    trailing_stop_manager:
      description: Gerencia trailing stops
      features:
        - Ajuste dinÃ¢mico do stop baseado em preÃ§o
        - ConfiguraÃ§Ã£o por percentual ou valor fixo
        - Lock de lucro progressivo
        
    order_monitor:
      description: Monitora status de ordens atÃ© conclusÃ£o
      features:
        - Polling de status
        - User data stream (websocket)
        - Timeout de execuÃ§Ã£o
        - Cancelamento automÃ¡tico
        
    event_publisher:
      description: Publica eventos de ordens
      technology: rdkafka
      topic: orders.events
      
    metrics:
      description: Coleta mÃ©tricas
      technology: Prometheus (rust-prometheus)
      
  data_flow: |
    Kafka (signals) â†’ Signal Consumer â†’ Validators â†’ Order Executor â†’ Exchange
                                           â†“
                                    Event Publisher â†’ Kafka (orders.events)
                                           â†“
                                    Stop Manager (monitora)
                                           â†“
                                    Trailing Stop Manager (ajusta)


# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ 3. TÃ“PICOS KAFKA                                             â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

kafka_topics:
  consumed:
    - name: signals.buy
      description: Sinais de compra gerados por crypto-signals ou crypto-webhook
      producers:
        - crypto-signals
        - crypto-webhook
      consumer_group: crypto-trader-group
      
      schema:
        symbol:
          type: string
          description: Par de negociaÃ§Ã£o (ex: BTCUSDT)
          
        strategy:
          type: string
          description: Nome da estratÃ©gia que gerou o sinal
          
        source:
          type: string
          enum: [internal, tradingview, external]
          description: Origem do sinal
          
        confidence:
          type: number
          description: NÃ­vel de confianÃ§a do sinal (0.0 a 1.0)
          
        target_price:
          type: number
          description: PreÃ§o alvo de entrada
          
        stop_loss:
          type: number
          optional: true
          description: PreÃ§o de stop loss sugerido
          
        take_profit:
          type: number
          optional: true
          description: PreÃ§o de take profit sugerido
          
        quantity:
          type: number
          optional: true
          description: Quantidade sugerida (se nÃ£o informado, calcula baseado em risco)
          
        metadata:
          type: object
          optional: true
          description: Metadados adicionais da estratÃ©gia
          
        timestamp:
          type: string
          format: ISO8601
          
      example_payload: |
        {
          "symbol": "BTCUSDT",
          "strategy": "RSI_DIVERGENCE",
          "source": "internal",
          "confidence": 0.85,
          "target_price": 45000.00,
          "stop_loss": 44000.00,
          "take_profit": 47000.00,
          "timestamp": "2025-10-16T22:00:00Z"
        }

    - name: signals.sell
      description: Sinais de venda
      schema: Similar ao signals.buy
      
    - name: management.control.risk
      description: AtualizaÃ§Ãµes de parÃ¢metros de risco do crypto-management
      schema:
        action: enum [UPDATE_LIMITS, HALT_TRADING, RESUME_TRADING]
        max_exposure_per_asset: number
        max_total_exposure: number
        max_daily_loss: number
        
    - name: management.control.mode
      description: MudanÃ§as de modo de operaÃ§Ã£o
      schema:
        mode: enum [PAPER, LIVE, DRY_RUN]

  produced:
    - name: orders.events
      description: Eventos de ordens executadas
      
      schema:
        event_type:
          type: string
          enum: [CREATED, FILLED, PARTIAL_FILL, CANCELLED, REJECTED, EXPIRED, STOP_TRIGGERED]
          
        order_id:
          type: string
          description: ID da ordem na exchange
          
        client_order_id:
          type: string
          description: ID interno da ordem (para idempotÃªncia)
          
        symbol:
          type: string
          
        side:
          type: string
          enum: [BUY, SELL]
          
        order_type:
          type: string
          enum: [MARKET, LIMIT, STOP_LOSS, STOP_LOSS_LIMIT, TAKE_PROFIT, TAKE_PROFIT_LIMIT]
          
        quantity:
          type: number
          description: Quantidade da ordem
          
        price:
          type: number
          optional: true
          description: PreÃ§o da ordem (se LIMIT)
          
        stop_price:
          type: number
          optional: true
          description: PreÃ§o de stop (se STOP_LOSS ou TAKE_PROFIT)
          
        filled_quantity:
          type: number
          optional: true
          description: Quantidade jÃ¡ executada (para PARTIAL_FILL)
          
        average_price:
          type: number
          optional: true
          description: PreÃ§o mÃ©dio de execuÃ§Ã£o (para FILLED/PARTIAL_FILL)
          
        commission:
          type: number
          optional: true
          description: ComissÃ£o paga
          
        commission_asset:
          type: string
          optional: true
          
        status:
          type: string
          enum: [NEW, PARTIALLY_FILLED, FILLED, CANCELED, REJECTED, EXPIRED]
          
        error:
          type: string
          optional: true
          description: Mensagem de erro (se REJECTED)
          
        signal_reference:
          type: object
          optional: true
          description: ReferÃªncia ao sinal original
          
        timestamp:
          type: string
          format: ISO8601
          
      example_payload: |
        {
          "event_type": "FILLED",
          "order_id": "12345678",
          "client_order_id": "crypto-trader-uuid-123",
          "symbol": "BTCUSDT",
          "side": "BUY",
          "order_type": "MARKET",
          "quantity": 0.01,
          "filled_quantity": 0.01,
          "average_price": 45023.50,
          "commission": 0.00001,
          "commission_asset": "BTC",
          "status": "FILLED",
          "signal_reference": {
            "strategy": "RSI_DIVERGENCE",
            "source": "internal"
          },
          "timestamp": "2025-10-16T22:00:15Z"
        }


# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ 4. MAPA DE PASTAS                                            â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

project_structure:
  description: Estrutura completa do projeto com descriÃ§Ã£o de cada mÃ³dulo
  architecture_layers: |
    Presentation â†’ Application â†’ Domain
                       â†“
                Infrastructure
    
    - Domain: nÃ£o depende de ninguÃ©m (nÃºcleo puro)
    - Application: depende apenas de Domain
    - Infrastructure: implementa contratos de Application
    - Presentation: usa Application e injeta Infrastructure via DI
    
  structure: |
    crypto-trader/
    â”œâ”€â”€ src/
    â”‚   â”œâ”€â”€ main.rs                          # Entry point: bootstrap do app (config, DB, consumers, executor, HTTP server)
    â”‚   â”œâ”€â”€ lib.rs                           # Biblioteca pÃºblica expondo mÃ³dulos principais
    â”‚   â”‚
    â”‚   â”œâ”€â”€ domain/                          # â­ Camada de DomÃ­nio (regras de negÃ³cio puras, sem I/O)
    â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â”œâ”€â”€ errors.rs                    # Erros de domÃ­nio (OrderValidationError, RiskViolationError)
    â”‚   â”‚   â”œâ”€â”€ aggregates/                  # Agregados DDD
    â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â”‚   â”œâ”€â”€ order.rs                 # OrderAggregate (valida, calcula, aplica eventos)
    â”‚   â”‚   â”‚   â”œâ”€â”€ position.rs              # PositionAggregate (gerencia posiÃ§Ã£o aberta)
    â”‚   â”‚   â”‚   â”œâ”€â”€ stop_loss.rs             # StopLossAggregate (monitora, dispara)
    â”‚   â”‚   â”‚   â””â”€â”€ trailing_stop.rs         # TrailingStopAggregate (ajusta dinamicamente)
    â”‚   â”‚   â”œâ”€â”€ entities/                    # Entidades de domÃ­nio
    â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â”‚   â”œâ”€â”€ order.rs                 # Entidade Order
    â”‚   â”‚   â”‚   â”œâ”€â”€ execution.rs             # Entidade Execution (fill parcial/total)
    â”‚   â”‚   â”‚   â””â”€â”€ stop.rs                  # Entidade Stop (stop loss ou take profit)
    â”‚   â”‚   â”œâ”€â”€ events/                      # Domain events
    â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â”‚   â”œâ”€â”€ order_events.rs          # OrderCreated, OrderFilled, OrderCancelled, OrderRejected
    â”‚   â”‚   â”‚   â”œâ”€â”€ position_events.rs       # PositionOpened, PositionClosed, PositionUpdated
    â”‚   â”‚   â”‚   â””â”€â”€ stop_events.rs           # StopLossSet, StopLossTriggered, TrailingStopAdjusted
    â”‚   â”‚   â”œâ”€â”€ repositories/                # Traits de repositÃ³rios (contratos)
    â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â”‚   â”œâ”€â”€ order_repository.rs      # Contrato para persistir ordens
    â”‚   â”‚   â”‚   â”œâ”€â”€ position_repository.rs   # Contrato para persistir posiÃ§Ãµes
    â”‚   â”‚   â”‚   â””â”€â”€ execution_repository.rs  # Contrato para histÃ³rico de execuÃ§Ãµes
    â”‚   â”‚   â”œâ”€â”€ services/                    # ServiÃ§os de domÃ­nio (lÃ³gica que nÃ£o pertence a um agregado)
    â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â”‚   â”œâ”€â”€ order_validator.rs       # Valida ordem (duplicaÃ§Ã£o, quantidade, limites)
    â”‚   â”‚   â”‚   â”œâ”€â”€ risk_validator.rs        # Valida contra regras de risco
    â”‚   â”‚   â”‚   â”œâ”€â”€ position_calculator.rs   # Calcula tamanho de posiÃ§Ã£o baseado em risco
    â”‚   â”‚   â”‚   â”œâ”€â”€ pnl_calculator.rs        # Calcula P&L de posiÃ§Ã£o
    â”‚   â”‚   â”‚   â””â”€â”€ commission_calculator.rs # Calcula comissÃµes
    â”‚   â”‚   â””â”€â”€ value_objects/               # Value objects
    â”‚   â”‚       â”œâ”€â”€ mod.rs
    â”‚   â”‚       â”œâ”€â”€ order_id.rs              # VO OrderId (exchange + client order id)
    â”‚   â”‚       â”œâ”€â”€ symbol.rs                # VO Symbol (BTCUSDT, etc.)
    â”‚   â”‚       â”œâ”€â”€ price.rs                 # VO Price (validaÃ§Ã£o, comparaÃ§Ã£o)
    â”‚   â”‚       â”œâ”€â”€ quantity.rs              # VO Quantity (validaÃ§Ã£o)
    â”‚   â”‚       â”œâ”€â”€ order_side.rs            # VO OrderSide (BUY, SELL)
    â”‚   â”‚       â”œâ”€â”€ order_type.rs            # VO OrderType (MARKET, LIMIT, STOP_LOSS, etc.)
    â”‚   â”‚       â”œâ”€â”€ order_status.rs          # VO OrderStatus (NEW, FILLED, etc.)
    â”‚   â”‚       â”œâ”€â”€ stop_type.rs             # VO StopType (STOP_LOSS, TAKE_PROFIT)
    â”‚   â”‚       â””â”€â”€ time_in_force.rs         # VO TimeInForce (GTC, IOC, FOK)
    â”‚   â”‚
    â”‚   â”œâ”€â”€ application/                     # â­ Camada de AplicaÃ§Ã£o (casos de uso, orquestraÃ§Ã£o)
    â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â”œâ”€â”€ dtos/                        # Data Transfer Objects
    â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â”‚   â”œâ”€â”€ commands.rs              # Command DTOs (ExecuteOrderCommand, SetStopLossCommand)
    â”‚   â”‚   â”‚   â”œâ”€â”€ signal_dto.rs            # DTO para sinais recebidos
    â”‚   â”‚   â”‚   â”œâ”€â”€ order_dto.rs             # DTO para ordens
    â”‚   â”‚   â”‚   â”œâ”€â”€ requests.rs              # HTTP request DTOs
    â”‚   â”‚   â”‚   â””â”€â”€ responses.rs             # HTTP response DTOs
    â”‚   â”‚   â”œâ”€â”€ ports/                       # âš¡ Ports (interfaces/contratos para adapters)
    â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â”‚   â”œâ”€â”€ signal_consumer_port.rs  # Contrato para consumir sinais do Kafka
    â”‚   â”‚   â”‚   â”œâ”€â”€ exchange_port.rs         # Contrato para executar ordens na exchange
    â”‚   â”‚   â”‚   â”œâ”€â”€ order_publisher_port.rs  # Contrato para publicar eventos de ordens
    â”‚   â”‚   â”‚   â”œâ”€â”€ price_stream_port.rs     # Contrato para stream de preÃ§os (para stops)
    â”‚   â”‚   â”‚   â”œâ”€â”€ order_repository_port.rs # Contrato para persistir ordens
    â”‚   â”‚   â”‚   â”œâ”€â”€ position_repository_port.rs # Contrato para persistir posiÃ§Ãµes
    â”‚   â”‚   â”‚   â””â”€â”€ event_store_port.rs      # Contrato para Event Sourcing
    â”‚   â”‚   â”œâ”€â”€ queries/                     # Queries (CQRS read-side)
    â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â”‚   â”œâ”€â”€ get_order_history.rs     # Query: histÃ³rico de ordens
    â”‚   â”‚   â”‚   â”œâ”€â”€ get_active_positions.rs  # Query: posiÃ§Ãµes abertas
    â”‚   â”‚   â”‚   â””â”€â”€ get_pnl_summary.rs       # Query: resumo de P&L
    â”‚   â”‚   â””â”€â”€ services/                    # Application services (orquestraÃ§Ã£o de casos de uso)
    â”‚   â”‚       â”œâ”€â”€ mod.rs
    â”‚   â”‚       â”œâ”€â”€ order_service.rs         # Caso de uso: processar sinal e executar ordem
    â”‚   â”‚       â”œâ”€â”€ stop_service.rs          # Caso de uso: gerenciar stops
    â”‚   â”‚       â”œâ”€â”€ position_service.rs      # Caso de uso: gerenciar posiÃ§Ãµes
    â”‚   â”‚       â””â”€â”€ execution_orchestrator.rs # Orquestra: signal â†’ validate â†’ execute â†’ monitor â†’ publish
    â”‚   â”‚
    â”‚   â”œâ”€â”€ infrastructure/                  # â­ Camada de Infraestrutura (implementaÃ§Ãµes tÃ©cnicas)
    â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â”œâ”€â”€ bootstrap/                   # InicializaÃ§Ã£o de componentes
    â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â”‚   â”œâ”€â”€ database.rs              # Setup de conexÃ£o Postgres + migrations
    â”‚   â”‚   â”‚   â”œâ”€â”€ kafka_consumer.rs        # Inicializa consumer Kafka (sinais)
    â”‚   â”‚   â”‚   â”œâ”€â”€ kafka_publisher.rs       # Inicializa publisher Kafka (eventos)
    â”‚   â”‚   â”‚   â”œâ”€â”€ exchange.rs              # Inicializa conexÃ£o com exchange
    â”‚   â”‚   â”‚   â””â”€â”€ price_stream.rs          # Inicializa stream de preÃ§os (para stops)
    â”‚   â”‚   â”œâ”€â”€ config/                      # ConfiguraÃ§Ã£o e settings
    â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â”‚   â”œâ”€â”€ settings.rs              # Struct Settings + carregamento de env vars
    â”‚   â”‚   â”‚   â””â”€â”€ risk_config.rs           # ConfiguraÃ§Ãµes de risco (limites, drawdown)
    â”‚   â”‚   â”œâ”€â”€ messaging/                   # Messaging & Event Streaming
    â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â”‚   â”œâ”€â”€ kafka_signal_consumer.rs # Consumer de sinais (signals.buy/sell)
    â”‚   â”‚   â”‚   â”œâ”€â”€ kafka_order_publisher.rs # Publisher de eventos de ordens
    â”‚   â”‚   â”‚   â””â”€â”€ signal_handler.rs        # Handler que processa sinais recebidos
    â”‚   â”‚   â”œâ”€â”€ exchanges/                   # ImplementaÃ§Ãµes de exchanges (Adapters)
    â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â”‚   â”œâ”€â”€ binance_exchange.rs      # Implementa ExchangePort via binance-rs
    â”‚   â”‚   â”‚   â”œâ”€â”€ binance_connector.rs     # Implementa ExchangePort via binance-connector
    â”‚   â”‚   â”‚   â”œâ”€â”€ paper_exchange.rs        # Implementa ExchangePort para paper trading
    â”‚   â”‚   â”‚   â””â”€â”€ exchange_error_mapper.rs # Mapeia erros da exchange para domain errors
    â”‚   â”‚   â”œâ”€â”€ stops/                       # Gerenciamento de stops
    â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â”‚   â”œâ”€â”€ stop_loss_manager.rs     # Monitora preÃ§os e dispara stop loss
    â”‚   â”‚   â”‚   â”œâ”€â”€ trailing_stop_manager.rs # Gerencia trailing stops
    â”‚   â”‚   â”‚   â””â”€â”€ price_monitor.rs         # Monitora preÃ§os em tempo real (websocket)
    â”‚   â”‚   â”œâ”€â”€ monitoring/                  # Monitoramento de ordens
    â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â”‚   â”œâ”€â”€ order_monitor.rs         # Monitora status de ordens atÃ© conclusÃ£o
    â”‚   â”‚   â”‚   â””â”€â”€ user_data_stream.rs      # User data stream da exchange (websocket)
    â”‚   â”‚   â”œâ”€â”€ persistence/                 # PersistÃªncia (Postgres)
    â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â”‚   â”œâ”€â”€ postgres_order_repository.rs     # Store de ordens
    â”‚   â”‚   â”‚   â”œâ”€â”€ postgres_position_repository.rs  # Store de posiÃ§Ãµes
    â”‚   â”‚   â”‚   â”œâ”€â”€ postgres_execution_repository.rs # Store de execuÃ§Ãµes
    â”‚   â”‚   â”‚   â””â”€â”€ postgres_event_store.rs          # Event Store (Event Sourcing)
    â”‚   â”‚   â”œâ”€â”€ retry/                       # Retry e error handling
    â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â”‚   â”œâ”€â”€ exponential_backoff.rs   # Retry com exponential backoff
    â”‚   â”‚   â”‚   â””â”€â”€ idempotency_checker.rs   # Verifica se ordem jÃ¡ foi executada
    â”‚   â”‚   â”œâ”€â”€ metrics/                     # MÃ©tricas e observabilidade
    â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â”‚   â””â”€â”€ prometheus_metrics.rs    # Registra mÃ©tricas Prometheus
    â”‚   â”‚   â”œâ”€â”€ shutdown/                    # Shutdown graceful
    â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â”‚   â”œâ”€â”€ graceful.rs              # Coordena shutdown (cancela ordens pendentes, fecha conexÃµes)
    â”‚   â”‚   â”‚   â””â”€â”€ signal_handler.rs        # Captura sinais SIGTERM/SIGINT
    â”‚   â”‚   â””â”€â”€ startup/                     # Startup do aplicativo
    â”‚   â”‚       â”œâ”€â”€ mod.rs
    â”‚   â”‚       â”œâ”€â”€ banner.rs                # Banner ASCII no console
    â”‚   â”‚       â”œâ”€â”€ health.rs                # Health checks
    â”‚   â”‚       â””â”€â”€ logging.rs               # Setup de logs (tracing-subscriber)
    â”‚   â”‚
    â”‚   â”œâ”€â”€ presentation/                    # â­ Camada de ApresentaÃ§Ã£o (HTTP, CLI futuro)
    â”‚   â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚   â””â”€â”€ http/                        # HTTP REST API (Axum)
    â”‚   â”‚       â”œâ”€â”€ mod.rs
    â”‚   â”‚       â”œâ”€â”€ router.rs                # DefiniÃ§Ã£o de rotas (endpoints)
    â”‚   â”‚       â”œâ”€â”€ responses.rs             # Helpers de resposta (ApiResponse, ErrorResponse)
    â”‚   â”‚       â”œâ”€â”€ controllers/             # Controllers HTTP
    â”‚   â”‚       â”‚   â”œâ”€â”€ mod.rs
    â”‚   â”‚       â”‚   â”œâ”€â”€ order_controller.rs  # Endpoints de ordens (get, cancel)
    â”‚   â”‚       â”‚   â”œâ”€â”€ position_controller.rs # Endpoints de posiÃ§Ãµes
    â”‚   â”‚       â”‚   â”œâ”€â”€ stop_controller.rs   # Endpoints de stops
    â”‚   â”‚       â”‚   â””â”€â”€ health_controller.rs # Health checks, metrics
    â”‚   â”‚       â””â”€â”€ middleware/              # Middlewares HTTP (logging, auth futuro)
    â”‚   â”‚           â”œâ”€â”€ mod.rs
    â”‚   â”‚           â””â”€â”€ request_logger.rs    # Log de requests HTTP
    â”‚   â”‚
    â”‚   â””â”€â”€ shared/                          # â­ Shared Kernel (cÃ³digo transversal)
    â”‚       â”œâ”€â”€ mod.rs
    â”‚       â”œâ”€â”€ errors.rs                    # Erros compartilhados (ApplicationError, InfrastructureError)
    â”‚       â”œâ”€â”€ types.rs                     # Tipos compartilhados (EventEnvelope, Timestamp, etc.)
    â”‚       â”œâ”€â”€ traits/                      # Traits comuns
    â”‚       â”‚   â”œâ”€â”€ mod.rs
    â”‚       â”‚   â””â”€â”€ aggregate_root.rs        # Trait AggregateRoot (apply_event, uncommitted_events)
    â”‚       â””â”€â”€ utils/                       # UtilitÃ¡rios
    â”‚           â”œâ”€â”€ mod.rs
    â”‚           â”œâ”€â”€ datetime.rs              # Helpers de data/hora
    â”‚           â”œâ”€â”€ decimal.rs               # Helpers para aritmÃ©tica decimal (preÃ§os)
    â”‚           â””â”€â”€ validation.rs            # ValidaÃ§Ãµes genÃ©ricas
    â”‚
    â”œâ”€â”€ config/                              # ğŸ“ ConfiguraÃ§Ãµes externas
    â”‚   â”œâ”€â”€ development.yaml                 # Config para ambiente dev
    â”‚   â”œâ”€â”€ production.yaml                  # Config para ambiente prod
    â”‚   â””â”€â”€ risk_profiles/                   # Perfis de risco
    â”‚       â”œâ”€â”€ conservative.yaml            # Perfil conservador
    â”‚       â”œâ”€â”€ moderate.yaml                # Perfil moderado
    â”‚       â””â”€â”€ aggressive.yaml              # Perfil agressivo
    â”‚
    â”œâ”€â”€ migrations/                          # ğŸ“Š MigraÃ§Ãµes de banco (Flyway)
    â”‚   â”œâ”€â”€ V001__initial_schema.sql         # Schema inicial (orders, positions)
    â”‚   â”œâ”€â”€ V002__executions.sql             # Tabela de execuÃ§Ãµes
    â”‚   â”œâ”€â”€ V003__stops.sql                  # Tabela de stops
    â”‚   â”œâ”€â”€ V004__events.sql                 # Event Store
    â”‚   â””â”€â”€ V005__indexes.sql                # Ãndices para performance
    â”‚
    â”œâ”€â”€ docs/                                # ğŸ“š DocumentaÃ§Ã£o tÃ©cnica
    â”‚   â”œâ”€â”€ README.md                        # Ãndice de documentaÃ§Ã£o
    â”‚   â”œâ”€â”€ ARCHITECTURE.md                  # Detalhes da arquitetura hexagonal
    â”‚   â”œâ”€â”€ RISK_MANAGEMENT.md               # DocumentaÃ§Ã£o de risk management
    â”‚   â””â”€â”€ EXCHANGES.md                     # DocumentaÃ§Ã£o de integraÃ§Ã£o com exchanges
    â”‚
    â”œâ”€â”€ Cargo.toml                           # ConfiguraÃ§Ã£o Rust (deps, features)
    â”œâ”€â”€ Cargo.lock                           # Lock file de dependÃªncias
    â”œâ”€â”€ Dockerfile                           # Build multi-stage production
    â”œâ”€â”€ docker-compose.yml                   # Stack completa (app, Kafka, Postgres)
    â”œâ”€â”€ Makefile                             # Comandos make (build, test, docker)
    â”œâ”€â”€ crypto-trader_projectmap.yaml        # Este arquivo (documentaÃ§Ã£o estruturada)
    â””â”€â”€ README.md                            # DocumentaÃ§Ã£o principal do projeto
    
  conventions:
    domain_layer:
      description: Camada de DomÃ­nio (domain/)
      rules:
        - âœ… Sem dependÃªncias de infraestrutura
        - âœ… LÃ³gica de negÃ³cio pura (validaÃ§Ãµes, cÃ¡lculos)
        - âœ… Aggregates aplicam eventos e validam invariantes
        - âœ… Value objects imutÃ¡veis com validaÃ§Ã£o
        - âœ… Services de domÃ­nio para lÃ³gica cross-aggregate
        - âœ… Repositories como traits (contratos apenas)
        
    application_layer:
      description: Camada de AplicaÃ§Ã£o (application/)
      rules:
        - âœ… Define Ports (interfaces) que infraestrutura implementa
        - âœ… Orquestra casos de uso (signal â†’ validate â†’ execute)
        - âœ… DTOs para comunicaÃ§Ã£o entre camadas
        - âœ… Queries para read-side (CQRS)
        - âœ… Services orquestram mÃºltiplos agregados/ports
        - âœ… NÃ£o conhece detalhes de implementaÃ§Ã£o (Binance, Kafka, etc)
        
    infrastructure_layer:
      description: Camada de Infraestrutura (infrastructure/)
      rules:
        - âœ… Implementa Adapters (Binance, Kafka, Postgres)
        - âœ… Bootstrap e configuraÃ§Ã£o
        - âœ… Messaging e streaming
        - âœ… Persistence (Postgres + Event Store)
        - âœ… Shutdown graceful
        - âœ… Startup e health checks
        - âœ… Retry e error handling
        
    presentation_layer:
      description: Camada de ApresentaÃ§Ã£o (presentation/)
      rules:
        - âœ… HTTP REST API (Axum)
        - âœ… Controllers e routers
        - âœ… ConversÃ£o DTOs <-> JSON
        - âœ… Middlewares (logging, auth futuro)
        - âœ… NÃ£o contÃ©m lÃ³gica de negÃ³cio
        - âœ… Apenas coordena chamadas Ã  Application
        
    shared_kernel:
      description: Shared Kernel (shared/)
      rules:
        - âœ… CÃ³digo compartilhado entre camadas
        - âœ… Traits comuns (AggregateRoot)
        - âœ… Tipos transversais (EventEnvelope)
        - âœ… UtilitÃ¡rios (datetime, decimal, validaÃ§Ã£o)
        - âœ… Erros compartilhados


# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ 5. VALIDAÃ‡ÃƒO E RISK MANAGEMENT                               â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

validation_rules:
  order_validation:
    description: ValidaÃ§Ãµes antes de executar ordem
    checks:
      - name: IdempotÃªncia
        rule: Verifica se ordem com mesmo client_order_id jÃ¡ foi executada
        action: Se jÃ¡ existe, retorna resultado anterior
        
      - name: DuplicaÃ§Ã£o temporal
        rule: Verifica ordens similares nos Ãºltimos X segundos
        threshold: 5 segundos
        action: Rejeita se detectar duplicaÃ§Ã£o
        
      - name: Quantidade mÃ­nima
        rule: Verifica se quantidade >= minimum_order_size da exchange
        source: Exchange info
        
      - name: Quantidade mÃ¡xima
        rule: Verifica se quantidade <= maximum_order_size da exchange
        source: Exchange info
        
      - name: Saldo disponÃ­vel
        rule: Verifica se hÃ¡ saldo suficiente para executar ordem
        consideration: Considera ordens pendentes
        
      - name: PreÃ§o vÃ¡lido
        rule: Verifica se preÃ§o estÃ¡ dentro de tick_size
        source: Exchange info
        
  risk_validation:
    description: ValidaÃ§Ãµes de risk management
    checks:
      - name: ExposiÃ§Ã£o por asset
        rule: PosiÃ§Ã£o atual + nova ordem <= max_exposure_per_asset
        configurable: true
        default: 1000 USDT
        
      - name: ExposiÃ§Ã£o total
        rule: Soma de todas as posiÃ§Ãµes <= max_total_exposure
        configurable: true
        default: 5000 USDT
        
      - name: Drawdown mÃ¡ximo
        rule: Loss acumulado <= max_drawdown
        configurable: true
        default: -20%
        calculation: (current_balance - peak_balance) / peak_balance
        
      - name: Loss diÃ¡rio
        rule: Loss do dia <= max_daily_loss
        configurable: true
        default: -500 USDT
        reset: DiÃ¡rio Ã s 00:00 UTC
        
      - name: NÃºmero mÃ¡ximo de posiÃ§Ãµes
        rule: PosiÃ§Ãµes abertas < max_open_positions
        configurable: true
        default: 10
        
      - name: Confidence mÃ­nima
        rule: Signal confidence >= min_confidence_threshold
        configurable: true
        default: 0.7
        applies_to: Sinais externos

risk_profiles:
  conservative:
    max_exposure_per_asset: 500 USDT
    max_total_exposure: 2000 USDT
    max_drawdown: -10%
    max_daily_loss: -200 USDT
    max_open_positions: 5
    min_confidence_threshold: 0.8
    
  moderate:
    max_exposure_per_asset: 1000 USDT
    max_total_exposure: 5000 USDT
    max_drawdown: -20%
    max_daily_loss: -500 USDT
    max_open_positions: 10
    min_confidence_threshold: 0.7
    
  aggressive:
    max_exposure_per_asset: 2000 USDT
    max_total_exposure: 10000 USDT
    max_drawdown: -30%
    max_daily_loss: -1000 USDT
    max_open_positions: 15
    min_confidence_threshold: 0.6


# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ 6. TIPOS DE ORDEM E STOPS                                    â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

order_types:
  market:
    description: Ordem a mercado (execuÃ§Ã£o imediata)
    parameters:
      - symbol: required
      - side: required (BUY/SELL)
      - quantity: required
    execution: Imediata ao melhor preÃ§o disponÃ­vel
    use_case: Entrada rÃ¡pida baseada em sinal
    
  limit:
    description: Ordem limitada (preÃ§o especÃ­fico)
    parameters:
      - symbol: required
      - side: required
      - quantity: required
      - price: required
      - time_in_force: optional (GTC default)
    execution: Apenas ao preÃ§o especificado ou melhor
    use_case: Entrada com controle de preÃ§o
    
  stop_loss:
    description: Ordem de stop loss (venda automÃ¡tica)
    parameters:
      - symbol: required
      - side: SELL (para posiÃ§Ã£o LONG) ou BUY (para SHORT)
      - quantity: required
      - stop_price: required (preÃ§o de trigger)
    execution: Vira ordem MARKET quando stop_price atingido
    use_case: ProteÃ§Ã£o contra perdas
    
  stop_loss_limit:
    description: Stop loss com preÃ§o limite
    parameters:
      - symbol: required
      - side: required
      - quantity: required
      - stop_price: required
      - price: required (preÃ§o limite apÃ³s trigger)
    execution: Vira ordem LIMIT quando stop_price atingido
    use_case: Stop loss com controle de slippage
    
  take_profit:
    description: Ordem de take profit (realizaÃ§Ã£o de lucro)
    parameters:
      - symbol: required
      - side: SELL (para LONG) ou BUY (para SHORT)
      - quantity: required
      - stop_price: required (preÃ§o de trigger)
    execution: Vira ordem MARKET quando stop_price atingido
    use_case: RealizaÃ§Ã£o automÃ¡tica de lucro
    
  take_profit_limit:
    description: Take profit com preÃ§o limite
    parameters:
      - symbol: required
      - side: required
      - quantity: required
      - stop_price: required
      - price: required
    execution: Vira ordem LIMIT quando stop_price atingido
    use_case: Take profit com controle de slippage

stop_management:
  stop_loss:
    description: Gerenciamento de stop loss
    behavior:
      - Criado automaticamente apÃ³s ordem de entrada executada
      - PreÃ§o baseado em signal.stop_loss ou risk calculation
      - Monitora preÃ§o em tempo real via websocket
      - Cancela ordens relacionadas quando disparado
      - Publica evento StopLossTriggered
      
  take_profit:
    description: Gerenciamento de take profit
    behavior:
      - Criado automaticamente apÃ³s entrada
      - PreÃ§o baseado em signal.take_profit
      - Pode ser parcial (vender X% da posiÃ§Ã£o)
      - Cancela stop loss quando disparado
      
  trailing_stop:
    description: Trailing stop dinÃ¢mico
    types:
      - percentage: Ajusta stop baseado em % do preÃ§o
      - fixed: Ajusta stop mantendo distÃ¢ncia fixa
    behavior:
      - Monitora preÃ§o continuamente
      - Ajusta stop_price quando preÃ§o move a favor
      - Nunca move stop contra a posiÃ§Ã£o
      - Dispara quando preÃ§o retrai atÃ© stop_price
    example_percentage: |
      Entry: 100 USDT
      Trailing: 5%
      
      PreÃ§o sobe para 110 â†’ Stop ajusta para 104.5 (110 - 5%)
      PreÃ§o sobe para 120 â†’ Stop ajusta para 114 (120 - 5%)
      PreÃ§o cai para 114 â†’ Stop disparado (lucro de 14%)


# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ 7. FLUXOS PRINCIPAIS                                         â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

flows:
  signal_to_order:
    description: Fluxo completo de sinal atÃ© ordem executada
    steps:
      - step: 1
        component: Kafka Consumer
        action: Consome sinal do tÃ³pico signals.buy
        
      - step: 2
        component: Signal Handler
        action: Deserializa e cria SignalDTO
        
      - step: 3
        component: Order Service
        action: Cria ExecuteOrderCommand
        
      - step: 4
        component: Order Validator
        action: |
          - Verifica idempotÃªncia (client_order_id)
          - Valida quantidade (min/max)
          - Verifica duplicaÃ§Ã£o temporal
          - Valida preÃ§o e tick size
        result: OK ou ValidationError
        
      - step: 5
        component: Risk Validator
        action: |
          - Calcula exposiÃ§Ã£o atual
          - Verifica limites (per asset, total)
          - Verifica drawdown
          - Verifica loss diÃ¡rio
          - Valida confidence do sinal
        result: OK ou RiskViolationError
        
      - step: 6
        component: Position Calculator
        action: |
          - Calcula tamanho de posiÃ§Ã£o (se nÃ£o especificado)
          - Baseado em: risco %, saldo, stop loss
        
      - step: 7
        component: Order Executor
        action: |
          - Cria ordem na exchange (Binance API)
          - Retry com exponential backoff (se timeout)
          - Valida resposta
        result: Order ou ExchangeError
        
      - step: 8
        component: Order Monitor
        action: |
          - Aguarda confirmaÃ§Ã£o de execuÃ§Ã£o
          - User data stream ou polling
          - Timeout configurÃ¡vel (30s)
        
      - step: 9
        component: Stop Service
        action: |
          - Cria stop loss automÃ¡tico
          - Cria take profit (se especificado)
          - Ou configura trailing stop
        
      - step: 10
        component: Event Publisher
        action: |
          - Publica orders.events (CREATED)
          - Publica orders.events (FILLED)
        
      - step: 11
        component: Order Repository
        action: Persiste ordem e execuÃ§Ã£o no banco
        
      - step: 12
        component: Metrics
        action: |
          - Incrementa orders_executed_total
          - Registra latÃªncia
          - Atualiza exposiÃ§Ã£o

    example_trace: |
      [Consumer] Received signal: BUY BTCUSDT @ 45000
      [Handler] Signal parsed: strategy=RSI_DIVERGENCE, confidence=0.85
      [OrderValidator] Validation OK (no duplicate, valid quantity)
      [RiskValidator] Risk OK (exposure: 450/1000, drawdown: -5%/-20%)
      [PositionCalculator] Position size: 0.01 BTC (1% risk, stop @ 44000)
      [OrderExecutor] Binance API: createOrder(BTCUSDT, BUY, 0.01, MARKET)
      [Exchange] Response: orderId=12345, status=FILLED, avgPrice=45023.50
      [StopService] Created stop loss @ 44000 (orderId=12346)
      [Publisher] Published: orders.events (FILLED)
      [Repository] Persisted order and execution
      [Metrics] orders_executed_total{symbol="BTCUSDT",side="BUY"} +1

  stop_loss_trigger:
    description: Fluxo de disparo de stop loss
    steps:
      - step: 1
        component: Price Monitor
        action: Monitora preÃ§o via websocket (crypto-listener.prices)
        
      - step: 2
        component: Stop Loss Manager
        action: |
          - Compara preÃ§o atual com stop_price
          - BTC @ 43950, stop @ 44000 â†’ TRIGGER
          
      - step: 3
        component: Order Executor
        action: |
          - Cancela take profit (se existir)
          - Executa venda a mercado
          
      - step: 4
        component: Position Service
        action: |
          - Atualiza posiÃ§Ã£o (fechada)
          - Calcula P&L final
          
      - step: 5
        component: Event Publisher
        action: |
          - Publica orders.events (STOP_TRIGGERED)
          - Publica orders.events (FILLED)
          
      - step: 6
        component: Metrics
        action: |
          - stop_losses_triggered_total +1
          - Atualiza drawdown

  trailing_stop_adjustment:
    description: Fluxo de ajuste de trailing stop
    steps:
      - step: 1
        component: Price Monitor
        action: PreÃ§o atualizado (BTC @ 46500)
        
      - step: 2
        component: Trailing Stop Manager
        action: |
          - Entry: 45000, Trailing: 5%
          - Novo stop: 46500 * 0.95 = 44175
          - Stop anterior: 42750
          - 44175 > 42750 â†’ AJUSTAR
          
      - step: 3
        component: Order Executor
        action: |
          - Cancela stop antigo
          - Cria novo stop @ 44175
          
      - step: 4
        component: Event Publisher
        action: Publica stop_events (TRAILING_STOP_ADJUSTED)
        
      - step: 5
        component: Metrics
        action: trailing_stop_adjustments_total +1

  order_rejection:
    description: Fluxo de rejeiÃ§Ã£o de ordem
    reasons:
      - Validation failure
      - Risk violation
      - Exchange error
      - Insufficient balance
    steps:
      - step: 1-5
        action: Fluxo normal atÃ© validaÃ§Ã£o
        
      - step: 6
        component: Validator
        action: Detecta violaÃ§Ã£o
        error: RiskViolationError (max_exposure_per_asset exceeded)
        
      - step: 7
        component: Order Service
        action: Cria OrderRejected event
        
      - step: 8
        component: Event Publisher
        action: Publica orders.events (REJECTED)
        
      - step: 9
        component: Metrics
        action: orders_rejected_total{reason="risk_violation"} +1


# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ 8. CONFIGURAÃ‡ÃƒO                                              â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

configuration:
  format: YAML + Environment Variables
  precedence: ENV > config file > defaults
  
  files:
    development: config/development.yaml
    production: config/production.yaml
    risk_profiles: config/risk_profiles/*.yaml
    
  structure:
    mode:
      env: TRADING_MODE
      values: [PAPER, LIVE, DRY_RUN]
      default: PAPER
      description: |
        PAPER: simula execuÃ§Ãµes (nÃ£o envia para exchange)
        LIVE: executa ordens reais
        DRY_RUN: valida mas nÃ£o executa
        
    kafka:
      brokers:
        env: KAFKA_BROKERS
        default: "localhost:9092"
      consumer_group:
        env: KAFKA_CONSUMER_GROUP
        default: "crypto-trader-group"
      topics:
        signals_buy: "signals.buy"
        signals_sell: "signals.sell"
        orders_events: "orders.events"
        
    exchange:
      name:
        env: EXCHANGE_NAME
        default: "binance"
        values: [binance, paper]
      api_key:
        env: EXCHANGE_API_KEY
        required_if: mode == LIVE
      api_secret:
        env: EXCHANGE_API_SECRET
        required_if: mode == LIVE
      testnet:
        env: EXCHANGE_TESTNET
        default: false
      timeout_ms:
        env: EXCHANGE_TIMEOUT_MS
        default: 5000
        
    risk:
      profile:
        env: RISK_PROFILE
        default: "moderate"
        values: [conservative, moderate, aggressive, custom]
      max_exposure_per_asset:
        env: RISK_MAX_EXPOSURE_PER_ASSET
        default: 1000.00
        unit: USDT
      max_total_exposure:
        env: RISK_MAX_TOTAL_EXPOSURE
        default: 5000.00
        unit: USDT
      max_drawdown:
        env: RISK_MAX_DRAWDOWN
        default: -0.20
        unit: percentage
      max_daily_loss:
        env: RISK_MAX_DAILY_LOSS
        default: 500.00
        unit: USDT
      max_open_positions:
        env: RISK_MAX_OPEN_POSITIONS
        default: 10
      min_confidence_threshold:
        env: RISK_MIN_CONFIDENCE
        default: 0.7
        
    stops:
      auto_stop_loss:
        env: STOPS_AUTO_STOP_LOSS
        default: true
        description: Criar stop loss automaticamente
      default_stop_loss_percent:
        env: STOPS_DEFAULT_STOP_LOSS_PERCENT
        default: 0.02
        description: 2% abaixo do preÃ§o de entrada
      auto_take_profit:
        env: STOPS_AUTO_TAKE_PROFIT
        default: false
      default_take_profit_percent:
        env: STOPS_DEFAULT_TAKE_PROFIT_PERCENT
        default: 0.05
      enable_trailing_stop:
        env: STOPS_ENABLE_TRAILING
        default: false
      trailing_stop_percent:
        env: STOPS_TRAILING_PERCENT
        default: 0.05
        
    execution:
      order_timeout_seconds:
        env: EXECUTION_ORDER_TIMEOUT
        default: 30
      retry_max_attempts:
        env: EXECUTION_RETRY_MAX_ATTEMPTS
        default: 3
      retry_initial_delay_ms:
        env: EXECUTION_RETRY_INITIAL_DELAY
        default: 1000
        
    database:
      url:
        env: DATABASE_URL
        required: true
      pool_size:
        env: DATABASE_POOL_SIZE
        default: 10
        
    metrics:
      enabled:
        env: METRICS_ENABLED
        default: true
      port:
        env: METRICS_PORT
        default: 9090


# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ 9. MÃ‰TRICAS E OBSERVABILIDADE                                â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

metrics:
  prometheus_endpoint: /metrics
  port: 9090
  
  counters:
    - name: signals_received_total
      help: Total de sinais recebidos
      labels: [symbol, side, strategy, source]
      
    - name: orders_executed_total
      help: Total de ordens executadas com sucesso
      labels: [symbol, side, order_type, strategy]
      
    - name: orders_rejected_total
      help: Total de ordens rejeitadas
      labels: [symbol, reason]
      
    - name: stop_losses_triggered_total
      help: Total de stop losses disparados
      labels: [symbol]
      
    - name: take_profits_triggered_total
      help: Total de take profits disparados
      labels: [symbol]
      
    - name: trailing_stop_adjustments_total
      help: Total de ajustes de trailing stop
      labels: [symbol]
      
    - name: positions_opened_total
      help: Total de posiÃ§Ãµes abertas
      labels: [symbol, side]
      
    - name: positions_closed_total
      help: Total de posiÃ§Ãµes fechadas
      labels: [symbol, reason]
      
  histograms:
    - name: order_execution_duration_seconds
      help: DuraÃ§Ã£o da execuÃ§Ã£o de ordem
      labels: [symbol, order_type]
      buckets: [0.1, 0.5, 1.0, 2.0, 5.0, 10.0]
      
    - name: signal_to_execution_duration_seconds
      help: DuraÃ§Ã£o total (receber sinal atÃ© executar)
      labels: [symbol]
      buckets: [0.5, 1.0, 2.0, 5.0, 10.0, 30.0]
      
    - name: pnl_per_trade
      help: P&L por trade
      labels: [symbol, strategy]
      buckets: [-1000, -500, -100, 0, 100, 500, 1000, 5000]
      
  gauges:
    - name: active_positions
      help: NÃºmero de posiÃ§Ãµes abertas
      labels: [symbol]
      
    - name: total_exposure
      help: ExposiÃ§Ã£o total em USDT
      labels: []
      
    - name: current_drawdown
      help: Drawdown atual
      labels: []
      
    - name: daily_pnl
      help: P&L do dia atual
      labels: []
      
    - name: account_balance
      help: Saldo da conta
      labels: [asset]

  logging:
    format: JSON (structured logging)
    level: INFO (configurÃ¡vel via env)
    fields:
      - timestamp
      - level
      - message
      - symbol
      - order_id
      - signal_id
      - strategy
      - duration_ms
      - error (if any)

  tracing:
    enabled: true
    library: tracing / tracing-subscriber
    spans:
      - name: process_signal
        fields: [signal_id, symbol, strategy]
      - name: validate_order
        fields: [order_id, validations]
      - name: execute_order
        fields: [order_id, symbol, side]
      - name: monitor_stop
        fields: [stop_id, symbol, stop_price]


# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ 10. INSTRUÃ‡Ã•ES DE DESENVOLVIMENTO                            â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

development_instructions:
  setup:
    prerequisites:
      - Rust 1.75+ (rustup)
      - Docker & Docker Compose
      - Postgres client (psql)
      - Kafka client (kafkacat/kcat)
      - Binance testnet account (para testes)
      
    steps:
      - step: 1
        action: Clone o repositÃ³rio
        command: git clone <repo-url> && cd crypto-trader
        
      - step: 2
        action: Copie o arquivo de configuraÃ§Ã£o
        command: cp .env.example .env
        
      - step: 3
        action: Configure as variÃ¡veis de ambiente
        details: |
          Edite .env e configure:
          - TRADING_MODE=PAPER (comeÃ§ar com paper trading)
          - EXCHANGE_API_KEY (se usar testnet/live)
          - EXCHANGE_API_SECRET (se usar testnet/live)
          - DATABASE_URL
          - KAFKA_BROKERS
          
      - step: 4
        action: Inicie dependÃªncias
        command: docker-compose up -d kafka postgres
        
      - step: 5
        action: Execute migrations
        command: cargo run --bin migrate
        
      - step: 6
        action: Instale dependÃªncias Rust
        command: cargo build
        
      - step: 7
        action: Execute o serviÃ§o
        command: cargo run
        
  testing_orders:
    manual_signal:
      description: Publicar sinal de teste no Kafka
      command: |
        echo '{
          "symbol": "BTCUSDT",
          "strategy": "MANUAL_TEST",
          "source": "internal",
          "confidence": 0.9,
          "target_price": 45000.00,
          "stop_loss": 44000.00,
          "take_profit": 47000.00,
          "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"
        }' | kcat -P -b localhost:9092 -t signals.buy
        
    check_execution:
      description: Verificar ordem executada
      command: |
        # Via API
        curl http://localhost:8080/api/orders/recent
        
        # Via banco
        psql $DATABASE_URL -c "SELECT * FROM orders ORDER BY created_at DESC LIMIT 5;"
        
    monitor_positions:
      description: Monitorar posiÃ§Ãµes abertas
      command: |
        curl http://localhost:8080/api/positions/active
        
  debugging:
    logs:
      command: RUST_LOG=debug cargo run
      
    dry_run_mode:
      description: Validar sem executar
      command: TRADING_MODE=DRY_RUN cargo run
      
    kafka_monitoring:
      consumer_lag: |
        kafka-consumer-groups.sh --bootstrap-server localhost:9092 \
          --group crypto-trader-group --describe
          
      consume_signals: |
        kcat -C -b localhost:9092 -t signals.buy
        
      consume_orders: |
        kcat -C -b localhost:9092 -t orders.events
        
    database_queries:
      active_orders: |
        SELECT * FROM orders WHERE status IN ('NEW', 'PARTIALLY_FILLED');
        
      active_positions: |
        SELECT * FROM positions WHERE status = 'OPEN';
        
      daily_pnl: |
        SELECT SUM(pnl) FROM executions 
        WHERE DATE(created_at) = CURRENT_DATE;


# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ 11. TROUBLESHOOTING                                          â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

troubleshooting:
  common_issues:
    - issue: "Ordens nÃ£o sendo executadas"
      causes:
        - TRADING_MODE nÃ£o configurado para LIVE
        - API keys invÃ¡lidas
        - ValidaÃ§Ã£o de risco falhando
        - Saldo insuficiente
      solutions:
        - Verificar TRADING_MODE: echo $TRADING_MODE
        - Testar API keys: cargo run --bin test-exchange-connection
        - Verificar logs de validaÃ§Ã£o: RUST_LOG=debug
        - Verificar mÃ©tricas de rejeiÃ§Ã£o: curl localhost:9090/metrics | grep rejected
        
    - issue: "Orders rejeitadas por risk violation"
      causes:
        - ExposiÃ§Ã£o mÃ¡xima atingida
        - Drawdown mÃ¡ximo atingido
        - Loss diÃ¡rio excedido
      solutions:
        - Verificar exposiÃ§Ã£o atual: curl localhost:8080/api/risk/status
        - Ajustar limites: editar config/production.yaml
        - Resetar daily loss (novo dia)
        
    - issue: "Stop loss nÃ£o disparando"
      causes:
        - Price monitor nÃ£o conectado
        - crypto-listener nÃ£o publicando preÃ§os
        - WebSocket desconectado
      solutions:
        - Verificar health: curl localhost:8080/health
        - Verificar tÃ³pico de preÃ§os: kcat -C -b localhost:9092 -t crypto-listener.prices
        - Verificar logs do price monitor
        
    - issue: "LatÃªncia alta (signal â†’ execution)"
      causes:
        - Kafka lag
        - ValidaÃ§Ãµes lentas
        - Exchange API lenta
      solutions:
        - Verificar consumer lag
        - Verificar mÃ©tricas: signal_to_execution_duration_seconds
        - Otimizar validaÃ§Ãµes (cache)
        - Aumentar timeout se necessÃ¡rio
        
  health_checks:
    service_health:
      endpoint: GET /health
      expected_response: |
        {
          "status": "healthy",
          "version": "1.0.0",
          "mode": "LIVE",
          "components": {
            "kafka_consumer": "connected",
            "exchange": "connected",
            "database": "connected",
            "price_monitor": "active"
          },
          "risk_status": {
            "total_exposure": 2500.00,
            "max_total_exposure": 5000.00,
            "current_drawdown": -0.05,
            "max_drawdown": -0.20,
            "daily_pnl": 150.00
          }
        }


# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ 12. ROADMAP & MELHORIAS FUTURAS                              â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

roadmap:
  v1_0:
    status: Current
    features:
      - âœ… ExecuÃ§Ã£o de ordens baseada em sinais
      - âœ… ValidaÃ§Ã£o de risco
      - âœ… Stop loss automÃ¡tico
      - âœ… Take profit
      - âœ… Trailing stops
      - âœ… Paper trading
      - âœ… Binance integration
      
  v1_1:
    planned_features:
      - Partial take profit (vender X% da posiÃ§Ã£o)
      - OCO orders (One-Cancels-the-Other)
      - Grid trading support
      - Average down / scale in
      - Backtesting framework
      
  v2_0:
    planned_features:
      - Multi-exchange support (Bybit, OKX)
      - Advanced order types (Iceberg, TWAP)
      - Portfolio rebalancing automÃ¡tico
      - Tax reporting
      - AI-powered position sizing
      - Sentiment-based adjustments
      
  future_considerations:
    - Futures e margin trading
    - Options trading
    - Copy trading (seguir outros traders)
    - Social trading features
    - Mobile app para monitoramento
    - Alerts via SMS/Push


# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ 13. REFERÃŠNCIAS E DOCUMENTAÃ‡ÃƒO                               â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

references:
  exchange_apis:
    binance:
      - name: Binance Spot API
        url: https://binance-docs.github.io/apidocs/spot/en/
      - name: Binance Testnet
        url: https://testnet.binance.vision/
        
  rust_libraries:
    - name: binance-rs
      url: https://docs.rs/binance
      
    - name: rust-decimal
      url: https://docs.rs/rust_decimal
      description: Para cÃ¡lculos precisos de preÃ§os
      
    - name: tokio
      url: https://tokio.rs
      
    - name: rdkafka
      url: https://docs.rs/rdkafka
      
  trading_concepts:
    - Stop Loss
    - Take Profit
    - Trailing Stop
    - Position Sizing
    - Risk Management
    - Order Types (Market, Limit, Stop)
    - Time In Force (GTC, IOC, FOK)
    
  architecture_patterns:
    - Event-Driven Architecture
    - Hexagonal Architecture (Ports & Adapters)
    - Domain-Driven Design (DDD)
    - Event Sourcing
    - CQRS (Command Query Responsibility Segregation)
    - Retry Pattern
    - Circuit Breaker Pattern


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# FIM DO PROJECT MAP
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
